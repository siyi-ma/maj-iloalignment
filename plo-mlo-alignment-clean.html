<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLO-MLO Alignment Analysis</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Additional styles specific to PLO-MLO analysis */
        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 12px;
        }
        
        .matrix-table th, .matrix-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        
        .matrix-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .module-header {
            background-color: #342b60 !important;
            color: white !important;
        }
        
        .mlo-header {
            background-color: #6c7b7f !important;
            color: white !important;
        }
        
        .plo-header {
            background-color: #f8f9fa;
            font-weight: bold;
            text-align: left !important;
        }
        
        .score-cell {
            cursor: pointer;
            font-weight: bold;
        }
        
        .score-1 { background-color: #ffcdd2; }
        .score-2 { background-color: #ffecb3; }
        .score-3 { background-color: #fff9c4; }
        .score-4 { background-color: #c8e6c9; }
        .score-5 { background-color: #a5d6a7; }
        
        .outcome-item {
            margin-bottom: 15px;
            padding: 15px;
            border-left: 3px solid #342b60;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .module-section {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 20px;
        }
        
        .module-section h3 {
            color: #342b60;
            border-bottom: 2px solid #342b60;
            padding-bottom: 10px;
        }
        
        .analysis-summary {
            margin-bottom: 30px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .summary-card {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            color: white;
        }
        
        .card-score {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .plo-analysis-section {
            margin-bottom: 40px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }
        
        .plo-header-section h3 {
            color: #342b60;
            margin-bottom: 10px;
        }
        
        .plo-text {
            font-style: italic;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .module-alignment {
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .module-average-score {
            padding: 5px 10px;
            border-radius: 15px;
            color: white;
            font-weight: bold;
        }
        
        .mlo-alignment {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .mlo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .alignment-score {
            padding: 3px 8px;
            border-radius: 10px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .alignment-justification {
            font-size: 14px;
            color: #666;
            font-style: italic;
        }
        
        .export-btn {
            background-color: #342b60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        
        .export-btn:hover {
            background-color: #2a1f4f;
        }
        
        .matrix-actions {
            margin-bottom: 20px;
        }
        
        .alignment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .close-modal:hover {
            color: #000;
        }
        
        .score-badge {
            padding: 5px 10px;
            border-radius: 15px;
            color: white;
            font-weight: bold;
        }
        
        .input-container {
            margin: 20px 0;
        }
        
        .input-container select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-graduation-cap"></i> PLO-MLO Learning Outcome Alignment</h1>
            <p>Programme and Module Learning Outcomes Alignment Tool</p>
        </header>

        <main>
            <section id="overview">
                <h2><i class="fas fa-info-circle"></i> Overview</h2>
                <p>Loading programme analysis...</p>
                <ul>
                    <li><strong>5 - Excellent:</strong> Highly complementary objectives with strong conceptual overlap</li>
                    <li><strong>4 - Strong:</strong> Significant conceptual overlap and clear connections</li>
                    <li><strong>3 - Moderate:</strong> Clear thematic connections with reasonable alignment</li>
                    <li><strong>2 - Low:</strong> Some conceptual overlap but limited direct connection</li>
                    <li><strong>1 - Minimal:</strong> Concepts may be indirectly related with little overlap</li>
                </ul>
            </section>

            <section id="plo-section">
                <h2><i class="fas fa-graduation-cap"></i> Programme Learning Outcomes (PLOs)</h2>
                <div id="plo-container">
                    <!-- PLOs will be populated here by JavaScript -->
                    <p>Loading PLOs...</p>
                </div>
            </section>

            <section id="mlo-section">
                <h2><i class="fas fa-book"></i> Module Learning Outcomes (MLOs)</h2>
                <div id="mlo-container">
                    <!-- MLOs will be populated here by JavaScript -->
                    <p>Loading MLOs...</p>
                </div>
            </section>

            <section id="matrix-section">
                <h2><i class="fas fa-table"></i> Alignment Matrix</h2>
                <p>This matrix shows the alignment scores between all PLOs and MLO categories. Hover over a cell to see the alignment justification. Click any cell to navigate to the detailed analysis.</p>
                <div class="matrix-actions">
                    <button id="export-excel-btn" class="export-btn"><i class="fas fa-file-excel"></i> Export Matrix to Excel</button>
                </div>
                <div id="matrix-container">
                    <!-- Alignment matrix will be generated here by JavaScript -->
                    <p>Loading alignment matrix...</p>
                </div>
            </section>
            
            <section id="detailed-analysis">
                <h2><i class="fas fa-chart-bar"></i> Detailed Breakdown</h2>
                <div id="analysis-header" class="analysis-header">
                    <p>Below is a detailed breakdown of alignment between Programme Learning Outcomes and Module Learning Outcomes.</p>
                </div>
                <div id="detailed-container">
                    <!-- Detailed breakdown will be generated here by JavaScript -->
                    <p>Loading detailed analysis...</p>
                </div>
            </section>

            <div class="input-container">
                <label for="programme-select-plo-mlo"><strong>Programme:</strong></label>
                <select id="programme-select-plo-mlo">
                    <option value="tvtb">Rahvusvaheline ärikorraldus (TVTB)</option>
                    <option value="majb">Jätkusuutlik ettevõtlus ja ringmajandus (MAJB)</option>
                    <option value="makm">Kestlikkuse juhtimine (MAKM)</option>
                </select>
            </div>
        </main>
        
        <div class="report-footer-actions">
            <button id="export-plo-mlo-btn" class="export-btn"><i class="fas fa-file-export"></i> Export Report</button>
        </div>
    </div>

    <script>
        // Get the programme parameter from URL
        function getURLParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Get selected programme from URL parameter or default to 'tvtb'
        const selectedProgramme = getURLParameter('programme') || 'tvtb';
        console.log("=== INITIAL SETUP ===");
        console.log("Selected programme from URL:", selectedProgramme);

        document.addEventListener('DOMContentLoaded', function() {
            console.log("=== DOM CONTENT LOADED ===");

            // Load the data from the JSON file
            async function loadProgrammeData(programmeCode = 'tvtb') {
                console.log("=== LOADING PROGRAMME DATA ===");
                console.log("Programme code:", programmeCode);
                try {
                    const response = await fetch('data/programmes.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log("Data loaded successfully");
                    
                    // Check if the programme exists in the data
                    if (data[programmeCode]) {
                        console.log("Programme data found for:", programmeCode);
                        const programmeData = data[programmeCode];
                        console.log("Programme name:", programmeData.kavanimetusik || programmeData.kavanimetusek);
                        
                        // Update page title and header with programme name
                        document.title = `${programmeData.kavanimetusik || programmeData.kavanimetusek} - Learning Outcome Alignment`;
                        
                        // Update header content
                        const headerTitle = document.querySelector('header h1');
                        if (headerTitle) {
                            headerTitle.innerHTML = `<i class="fas fa-graduation-cap"></i> ${programmeData.kavanimetusik || programmeData.kavanimetusek} Learning Outcome Alignment`;
                            console.log("Header title updated");
                        }
                        
                        // Update subtitle
                        const headerSubtitle = document.querySelector('header p');
                        if (headerSubtitle) {
                            headerSubtitle.textContent = `Programme and Module Learning Outcomes Alignment Tool`;
                            console.log("Header subtitle updated");
                        }
                        
                        // Update overview section to be dynamic
                        const overviewText = document.querySelector('#overview > p');
                        if (overviewText) {
                            overviewText.textContent = `This analysis examines how well the Module Learning Outcomes (MLOs) align with the Programme Learning Outcomes (PLOs) for the ${programmeData.kavanimetusik || programmeData.kavanimetusek} (${programmeCode.toUpperCase()}). The alignment is scored on a scale from 1 to 5:`;
                            console.log("Overview text updated");
                        } else {
                            console.error("Overview text element not found");
                        }

                        // Get PLOs and MLOs
                        const plos = programmeData.plos || [];
                        const mlos = programmeData.mlos || [];
                        
                        console.log("PLOs count:", plos.length);
                        console.log("MLOs count:", mlos.length);
                        
                        if (plos.length > 0 && mlos.length > 0) {
                            // Group MLOs by category
                            const moduleGroups = groupMLOsByCategory(mlos);
                            console.log("Module groups:", Object.keys(moduleGroups));
                            
                            // Update the UI with the new data
                            displayPLOs(plos);
                            displayMLOsByCategory(moduleGroups);
                            
                            // Generate alignment analysis
                            const alignmentResults = analyzeAlignment(plos, moduleGroups);
                            
                            // Display alignment matrix
                            displayAlignmentMatrix(plos, moduleGroups, alignmentResults);
                            
                            // Display detailed analysis
                            displayDetailedAnalysis(plos, moduleGroups, alignmentResults);
                            
                            console.log("=== ANALYSIS COMPLETE ===");
                        } else {
                            console.error(`No MLOs found for programme code ${programmeCode}`);
                        }
                    } else {
                        console.error(`Programme code ${programmeCode} not found in the data`);
                    }
                } catch (error) {
                    console.error("Error loading programme data:", error);
                }
            }

            // Function to display PLOs
            function displayPLOs(plos) {
                console.log("Displaying PLOs:", plos.length);
                const ploContainer = document.getElementById('plo-container');
                
                if (!ploContainer) {
                    console.error("PLO container element not found");
                    return;
                }
                
                ploContainer.innerHTML = ''; // Clear existing content
                
                plos.forEach((plo, index) => {
                    const ploItem = document.createElement('div');
                    ploItem.className = 'outcome-item';
                    ploItem.innerHTML = `
                        <h3>PLO ${index + 1}</h3>
                        <p>${plo.ilosisu}</p>
                    `;
                    ploContainer.appendChild(ploItem);
                });
            }

            // Function to display Module Learning Outcomes by category
            function displayMLOsByCategory(moduleGroups) {
                console.log("Displaying MLOs by category");
                const mloContainer = document.getElementById('mlo-container');
                
                if (!mloContainer) {
                    console.error("MLO container element not found");
                    return;
                }
                
                mloContainer.innerHTML = ''; // Clear existing content
                
                // Define module order and names for display
                const moduleOrder = ['ylmlo', 'p1mlo', 'p2mlo', 'e1mlo', 'e2mlo', 'gdmlo'];
                const moduleNames = {
                    'ylmlo': 'General Studies Module - Foundational Competences',
                    'p1mlo': 'Core Studies Module - P1 Methods, Markets and Economy',
                    'p2mlo': 'Core Studies Module - P2 Core Business Competences',
                    'e1mlo': 'Special Studies Module - E1 Entrepreneurship and Marketing',
                    'e2mlo': 'Special Studies Module - E2 Finance and Accounting',
                    'gdmlo': 'Graduation Thesis Module - Research and Thesis'
                };
                
                moduleOrder.forEach(moduleType => {
                    if (moduleGroups[moduleType] && moduleGroups[moduleType].length > 0) {
                        const moduleSection = document.createElement('div');
                        moduleSection.className = 'module-section';
                        moduleSection.innerHTML = `
                            <h3>${moduleNames[moduleType]}</h3>
                            <div class="module-mlos">
                                ${moduleGroups[moduleType].map((mlo, index) => `
                                    <div class="outcome-item">
                                        <strong>MLO ${index + 1}:</strong>
                                        <p>${mlo.ilosisu}</p>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        mloContainer.appendChild(moduleSection);
                    }
                });
            }

            // Function to group MLOs by category
            function groupMLOsByCategory(mlos) {
                const groups = {
                    ylmlo: [],
                    p1mlo: [],
                    p2mlo: [],
                    e1mlo: [],
                    e2mlo: [],
                    gdmlo: []
                };
                
                mlos.forEach(mlo => {
                    const category = mlo.kategooria;
                    if (groups.hasOwnProperty(category)) {
                        groups[category].push(mlo);
                    }
                });
                
                return groups;
            }

            // Function to analyze alignment between PLOs and MLOs
            function analyzeAlignment(plos, moduleGroups) {
                const alignmentResults = [];
                
                plos.forEach((plo, ploIndex) => {
                    const ploAlignment = {
                        ploIndex: ploIndex,
                        ploText: plo.ilosisu,
                        moduleAlignments: {}
                    };
                    
                    // Analyze alignment with each module
                    Object.keys(moduleGroups).forEach(moduleType => {
                        const mlos = moduleGroups[moduleType];
                        const moduleAlignment = {
                            scores: [],
                            details: [],
                            averageScore: 0
                        };
                        
                        mlos.forEach((mlo, mloIndex) => {
                            const score = calculateAlignmentScore(plo.ilosisu, mlo.ilosisu, moduleType);
                            const justification = generateAlignmentJustification(plo.ilosisu, mlo.ilosisu, score, moduleType);
                            
                            moduleAlignment.scores.push(score);
                            moduleAlignment.details.push({
                                mloIndex: mloIndex,
                                mloText: mlo.ilosisu,
                                score: score,
                                justification: justification
                            });
                        });
                        
                        // Calculate average score for this module
                        if (moduleAlignment.scores.length > 0) {
                            moduleAlignment.averageScore = moduleAlignment.scores.reduce((a, b) => a + b, 0) / moduleAlignment.scores.length;
                        }
                        
                        ploAlignment.moduleAlignments[moduleType] = moduleAlignment;
                    });
                    
                    alignmentResults.push(ploAlignment);
                });
                
                return alignmentResults;
            }

            // Function to calculate alignment score between a PLO and MLO
            function calculateAlignmentScore(ploText, mloText, moduleType) {
                // Simple scoring algorithm - can be made more sophisticated
                const ploLower = ploText.toLowerCase();
                const mloLower = mloText.toLowerCase();
                
                // Key concepts and their weights
                const conceptWeights = {
                    'business': 0.8, 'management': 0.8, 'leadership': 0.8,
                    'sustainability': 0.9, 'sustainable': 0.9, 'environment': 0.8,
                    'research': 0.7, 'analysis': 0.8, 'critical': 0.8,
                    'communication': 0.7, 'digital': 0.6, 'professional': 0.7
                };
                
                let conceptScore = 0;
                let conceptCount = 0;
                
                Object.keys(conceptWeights).forEach(concept => {
                    if (ploLower.includes(concept) && mloLower.includes(concept)) {
                        conceptScore += conceptWeights[concept];
                        conceptCount++;
                    }
                });
                
                // Word overlap ratio
                const ploWords = ploLower.match(/\b\w{4,}\b/g) || [];
                const mloWords = mloLower.match(/\b\w{4,}\b/g) || [];
                const commonWords = ploWords.filter(word => mloWords.includes(word));
                const wordOverlapRatio = commonWords.length / Math.max(ploWords.length, mloWords.length, 1);
                
                // Calculate final score
                let baseScore = 0;
                if (conceptCount > 0) {
                    baseScore = (conceptScore / conceptCount) * 0.7 + wordOverlapRatio * 0.3;
                } else {
                    baseScore = wordOverlapRatio;
                }
                
                // Scale to 1-5 range and round
                return Math.max(1, Math.min(5, Math.round(baseScore * 5)));
            }

            // Function to generate alignment justification
            function generateAlignmentJustification(ploText, mloText, score, moduleType) {
                const moduleNames = {
                    'ylmlo': 'General Studies',
                    'p1mlo': 'Methods, Markets and Economy',
                    'p2mlo': 'Core Business Competences',
                    'e1mlo': 'Entrepreneurship and Marketing',
                    'e2mlo': 'Finance and Accounting',
                    'gdmlo': 'Graduation Thesis'
                };
                
                const scoreMeanings = {
                    1: "Minimal alignment - concepts may be indirectly related",
                    2: "Low alignment - some conceptual overlap exists", 
                    3: "Moderate alignment - clear thematic connections",
                    4: "Strong alignment - significant conceptual overlap",
                    5: "Excellent alignment - highly complementary objectives"
                };
                
                return `${scoreMeanings[score]} between this PLO and the ${moduleNames[moduleType]} MLO.`;
            }

            // Function to display the alignment matrix
            function displayAlignmentMatrix(plos, moduleGroups, alignmentResults) {
                const matrixContainer = document.getElementById('matrix-container');
                matrixContainer.innerHTML = ''; // Clear existing content
                
                // Create matrix table
                const table = document.createElement('table');
                table.className = 'matrix-table';
                
                // Create header
                const thead = document.createElement('thead');
                
                // First header row - Module categories
                const moduleHeaderRow = document.createElement('tr');
                moduleHeaderRow.innerHTML = '<th rowspan="2">PLO</th>';
                
                const moduleOrder = ['ylmlo', 'p1mlo', 'p2mlo', 'e1mlo', 'e2mlo', 'gdmlo'];
                const moduleNames = {
                    'ylmlo': 'General Studies',
                    'p1mlo': 'P1: Methods & Economy',
                    'p2mlo': 'P2: Business Competences',
                    'e1mlo': 'E1: Entrepreneurship',
                    'e2mlo': 'E2: Finance',
                    'gdmlo': 'Graduation Thesis'
                };
                
                moduleOrder.forEach(moduleType => {
                    if (moduleGroups[moduleType] && moduleGroups[moduleType].length > 0) {
                        const th = document.createElement('th');
                        th.colSpan = moduleGroups[moduleType].length;
                        th.textContent = moduleNames[moduleType];
                        th.className = 'module-header';
                        moduleHeaderRow.appendChild(th);
                    }
                });
                
                // Second header row - MLO numbers
                const mloHeaderRow = document.createElement('tr');
                moduleOrder.forEach(moduleType => {
                    if (moduleGroups[moduleType] && moduleGroups[moduleType].length > 0) {
                        moduleGroups[moduleType].forEach((mlo, index) => {
                            const th = document.createElement('th');
                            th.textContent = `MLO ${index + 1}`;
                            th.className = 'mlo-header';
                            mloHeaderRow.appendChild(th);
                        });
                    }
                });
                
                thead.appendChild(moduleHeaderRow);
                thead.appendChild(mloHeaderRow);
                table.appendChild(thead);
                
                // Create body
                const tbody = document.createElement('tbody');
                
                alignmentResults.forEach((ploAlignment, ploIndex) => {
                    const row = document.createElement('tr');
                    
                    // PLO header cell
                    const ploCell = document.createElement('td');
                    ploCell.className = 'plo-header';
                    ploCell.innerHTML = `<strong>PLO ${ploIndex + 1}</strong>`;
                    row.appendChild(ploCell);
                    
                    // Alignment score cells
                    moduleOrder.forEach(moduleType => {
                        if (moduleGroups[moduleType] && moduleGroups[moduleType].length > 0) {
                            const moduleAlignment = ploAlignment.moduleAlignments[moduleType];
                            
                            moduleAlignment.details.forEach((detail, mloIndex) => {
                                const cell = document.createElement('td');
                                cell.className = `score-cell score-${detail.score}`;
                                cell.textContent = detail.score;
                                cell.title = detail.justification;
                                
                                row.appendChild(cell);
                            });
                        }
                    });
                    
                    tbody.appendChild(row);
                });
                
                table.appendChild(tbody);
                matrixContainer.appendChild(table);
            }

            // Function to display detailed analysis
            function displayDetailedAnalysis(plos, moduleGroups, alignmentResults) {
                const detailedContainer = document.getElementById('detailed-container');
                detailedContainer.innerHTML = ''; // Clear existing content
                
                // Create summary section
                const summarySection = document.createElement('div');
                summarySection.className = 'analysis-summary';
                summarySection.innerHTML = `
                    <h3>Alignment Summary</h3>
                    <div class="summary-cards">
                        ${generateSummaryCards(alignmentResults)}
                    </div>
                `;
                
                detailedContainer.appendChild(summarySection);
                
                // Create detailed breakdown for each PLO
                plos.forEach((plo, ploIndex) => {
                    const ploSection = document.createElement('div');
                    ploSection.className = 'plo-analysis-section';
                    ploSection.id = `plo-${ploIndex}`;
                    
                    const ploAlignment = alignmentResults[ploIndex];
                    
                    ploSection.innerHTML = `
                        <div class="plo-header-section">
                            <h3>PLO ${ploIndex + 1} Analysis</h3>
                            <p class="plo-text">${plo.ilosisu}</p>
                        </div>
                        <div class="module-alignments">
                            ${generateModuleAlignments(ploAlignment.moduleAlignments, moduleGroups)}
                        </div>
                    `;
                    
                    detailedContainer.appendChild(ploSection);
                });
            }

            // Function to generate summary cards
            function generateSummaryCards(alignmentResults) {
                const moduleOrder = ['ylmlo', 'p1mlo', 'p2mlo', 'e1mlo', 'e2mlo', 'gdmlo'];
                const moduleNames = {
                    'ylmlo': 'General Studies',
                    'p1mlo': 'Methods & Economy',
                    'p2mlo': 'Business Competences',
                    'e1mlo': 'Entrepreneurship',
                    'e2mlo': 'Finance',
                    'gdmlo': 'Graduation Thesis'
                };
                
                let cards = '';
                
                moduleOrder.forEach(moduleType => {
                    // Calculate average score for this module across all PLOs
                    let totalScore = 0;
                    let scoreCount = 0;
                    
                    alignmentResults.forEach(ploAlignment => {
                        const moduleAlignment = ploAlignment.moduleAlignments[moduleType];
                        if (moduleAlignment && moduleAlignment.scores.length > 0) {
                            totalScore += moduleAlignment.averageScore;
                            scoreCount++;
                        }
                    });
                    
                    if (scoreCount > 0) {
                        const averageScore = (totalScore / scoreCount).toFixed(1);
                        const scoreClass = Math.round(averageScore);
                        
                        cards += `
                            <div class="summary-card score-${scoreClass}">
                                <h4>${moduleNames[moduleType]}</h4>
                                <div class="card-score">${averageScore}/5</div>
                                <p class="card-description">${getScoreDescription(averageScore)}</p>
                            </div>
                        `;
                    }
                });
                
                return cards;
            }

            // Function to get score description
            function getScoreDescription(score) {
                const numScore = parseFloat(score);
                if (numScore >= 4.5) return "Excellent alignment";
                if (numScore >= 3.5) return "Strong alignment";
                if (numScore >= 2.5) return "Moderate alignment";
                if (numScore >= 1.5) return "Low alignment";
                return "Minimal alignment";
            }

            // Function to generate module alignments
            function generateModuleAlignments(moduleAlignments, moduleGroups) {
                const moduleOrder = ['ylmlo', 'p1mlo', 'p2mlo', 'e1mlo', 'e2mlo', 'gdmlo'];
                const moduleNames = {
                    'ylmlo': 'General Studies Module',
                    'p1mlo': 'Core Studies Module - P1 Methods, Markets and Economy',
                    'p2mlo': 'Core Studies Module - P2 Core Business Competences',
                    'e1mlo': 'Special Studies Module - E1 Entrepreneurship and Marketing',
                    'e2mlo': 'Special Studies Module - E2 Finance and Accounting',
                    'gdmlo': 'Graduation Thesis Module'
                };
                
                let content = '';
                
                moduleOrder.forEach(moduleType => {
                    const alignment = moduleAlignments[moduleType];
                    if (alignment && alignment.details.length > 0) {
                        const averageScore = alignment.averageScore.toFixed(1);
                        const scoreClass = Math.round(alignment.averageScore);
                        
                        content += `
                            <div class="module-alignment">
                                <div class="module-header">
                                    <h4>${moduleNames[moduleType]}</h4>
                                    <span class="module-average-score score-${scoreClass}">${averageScore}/5</span>
                                </div>
                                <div class="mlo-alignments">
                                    ${alignment.details.map((detail, index) => `
                                        <div class="mlo-alignment">
                                            <div class="mlo-header">
                                                <span class="mlo-label">MLO ${index + 1}</span>
                                                <span class="alignment-score score-${detail.score}">${detail.score}/5</span>
                                            </div>
                                            <p class="mlo-text">${detail.mloText}</p>
                                            <p class="alignment-justification">${detail.justification}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                });
                
                return content;
            }

            // Set up the programme selection dropdown
            const programmeSelect = document.getElementById('programme-select-plo-mlo');
            console.log("Programme selection dropdown:", programmeSelect);
            
            if (programmeSelect) {
                // Set the dropdown to the selected programme from URL
                programmeSelect.value = selectedProgramme;
                
                programmeSelect.addEventListener('change', function() {
                    console.log("Programme selection changed to:", this.value);
                    loadProgrammeData(this.value);
                });
                
                // Load programme data based on URL parameter
                console.log("Loading programme data for:", selectedProgramme);
                setTimeout(() => {
                    loadProgrammeData(selectedProgramme);
                }, 100); // Add small delay to ensure DOM is ready
            } else {
                // If dropdown not found, load data from URL parameter
                console.log("Programme selection dropdown not found, loading data for:", selectedProgramme);
                setTimeout(() => {
                    loadProgrammeData(selectedProgramme);
                }, 100); // Add small delay to ensure DOM is ready
            }

            // Add export functionality
            document.getElementById('export-plo-mlo-btn').addEventListener('click', function() {
                alert('Export functionality will be implemented');
            });

            // Add Excel export functionality
            document.getElementById('export-excel-btn').addEventListener('click', function() {
                alert('Excel export functionality will be implemented');
            });
        });
    </script>
</body>
</html>
