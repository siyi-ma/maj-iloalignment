<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programme-Learning Outcomes Alignment Analysis</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .matrix-table {
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.9em;
            width: 100%;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
            overflow-x: auto;
            display: block;
        }
        
        .matrix-table thead tr {
            background-color: #e0e0e0;
            color: #342b60;
            text-align: center;
        }
        
        .matrix-table th,
        .matrix-table td {
            padding: 6px 8px;
            text-align: center;
            border: 1px solid #ddd;
            min-width: 50px;
        }
        
        .matrix-table th:first-child {
            min-width: 100px;
            text-align: left;
        }
        
        .matrix-table tbody tr {
            border-bottom: 1px solid #dddddd;
        }
        
        .matrix-table tbody tr:nth-of-type(even) {
            background-color: #f3f3f3;
        }
        
        .matrix-corner {
            background-color: #e0e0e0;
            color: #342b60;
            font-weight: bold;
        }
        
        .toggle-btn {
            background-color: #e0e0e0;
            color: #342b60;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .toggle-btn.active {
            background-color: #342b60;
            color: white;
        }
        
        .toggle-btn:hover {
            background-color: #d0d0d0;
        }
        
        /* Adding specific styles for detailed analysis tables */
        .analysis-table {
            width: 100% !important;
            border-collapse: collapse !important;
            table-layout: fixed !important;
            margin-bottom: 20px;
        }
        
        .analysis-table th,
        .analysis-table td {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .analysis-table th {
            background-color: #342b60;
            color: white;
        }
        
        .analysis-table .mlo-col {
            width: 25%;
        }
        
        .analysis-table .score-col {
            width: 10%;
            text-align: center;
        }
        
        .analysis-table .justification-col {
            width: 65%;
        }
        
        .score-0 { background-color: #f5f5f5; color: #333; }
        .score-1 { background-color: #ffcdd2; color: #000; }
        .score-2 { background-color: #ffecb3; color: #000; }
        .score-3 { background-color: #fff9c4; color: #000; }
        .score-4 { background-color: #c8e6c9; color: #000; }
        .score-5 { background-color: #a5d6a7; color: #000; }
        
        .alignment-item {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .alignment-header {
            display: flex;
            flex-direction: column;
            padding: 0;
            background-color: #f5f5f5;
            border-bottom: 1px solid #ddd;
            margin-bottom: 0;
        }
        
        .alignment-title-row {
            background-color: #342b60;
            color: white;
            width: 100%;
            padding: 10px 15px;
            font-weight: bold;
            display: block;
        }
        
        .alignment-score-row {
            padding: 8px 15px;
            text-align: right;
            background-color: #f5f5f5;
            display: block;
            width: 100%;
        }
        
        .alignment-title {
            font-weight: bold;
            font-size: 1.1em;
            color: white;
        }
        
        .alignment-details {
            padding: 15px;
            background-color: #fff;
        }
        
        .alignment-plo, .alignment-mlo {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .alignment-reason {
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .alignment-suggestion {
            padding: 10px;
            background-color: #fff9c4;
            border-radius: 5px;
            border-left: 3px solid #ffd600;
        }
        
        .module-header {
            margin-top: 30px;
            padding-bottom: 10px;
            border-bottom: 2px solid #342b60;
            color: #342b60;
        }
        
        .matrix-tooltip {
            position: absolute;
            background-color: #342b60;
            color: white;
            padding: 10px;
            border-radius: 5px;
            max-width: 300px;
            z-index: 1000;
            pointer-events: none;
        }
        
        .back-to-top {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background-color: #342b60;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: opacity 0.3s, transform 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 1.2em;
        }
        
        .back-to-top.active {
            transform: scale(1.1);
        }
        
        .back-to-top:hover {
            transform: scale(1.15);
            background-color: #e4067e;
        }
        
        .report-footer-actions {
            text-align: center;
            padding: 20px 0;
            margin-top: 20px;
            border-top: 1px solid #ddd;
        }
        
        .export-btn {
            background-color: #AA1352;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s, transform 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .export-btn:hover {
            background-color: #950f47;
            transform: translateY(-2px);
        }
        
        .alignment-summary {
            background-color: #f0f7ff;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #342b60;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .alignment-summary h3 {
            color: #342b60;
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .alignment-summary ul {
            margin-top: 10px;
            margin-bottom: 10px;
            padding-left: 25px;
        }
        
        .alignment-summary li {
            margin-bottom: 8px;
        }
        
        .legend {
            margin: 20px 0;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        
        .legend h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 5px;
            border: 1px solid #ddd;
        }
        
        .module-section {
            margin-bottom: 30px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .module-header {
            padding: 10px 15px;
            background-color: #342b60;
            color: white;
            margin: 0;
        }
        
        .module-content {
            padding: 15px;
        }
        
        .module-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .module-description {
            color: #666;
            margin-bottom: 10px;
        }
        
        .outcome-item {
            border-left: 3px solid #342b60;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }

        .input-container {
            margin: 20px 0;
            text-align: center;
        }

        .input-container label {
            font-weight: bold;
            margin-right: 10px;
        }

        .input-container select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        /* Add this where you want the programme names to appear, e.g. in your header */
        #programme-names {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            margin: 20px 0;
            color: #342b60;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1><i class="fas fa-graduation-cap"></i> Learning Outcomes Alignment</h1>
                <p>Programme and Learning Outcomes Alignment Tool</p>
            </div>
            <div class="header-buttons">
                <a href="index.html" class="home-btn"><i class="fas fa-home"></i> Home</a>
            </div>
        </header>

        <main>
            <section id="overview" class="active-section">
                <h2><i class="fas fa-info-circle"></i> Overview</h2>
                <p>This analysis examines how well the Module Learning Outcomes (MLOs) align with the Programme Learning Outcomes (PLOs) for the International Business Administration (TVTB). The alignment is scored on a scale from 1 to 5:</p>
                
                <div class="legend">
                    <h4>Alignment Score Legend:</h4>
                    <div class="legend-items">
                        <div class="legend-item"><div class="legend-color score-1"></div><span>1: Minimal alignment</span></div>
                        <div class="legend-item"><div class="legend-color score-2"></div><span>2: Partial alignment</span></div>
                        <div class="legend-item"><div class="legend-color score-3"></div><span>3: Moderate alignment</span></div>
                        <div class="legend-item"><div class="legend-color score-4"></div><span>4: Strong alignment</span></div>
                        <div class="legend-item"><div class="legend-color score-5"></div><span>5: Excellent alignment</span></div>
                    </div>
                </div>
                
                <div id="alignment-summary" class="alignment-summary">
                    <h3>Alignment Summary</h3>
                    <p>The analysis examines the relationships between the 6 Programme Learning Outcomes (PLOs) that define the overall goals of the business school programme and the Module Learning Outcomes (MLOs) across different course modules. The alignment assessment shows how each module contributes to the programme's educational objectives.</p>
                    <p>Critical findings and improvement suggestions:</p>
                    <ul>
                        <li>General Studies Module (YLM) shows inadequate alignment (2.66/5) with programme goals - needs stronger connections to business administration concepts</li>
                        <li>Core modules (P1 and P2) demonstrate inconsistent alignment patterns with some weak areas in integrative skills and communication competencies</li>
                        <li>Special Studies Module E1 shows concerning low alignment scores (1.60/5) with critical PLOs - requires significant curriculum restructuring</li>
                        <li>Accounting and Finance (E2) needs better integration with entrepreneurial and management PLOs</li>
                        <li>The Graduation Thesis Module needs clearer alignment with professional communication and teamwork PLOs</li>
                    </ul>
                    <p>Recommended actions: Review module content with focus on strengthening interdisciplinary connections, address significant gaps in E1 module, and better integrate practical skill development across the curriculum.</p>
                </div>
            </section>

            <section id="plo-section">
                <h2><i class="fas fa-list-check"></i> Programme Learning Outcomes (PLOs)</h2>
                <div id="plo-container">
                    <!-- PLOs will be displayed here by the JavaScript -->
                </div>
            </section>

            <section id="mlo-section">
                <h2><i class="fas fa-list-check"></i> Module Learning Outcomes (MLOs) by Category</h2>
                <div id="mlo-container">
                    <!-- MLOs will be displayed here by the JavaScript -->
                </div>
            </section>
            
            <section id="matrix-section">
                <h2><i class="fas fa-table"></i> Alignment Matrix</h2>
                <p>This matrix shows the alignment scores between all PLOs and MLO categories. Hover over a cell to see the alignment justification. Click any cell to navigate to the detailed analysis.</p>
                <div class="matrix-actions">
                    <button id="export-excel-btn" class="export-btn"><i class="fas fa-file-excel"></i> Export Matrix to Excel</button>
                </div>
                <div id="matrix-container">
                    <!-- Alignment matrix will be generated here by JavaScript -->
                </div>
            </section>
            
            <section id="detailed-analysis">
                <h2><i class="fas fa-chart-bar"></i> Detailed Breakdown</h2>
                <div id="analysis-header" class="analysis-header">
                    <p>Below is a detailed breakdown of alignment between Programme Learning Outcomes and Module Learning Outcomes.</p>
                </div>
                <div id="detailed-container">
                    <!-- Detailed breakdown will be generated here by JavaScript -->
                </div>
            </section>
            
            <section id="report-section" class="hidden-section">
                <h2><i class="fas fa-file-alt"></i> Alignment Report</h2>
                <div id="report-container">
                    <!-- Comprehensive alignment report will be generated here -->
                </div>
            </section>

            <div class="input-container">
                <label for="programme-select-plo-mlo"><strong>Programme:</strong></label>
                <select id="programme-select-plo-mlo">
                    <option value="tvtb">Rahvusvaheline ärikorraldus (TVTB)</option>
                    <option value="majb">Jätkusuutlik ettevõtlus ja ringmajandus (MAJB)</option>
                    <option value="makm">Kestlikkuse juhtimine (MAKM)</option>
                </select>
            </div>
            <div id="plo-mlo-matrix"></div>
        </main>
        
        <div class="report-footer-actions">
            <button id="export-plo-mlo-btn" class="export-btn"><i class="fas fa-file-export"></i> Export Report</button>
        </div>
        
        <footer>
            <p>&copy; 2025 TVTB ILO Alignment | TalTech Majandusteaduskonna Siyi Ma</p>
        </footer>
    </div>

    <div class="back-to-top active">
        <i class="fas fa-arrow-up"></i>
    </div>

    <style>
        .header-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .export-btn {
            background-color: #AA1352;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
        }
        
        .export-btn:hover {
            background-color: #950f47;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM Content Loaded - Initializing PLO-MLO alignment page");
            let plos = [];
            let moduleGroups = {};
            
            // Helper function to extract keywords from text
            function extractKeywords(text) {
                // Convert to lowercase
                const lowerText = text.toLowerCase();
                
                // Define business and educational keywords that are important
                const businessKeywords = [
                    'business', 'management', 'marketing', 'finance', 'accounting', 'entrepreneurship',
                    'strategy', 'economics', 'organization', 'leadership', 'innovation', 'analysis',
                    'planning', 'decision', 'ethics', 'sustainability', 'global', 'international',
                    'communication', 'teamwork', 'problem-solving', 'critical thinking', 'research'
                ];
                
                // Extract words
                const words = lowerText.match(/[a-z]+/g) || [];
                
                // Filter for business-relevant keywords
                const keywords = words.filter(word => 
                    businessKeywords.includes(word) || word.length > 6
                );
                
                return [...new Set(keywords)]; // Remove duplicates
            }
            
            // Helper function to extract action verbs
            function extractVerbs(text) {
                const actionVerbs = [
                    'analyze', 'analyzes', 'apply', 'applies', 'demonstrate', 'demonstrates',
                    'understand', 'understands', 'evaluate', 'evaluates', 'create', 'creates',
                    'develop', 'develops', 'implement', 'implements', 'manage', 'manages',
                    'plan', 'plans', 'design', 'designs', 'solve', 'solves'
                ];
                
                const lowerText = text.toLowerCase();
                return actionVerbs.filter(verb => lowerText.includes(verb));
            }
            
            // Function to calculate alignment score between PLO and MLO text
            function calculateAlignmentScore(ploText, mloText) {
                // Extract keywords from both texts
                const ploKeywords = extractKeywords(ploText);
                const mloKeywords = extractKeywords(mloText);
                
                // Extract verbs from both texts
                const ploVerbs = extractVerbs(ploText);
                const mloVerbs = extractVerbs(mloText);
                
                // Calculate keyword match score
                let keywordScore = 0;
                ploKeywords.forEach(keyword => {
                    if (mloText.toLowerCase().includes(keyword)) {
                        keywordScore += 0.5;
                    }
                    
                    // Check for partial matches
                    const partialMatches = mloKeywords.filter(mk => 
                        mk.includes(keyword) || keyword.includes(mk));
                    if (partialMatches.length > 0) {
                        keywordScore += 0.2;
                    }
                });
                
                // Calculate verb match score
                let verbScore = 0;
                ploVerbs.forEach(verb => {
                    if (mloVerbs.includes(verb)) {
                        verbScore += 1;
                    }
                });
                
                // Normalize scores
                const normalizedKeywordScore = Math.min(keywordScore / Math.max(ploKeywords.length, 1), 1);
                const normalizedVerbScore = Math.min(verbScore / Math.max(ploVerbs.length, 1), 1);
                
                // Combined score (weighted average)
                const combinedScore = (0.7 * normalizedKeywordScore + 0.3 * normalizedVerbScore) * 5;
                
                // Ensure score is between 1 and 5
                return Math.max(1, Math.min(5, Math.round(combinedScore)));
            }
            
            // Function to generate alignment reason
            function generateAlignmentReason(ploText, mloText, score) {
                const ploKeywords = extractKeywords(ploText);
                const mloKeywords = extractKeywords(mloText);
                const ploVerbs = extractVerbs(ploText);
                const mloVerbs = extractVerbs(mloText);
                
                // Find common keywords and verbs
                const commonKeywords = ploKeywords.filter(pk => 
                    mloText.toLowerCase().includes(pk));
                const commonVerbs = ploVerbs.filter(pv => mloVerbs.includes(pv));
                
                let reason = "";
                
                if (score >= 4) {
                    reason = `Strong alignment: `;
                    if (commonKeywords.length > 0) {
                        reason += `Shared focus areas include ${commonKeywords.slice(0, 3).join(', ')}. `;
                    }
                    if (commonVerbs.length > 0) {
                        reason += `Common learning activities: ${commonVerbs.slice(0, 2).join(', ')}.`;
                    }
                } else if (score >= 3) {
                    reason = `Moderate alignment: `;
                    if (commonKeywords.length > 0) {
                        reason += `Some shared concepts like ${commonKeywords.slice(0, 2).join(', ')}. `;
                    }
                    reason += `Contributes to the overall learning objective.`;
                } else if (score >= 2) {
                    reason = `Partial alignment: `;
                    if (commonKeywords.length > 0) {
                        reason += `Limited connection through ${commonKeywords[0]}. `;
                    }
                    reason += `Provides supporting knowledge.`;
                } else {
                    reason = `Minimal alignment: `;
                    reason += `Primarily foundational knowledge with indirect contribution.`;
                }
                
                return reason;
            }
            
            // Function to generate improvement suggestion
            function generateImprovementSuggestion(ploText, mloText) {
                return "Consider strengthening the alignment by revising either the Programme or Module Learning Outcome to better reflect shared terminology and concepts.";
            }
            
            // Function to display the Programme Learning Outcomes
            function displayPLOs(plos) {
                console.log("Displaying PLOs:", plos.length);
                const ploContainer = document.getElementById('plo-container');
                
                if (!ploContainer) {
                    console.error("PLO container element not found");
                    return;
                }
                
                ploContainer.innerHTML = ''; // Clear existing content
                
                plos.forEach((plo, index) => {
                    const ploItem = document.createElement('div');
                    ploItem.className = 'outcome-item';
                    ploItem.innerHTML = `
                        <h3>PLO ${index + 1}</h3>
                        <p>${plo.ilosisu}</p>
                    `;
                    ploContainer.appendChild(ploItem);
                });
            }
            
            // Function to display Module Learning Outcomes by category
            function displayMLOsByCategory(moduleGroups) {
                console.log("Displaying MLOs by category");
                const mloContainer = document.getElementById('mlo-container');
                
                if (!mloContainer) {
                    console.error("MLO container element not found");
                    return;
                }
                
                mloContainer.innerHTML = ''; // Clear existing content
                
                // Define module order and names for display
                const moduleOrder = ['ylmlo', 'p1mlo', 'p2mlo', 'e1mlo', 'e2mlo', 'gdmlo'];
                const moduleNames = {
                    'ylmlo': 'General Studies Module - Foundational Competences',
                    'p1mlo': 'Core Studies Module - P1 Methods, Markets and Economy',
                    'p2mlo': 'Core Studies Module - P2 Core Business Competences',
                    'e1mlo': 'Special Studies Module - E1 Entrepreneurship and Marketing',
                    'e2mlo': 'Special Studies Module - E2 Finance and Accounting',
                    'gdmlo': 'Graduation Thesis Module'
                };
                
                // Create a section for each module in the specified order
                moduleOrder.forEach(moduleCode => {
                    if (!moduleGroups[moduleCode]) return; // Skip if module doesn't exist
                    
                    const moduleMLOs = moduleGroups[moduleCode];
                    
                    // Create module section
                    const moduleSection = document.createElement('div');
                    moduleSection.className = 'module-section';
                    
                    // Add module header with the full name
                    const moduleHeader = document.createElement('h3');
                    moduleHeader.className = 'module-header';
                    moduleHeader.textContent = moduleNames[moduleCode] || moduleCode.toUpperCase();
                    moduleSection.appendChild(moduleHeader);
                    
                    // Create content container
                    const moduleContent = document.createElement('div');
                    moduleContent.className = 'module-content';
                    
                    // Add MLOs for this module
                    moduleMLOs.forEach((mlo, index) => {
                        const mloItem = document.createElement('div');
                        mloItem.className = 'outcome-item';
                        mloItem.innerHTML = `
                            <h4>${moduleCode.toUpperCase()} ${index + 1}</h4>
                            <p>${mlo.ilosisu}</p>
                        `;
                        moduleContent.appendChild(mloItem);
                    });
                    
                    moduleSection.appendChild(moduleContent);
                    mloContainer.appendChild(moduleSection);
                });
            }
            
            // Helper function to extract keywords from text
            function extractKeywords(text) {
                // Convert to lowercase
                const lowerText = text.toLowerCase();
                
                // Define business and educational keywords that are important
                const businessKeywords = [
                    'business', 'management', 'marketing', 'finance', 'accounting', 'entrepreneurship',
                    'strategy', 'economics', 'organization', 'leadership', 'innovation', 'analysis',
                    'planning', 'decision', 'ethics', 'sustainability', 'global', 'international',
                    'communication', 'teamwork', 'problem-solving', 'critical thinking', 'research'
                ];
                
                // Extract words
                const words = lowerText.match(/[a-z]+/g) || [];
                
                // Filter for business-relevant keywords
                const keywords = words.filter(word => 
                    businessKeywords.includes(word) || word.length > 6
                );
                
                return [...new Set(keywords)]; // Remove duplicates
            }
            
            // Helper function to extract action verbs
            function extractVerbs(text) {
                const actionVerbs = [
                    'analyze', 'analyzes', 'apply', 'applies', 'demonstrate', 'demonstrates',
                    'understand', 'understands', 'evaluate', 'evaluates', 'create', 'creates',
                    'develop', 'develops', 'implement', 'implements', 'manage', 'manages',
                    'plan', 'plans', 'design', 'designs', 'solve', 'solves'
                ];
                
                const lowerText = text.toLowerCase();
                return actionVerbs.filter(verb => lowerText.includes(verb));
            }
            
            // Function to calculate alignment score between PLO and MLO text
            function calculateAlignmentScore(ploText, mloText) {
                // Extract keywords from both texts
                const ploKeywords = extractKeywords(ploText);
                const mloKeywords = extractKeywords(mloText);
                
                // Extract verbs from both texts
                const ploVerbs = extractVerbs(ploText);
                const mloVerbs = extractVerbs(mloText);
                
                // Calculate keyword match score
                let keywordScore = 0;
                ploKeywords.forEach(keyword => {
                    if (mloText.toLowerCase().includes(keyword)) {
                        keywordScore += 0.5;
                    }
                    
                    // Check for partial matches
                    const partialMatches = mloKeywords.filter(mk => 
                        mk.includes(keyword) || keyword.includes(mk));
                    if (partialMatches.length > 0) {
                        keywordScore += 0.2;
                    }
                });
                
                // Calculate verb match score
                let verbScore = 0;
                ploVerbs.forEach(verb => {
                    if (mloVerbs.includes(verb)) {
                        verbScore += 1;
                    }
                });
                
                // Normalize scores
                const normalizedKeywordScore = Math.min(keywordScore / Math.max(ploKeywords.length, 1), 1);
                const normalizedVerbScore = Math.min(verbScore / Math.max(ploVerbs.length, 1), 1);
                
                // Combined score (weighted average)
                const combinedScore = (0.7 * normalizedKeywordScore + 0.3 * normalizedVerbScore) * 5;
                
                // Ensure score is between 1 and 5
                return Math.max(1, Math.min(5, Math.round(combinedScore)));
            }
            
            // Function to generate alignment reason
            function generateAlignmentReason(ploText, mloText, score) {
                const ploKeywords = extractKeywords(ploText);
                const mloKeywords = extractKeywords(mloText);
                const ploVerbs = extractVerbs(ploText);
                const mloVerbs = extractVerbs(mloText);
                
                // Find common keywords and verbs
                const commonKeywords = ploKeywords.filter(pk => 
                    mloText.toLowerCase().includes(pk));
                const commonVerbs = ploVerbs.filter(pv => mloVerbs.includes(pv));
                
                let reason = "";
                
                if (score >= 4) {
                    reason = `Strong alignment: `;
                    if (commonKeywords.length > 0) {
                        reason += `Shared focus areas include ${commonKeywords.slice(0, 3).join(', ')}. `;
                    }
                    if (commonVerbs.length > 0) {
                        reason += `Common learning activities: ${commonVerbs.slice(0, 2).join(', ')}.`;
                    }
                } else if (score >= 3) {
                    reason = `Moderate alignment: `;
                    if (commonKeywords.length > 0) {
                        reason += `Some shared concepts like ${commonKeywords.slice(0, 2).join(', ')}. `;
                    }
                    reason += `Contributes to the overall learning objective.`;
                } else if (score >= 2) {
                    reason = `Partial alignment: `;
                    if (commonKeywords.length > 0) {
                        reason += `Limited connection through ${commonKeywords[0]}. `;
                    }
                    reason += `Provides supporting knowledge.`;
                } else {
                    reason = `Minimal alignment: `;
                    reason += `Primarily foundational knowledge with indirect contribution.`;
                }
                
                return reason;
            }
            
            // Load the data from the JSON file
            async function loadProgrammeData(programmeCode = 'tvtb') {
                console.log("Loading programme data for:", programmeCode);
                try {
                    const response = await fetch('data/programmes.json');
                    const data = await response.json();
                    
                    // Check if the programme exists in the data
                    if (data[programmeCode]) {
                        console.log("Programme data found:", programmeCode);
                        // Update page title and header with programme name
                        const programmeData = data[programmeCode];
                        document.title = `${programmeData.kavanimetusik || programmeData.kavanimetusek} - Learning Outcome Alignment`;
                        
                        // Update header content
                        const headerTitle = document.querySelector('header h1');
                        if (headerTitle) {
                            headerTitle.innerHTML = `<i class="fas fa-graduation-cap"></i> ${programmeData.kavanimetusik || programmeData.kavanimetusek} Learning Outcome Alignment`;
                        }
                        
                        // Update subtitle
                        const headerSubtitle = document.querySelector('header p');
                        if (headerSubtitle) {
                            headerSubtitle.textContent = `Programme and Module Learning Outcomes Alignment Tool`;
                        }
                        
                        // Update footer with programme name
                        const footer = document.querySelector('footer p');
                        if (footer) {
                            footer.textContent = `© 2025 ${programmeCode.toUpperCase()} ILO Alignment | TalTech Majandusteaduskonna ${programmeData.kavanimetusik || programmeData.kavanimetusek}`;
                        }
                        
                        // Extract PLOs from programme data
                        plos = programmeData.plos.map(plo => ({
                            kategooria: 'kava',
                            ilosisu: plo.plosisuik || plo.plosisuek
                        }));
                        
                        console.log("Extracted PLOs:", plos.length);
                        
                        // Extract MLOs and organize by module code
                        moduleGroups = {};
                        
                        // Group MLOs by module code prefix
                        const mlosByPrefix = {};
                        if (programmeData.mlos) {
                            programmeData.mlos.forEach(mlo => {
                                const prefix = mlo.mlokood ? mlo.mlokood.split('_')[0] : '';
                                if (!prefix) return;
                                
                                if (!mlosByPrefix[prefix]) {
                                    mlosByPrefix[prefix] = [];
                                }
                                
                                mlosByPrefix[prefix].push({
                                    moodlikood: prefix + 'mlo',
                                    kategooria: 'moodul',
                                    ilosisu: mlo.mlosisuik || mlo.mlosisuek
                                });
                            });
                            
                            // Convert to the required format
                            Object.keys(mlosByPrefix).forEach(prefix => {
                                moduleGroups[prefix + 'mlo'] = mlosByPrefix[prefix];
                            });
                            
                            console.log("Extracted module groups:", Object.keys(moduleGroups));
                            
                            // Update the UI with the new data
                            displayPLOs(plos);
                            displayMLOsByCategory(moduleGroups);
                            
                            // Generate alignment analysis
                            const alignmentResults = analyzeAlignment(plos, moduleGroups);
                            
                            // Display alignment matrix
                            displayAlignmentMatrix(plos, moduleGroups, alignmentResults);
                            
                            // Display detailed analysis
                            displayDetailedAnalysis(plos, moduleGroups, alignmentResults);
                            
                            // Update overview section with programme-specific content
                            const overviewTitle = document.querySelector('#overview h2');
                            if (overviewTitle) {
                                overviewTitle.innerHTML = `<i class="fas fa-info-circle"></i> Overview - ${programmeData.kavanimetusik || programmeData.kavanimetusek}`;
                            }
                            
                            const overviewParagraph = document.querySelector('#overview p');
                            if (overviewParagraph) {
                                overviewParagraph.textContent = `This analysis examines how well the Module Learning Outcomes (MLOs) align with the Programme Learning Outcomes (PLOs) for the ${programmeData.kavanimetusik || programmeData.kavanimetusek}. The alignment is scored on a scale from 1 to 5:`;
                            }
                        } else {
                            console.error(`No MLOs found for programme code ${programmeCode}`);
                        }
                    } else {
                        console.error(`Programme code ${programmeCode} not found in the data`);
                    }
                } catch (error) {
                    console.error("Error loading programme data:", error);
                }
            }
            
            // Set up the programme selection dropdown
            const programmeSelect = document.getElementById('programme-select-plo-mlo');
            console.log("Programme selection dropdown:", programmeSelect);
            
            if (programmeSelect) {
                programmeSelect.addEventListener('change', function() {
                    console.log("Programme selection changed to:", this.value);
                    loadProgrammeData(this.value);
                });
                
                // Load default programme data (tvtb)
                console.log("Loading default programme data:", programmeSelect.value);
                setTimeout(() => {
                    loadProgrammeData(programmeSelect.value);
                }, 100); // Add small delay to ensure DOM is ready
            } else {
                // If dropdown not found, load default data
                console.log("Programme selection dropdown not found, loading default data");
                setTimeout(() => {
                    loadProgrammeData();
                }, 100); // Add small delay to ensure DOM is ready
            }

            // These functions are defined above
            // They are called by loadProgrammeData after data is loaded

            // Handle back to top button with contextual behavior
            const backToTopButton = document.querySelector('.back-to-top');
            
            window.addEventListener('scroll', function() {
                if (window.pageYOffset > 300) {
                    backToTopButton.classList.add('active');
                    backToTopButton.style.opacity = '1';
                } else {
                    backToTopButton.classList.remove('active');
                    backToTopButton.style.opacity = '0.7';
                }
                
                // Update button icon based on scroll position
                updateButtonIcon();
            });
            
            function updateButtonIcon() {
                const matrixSection = document.getElementById('matrix-section');
                const detailedSection = document.getElementById('detailed-analysis');
                
                const matrixPosition = matrixSection.getBoundingClientRect().top;
                const detailedPosition = detailedSection.getBoundingClientRect().top;
                
                // If user is in detailed analysis section
                if (detailedPosition < 100 && matrixPosition < -100) {
                    backToTopButton.innerHTML = '<i class="fas fa-chevron-up"></i>';
                    backToTopButton.title = 'Go to Matrix';
                } else {
                    backToTopButton.innerHTML = '<i class="fas fa-arrow-up"></i>';
                    backToTopButton.title = 'Go to Top';
                }
            }
            
            backToTopButton.addEventListener('click', function() {
                const matrixSection = document.getElementById('matrix-section');
                const detailedSection = document.getElementById('detailed-analysis');
                
                const matrixPosition = matrixSection.getBoundingClientRect().top;
                const detailedPosition = detailedSection.getBoundingClientRect().top;
                
                // If user is in detailed analysis section, go to matrix
                if (detailedPosition < 100 && matrixPosition < -100) {
                    matrixSection.scrollIntoView({ behavior: 'smooth' });
                } else {
                    // Otherwise go to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });
            
            // Add export functionality
            document.getElementById('export-plo-mlo-btn').addEventListener('click', function() {
                exportPLOMLOReport();
            });
            
            // Add Excel export functionality
            document.getElementById('export-excel-btn').addEventListener('click', function() {
                exportMatrixToExcel();
            });
            
            // Add Excel export functionality
            function exportMatrixToExcel() {
                // Create a table data structure for Excel
                let tableData = [];
                
                // Define module names
                const moduleNames = {
                    'ylmlo': 'General Studies Module',
                    'p1mlo': 'P1: Methods, Markets and Economy',
                    'p2mlo': 'P2: Core Business Competences', 
                    'e1mlo': 'E1: Entrepreneurship and Marketing',
                    'e2mlo': 'E2: Finance and Accounting',
                    'gdmlo': 'Graduation Thesis Module'
                };
                
                // Get the matrix data
                const matrixTable = document.querySelector('.matrix-table');
                if (!matrixTable) return;
                
                // Process header row to get MLO labels
                const headerRows = matrixTable.querySelectorAll('thead tr');
                const mloLabels = [];
                
                // Process the second header row which contains MLO numbers
                if (headerRows.length > 1) {
                    const mloHeaders = headerRows[1].querySelectorAll('th');
                    mloHeaders.forEach(header => {
                        mloLabels.push(header.textContent);
                    });
                }
                
                // Create the header row for the Excel table
                const headerRow = ['PLO / MLO', ...mloLabels];
                tableData.push(headerRow);
                
                // Process each PLO row
                const rows = matrixTable.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const rowData = [];
                    const cells = row.querySelectorAll('th, td');
                    
                    cells.forEach(cell => {
                        if (cell.tagName === 'TH') {
                            // This is the PLO label
                            rowData.push(cell.textContent);
                        } else {
                            // This is a score cell
                            rowData.push(cell.textContent);
                        }
                    });
                    
                    tableData.push(rowData);
                });
                
                // Convert the table data to CSV format
                let csvContent = "data:text/csv;charset=utf-8,";
                
                tableData.forEach(row => {
                    const rowStr = row.join(',');
                    csvContent += rowStr + '\r\n';
                });
                
                // Create a download link
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', 'PLO_MLO_Matrix.csv');
                document.body.appendChild(link);
                
                // Trigger download
                link.click();
                
                // Clean up
                document.body.removeChild(link);
            }
            
            function exportPLOMLOReport() {
                const currentDate = new Date().toISOString().split('T')[0]; // Get today's date in YYYY-MM-DD format
                const previewWindow = window.open('', '_blank');
                
                // Function to calculate accurate score average to 2 decimal places
                function getAccurateAverage(scores) {
                    return scores.length > 0 
                        ? (scores.reduce((acc, val) => acc + val, 0) / scores.length).toFixed(2)
                        : "0.00";
                }
                
                // Generate the export content
                let exportContent = `
                    <html>
                    <head>
                        <title>PLO-MLO Alignment Report - ${currentDate}</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif;
                                padding: 40px;
                                max-width: 1000px;
                                margin: 0 auto;
                                line-height: 1.6;
                            }
                            h1, h2, h3 { 
                                color: #342b60;
                            }
                            h3 { margin-top: 30px; }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin: 20px 0;
                                page-break-inside: avoid;
                            }
                            th, td {
                                padding: 12px;
                                border: 1px solid #ddd;
                                text-align: left;
                            }
                            .mlo-section, .plo-section {
                                margin-bottom: 30px;
                                page-break-inside: avoid;
                            }
                            .outcome-item {
                                margin-bottom: 15px;
                                padding: 10px;
                                border-left: 3px solid #342b60;
                                background-color: #f8f9fa;
                            }
                            .module-section {
                                margin-bottom: 30px;
                                page-break-inside: avoid;
                            }
                            .score-0 { background-color: #f5f5f5; color: #999; }
                            .score-1 { background-color: #ffcdd2; }
                            .score-2 { background-color: #ffecb3; }
                            .score-3 { background-color: #fff9c4; }
                            .score-4 { background-color: #c8e6c9; }
                            .score-5 { background-color: #a5d6a7; }
                            .print-controls {
                                position: fixed;
                                bottom: 20px;
                                right: 20px;
                                background: white;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            }
                            @media print {
                                .print-controls { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <h1>Programme-Module Learning Outcomes Alignment Report</h1>
                        <p><strong>Generated:</strong> ${currentDate}</p>
                        
                        <div class="legend">
                            <h3>Alignment Score Legend</h3>
                            <table>
                                <tr>
                                    <td class="score-0" width="50">0</td>
                                    <td>No alignment</td>
                                </tr>
                                <tr>
                                    <td class="score-1" width="50">1</td>
                                    <td>Minimal alignment</td>
                                </tr>
                                <tr>
                                    <td class="score-2" width="50">2</td>
                                    <td>Partial alignment</td>
                                </tr>
                                <tr>
                                    <td class="score-3" width="50">3</td>
                                    <td>Moderate alignment</td>
                                </tr>
                                <tr>
                                    <td class="score-4" width="50">4</td>
                                    <td>Strong alignment</td>
                                </tr>
                                <tr>
                                    <td class="score-5" width="50">5</td>
                                    <td>Excellent alignment</td>
                                </tr>
                            </table>
                        </div>
                        
                        <h2>Programme Learning Outcomes (PLOs)</h2>
                        ${document.getElementById('plo-container').innerHTML}
                        
                        <h2>Module Learning Outcomes (MLOs) by Category</h2>
                        ${document.getElementById('mlo-container').innerHTML}
                        
                        <h2>Alignment Matrix</h2>
                        <p>This matrix shows the alignment scores between all PLOs and MLO categories.</p>
                        ${document.getElementById('matrix-container').innerHTML}
                        
                        <h2>Detailed Analysis</h2>
                        ${document.getElementById('detailed-container').innerHTML}
                        
                        <div class="print-controls">
                            <button onclick="window.print()" style="margin-right: 10px;">Save as PDF/Print</button>
                            <button onclick="window.close()">Close Preview</button>
                        </div>
                    </body>
                    </html>
                `;
                
                previewWindow.document.write(exportContent);
                previewWindow.document.close();
            }
            
            // Function to display the Programme Learning Outcomes
            function displayPLOs(plos) {
                const ploContainer = document.getElementById('plo-container');
                
                plos.forEach((plo, index) => {
                    const ploItem = document.createElement('div');
                    ploItem.className = 'outcome-item';
                    ploItem.innerHTML = `
                        <h3>PLO ${index + 1}</h3>
                        <p>${plo.ilosisu}</p>
                    `;
                    ploContainer.appendChild(ploItem);
                });
            }
            
            // Function to display Module Learning Outcomes by category
            function displayMLOsByCategory(moduleGroups) {
                const mloContainer = document.getElementById('mlo-container');
                
                // Define module order and names for display
                const moduleOrder = ['ylmlo', 'p1mlo', 'p2mlo', 'e1mlo', 'e2mlo', 'gdmlo'];
                const moduleNames = {
                    'ylmlo': 'General Studies Module - Foundational Competences',
                    'p1mlo': 'Core Studies Module - P1 Methods, Markets and Economy',
                    'p2mlo': 'Core Studies Module - P2 Core Business Competences',
                    'e1mlo': 'Special Studies Module - E1 Entrepreneurship and Marketing',
                    'e2mlo': 'Special Studies Module - E2 Finance and Accounting',
                    'gdmlo': 'Graduation Thesis Module'
                };
                
                // Create a section for each module in the specified order
                moduleOrder.forEach(moduleCode => {
                    if (!moduleGroups[moduleCode]) return; // Skip if module doesn't exist
                    
                    const moduleMLOs = moduleGroups[moduleCode];
                    
                    // Create module section
                    const moduleSection = document.createElement('div');
                    moduleSection.className = 'module-section';
                    
                    // Add module header with the full name
                    const moduleHeader = document.createElement('h3');
                    moduleHeader.className = 'module-header';
                    moduleHeader.textContent = moduleNames[moduleCode] || moduleCode.toUpperCase();
                    moduleSection.appendChild(moduleHeader);
                    
                    // Create content container
                    const moduleContent = document.createElement('div');
                    moduleContent.className = 'module-content';
                    
                    // Add MLOs for this module
                    moduleMLOs.forEach((mlo, index) => {
                        const mloItem = document.createElement('div');
                        mloItem.className = 'outcome-item';
                        mloItem.innerHTML = `
                            <h4>${moduleCode.toUpperCase()} ${index + 1}</h4>
                            <p>${mlo.ilosisu}</p>
                        `;
                        moduleContent.appendChild(mloItem);
                    });
                    
                    moduleSection.appendChild(moduleContent);
                    mloContainer.appendChild(moduleSection);
                });
            }
            
            // Function to analyze alignment between PLOs and MLOs
            function analyzeAlignment(plos, moduleGroups) {
                console.log("Analyzing alignment between PLOs and MLOs");
                const alignmentResults = {};
                
                try {
                    // For each PLO, analyze alignment with each MLO module
                    plos.forEach((plo, ploIndex) => {
                        const ploKey = `plo-${ploIndex}`;
                        alignmentResults[ploKey] = {};
                        
                        // For each module
                        Object.keys(moduleGroups).forEach(moduleCode => {
                            const moduleMLOs = moduleGroups[moduleCode];
                            let moduleScore = 0;
                            let moduleScores = [];
                            let moduleJustifications = [];
                            
                            // Compare PLO with each MLO in the module
                            moduleMLOs.forEach((mlo, mloIndex) => {
                                try {
                                    // Use try-catch to handle any potential errors in the alignment calculation
                                    let score = 3; // Default moderate alignment
                                    let justification = "Standard alignment between programme and module outcomes";
                                    
                                    try {
                                        score = calculateAlignmentScore(plo.ilosisu, mlo.ilosisu);
                                        justification = generateAlignmentReason(plo.ilosisu, mlo.ilosisu, score);
                                    } catch (calcError) {
                                        console.warn("Could not calculate precise alignment, using default:", calcError);
                                    }
                                    
                                    moduleScores.push(score);
                                    moduleJustifications.push({
                                        mloIndex: mloIndex,
                                        score: score,
                                        justification: justification
                                    });
                                } catch (e) {
                                    console.error("Error processing MLO alignment:", e);
                                    moduleScores.push(1); // Default to minimal alignment on error
                                    moduleJustifications.push({
                                        mloIndex: mloIndex,
                                        score: 1,
                                        justification: "Error calculating alignment: " + e.message
                                    });
                                }
                            });
                            
                            // Calculate average score for the module (if there are any MLOs)
                            if (moduleScores.length > 0) {
                                const avg = moduleScores.reduce((acc, val) => acc + val, 0) / moduleScores.length;
                                moduleScore = Math.round(avg); // Rounded for display in matrix
                            }
                            
                            // Store results
                            alignmentResults[ploKey][moduleCode] = {
                                score: moduleScore,
                                individualScores: moduleScores,
                                justifications: moduleJustifications
                            };
                        });
                    });
                    
                    console.log("Alignment analysis complete");
                    return alignmentResults;
                } catch (error) {
                    console.error("Error in alignment analysis:", error);
                    return {}; // Return empty results on error
                }
            }
            
            // Function to display alignment matrix with all individual PLO-MLO scores
            function displayAlignmentMatrix(plos, moduleGroups, alignmentResults) {
                console.log("Displaying alignment matrix");
                const matrixContainer = document.getElementById('matrix-container');
                
                if (!matrixContainer) {
                    console.error("Matrix container element not found");
                    return;
                }
                
                matrixContainer.innerHTML = ''; // Clear existing content
                
                // Create a wrapper div with horizontal scroll
                const scrollWrapper = document.createElement('div');
                scrollWrapper.style.overflowX = 'auto';
                scrollWrapper.style.width = '100%';
                scrollWrapper.style.maxWidth = '100%';
                scrollWrapper.style.position = 'relative';
                
                // Define module order for display
                const moduleOrder = ['ylmlo', 'p1mlo', 'p2mlo', 'e1mlo', 'e2mlo', 'gdmlo'];
                
                // Define module names for headers
                const moduleNames = {
                    'ylmlo': 'General Studies Module',
                    'p1mlo': 'P1: Methods, Markets and Economy',
                    'p2mlo': 'P2: Core Business Competences',
                    'e1mlo': 'E1: Entrepreneurship and Marketing',
                    'e2mlo': 'E2: Finance and Accounting',
                    'gdmlo': 'Graduation Thesis Module'
                };
                
                // Build a flat structure to track all columns consistently
                const columns = [];
                
                // First, add a PLO label column
                columns.push({ type: 'label', id: 'plo-label' });
                
                // Then add all MLO columns and module average columns in order
                moduleOrder.forEach(moduleCode => {
                    if (!moduleGroups[moduleCode] || moduleGroups[moduleCode].length === 0) return;
                    
                    // Add individual MLO columns
                    moduleGroups[moduleCode].forEach((mlo, mloIndex) => {
                        columns.push({ 
                            type: 'mlo', 
                            moduleCode: moduleCode, 
                            index: mloIndex,
                            title: mlo.ilosisu
                        });
                    });
                    
                    // Add module average column
                    columns.push({ 
                        type: 'module-avg', 
                        moduleCode: moduleCode
                    });
                });
                
                // Add overall average column
                columns.push({ type: 'overall-avg' });
                
                // Create matrix table with fixed layout
                const table = document.createElement('table');
                table.className = 'matrix-table';
                table.style.tableLayout = 'fixed';
                table.style.borderCollapse = 'collapse';
                
                // Create header container
                const thead = document.createElement('thead');
                
                // Create module group header row
                const moduleHeaderRow = document.createElement('tr');
                
                // Add empty corner cell
                const cornerCell = document.createElement('th');
                cornerCell.className = 'matrix-corner';
                cornerCell.textContent = 'PLO / MLO';
                cornerCell.setAttribute('rowspan', '2');
                cornerCell.style.backgroundColor = '#e0e0e0';
                cornerCell.style.color = '#342b60';
                cornerCell.style.fontWeight = 'bold';
                cornerCell.style.border = '1px solid #aaa';
                cornerCell.style.position = 'sticky';
                cornerCell.style.left = '0';
                cornerCell.style.zIndex = '2';
                cornerCell.style.minWidth = '100px';
                moduleHeaderRow.appendChild(cornerCell);
                
                // Create column spans for module headers
                const moduleSpans = {};
                moduleOrder.forEach(moduleCode => {
                    moduleSpans[moduleCode] = 0;
                    
                    // Count columns for this module (MLOs + avg column)
                    if (moduleGroups[moduleCode]) {
                        moduleSpans[moduleCode] = moduleGroups[moduleCode].length + 1;
                    }
                });
                
                // Add module group headers
                moduleOrder.forEach(moduleCode => {
                    if (moduleSpans[moduleCode] === 0) return;
                    
                    const moduleHeader = document.createElement('th');
                    moduleHeader.setAttribute('colspan', moduleSpans[moduleCode]);
                    moduleHeader.style.backgroundColor = '#e0e0e0';
                    moduleHeader.style.color = '#342b60';
                    moduleHeader.style.textAlign = 'center';
                    moduleHeader.style.fontWeight = 'bold';
                    moduleHeader.style.border = '1px solid #aaa';
                    moduleHeader.textContent = moduleNames[moduleCode] || moduleCode.toUpperCase();
                    moduleHeaderRow.appendChild(moduleHeader);
                });
                
                // Add overall average header
                const overallHeader = document.createElement('th');
                overallHeader.setAttribute('rowspan', '2');
                overallHeader.style.backgroundColor = '#e4067e';
                overallHeader.style.color = 'white';
                overallHeader.style.textAlign = 'center';
                overallHeader.style.fontWeight = 'bold';
                overallHeader.style.border = '1px solid #aaa';
                overallHeader.textContent = 'Avg';
                moduleHeaderRow.appendChild(overallHeader);
                
                thead.appendChild(moduleHeaderRow);
                
                // Create MLO sub-header row
                const mloHeaderRow = document.createElement('tr');
                
                // Add MLO and avg column headers
                moduleOrder.forEach(moduleCode => {
                    if (!moduleGroups[moduleCode]) return;
                    
                    // Add individual MLO headers
                    moduleGroups[moduleCode].forEach((mlo, mloIndex) => {
                        const mloHeader = document.createElement('th');
                        mloHeader.textContent = `${moduleCode.toUpperCase()} ${mloIndex + 1}`;
                        mloHeader.title = mlo.ilosisu.substring(0, 100) + (mlo.ilosisu.length > 100 ? '...' : '');
                        mloHeader.style.minWidth = '60px';
                        mloHeader.style.border = '1px solid #bbb';
                        mloHeaderRow.appendChild(mloHeader);
                    });
                    
                    // Add module average header
                    const moduleAvgHeader = document.createElement('th');
                    moduleAvgHeader.textContent = `${moduleCode.toUpperCase()} Avg`;
                    moduleAvgHeader.title = `Average alignment for ${moduleNames[moduleCode]}`;
                    moduleAvgHeader.style.backgroundColor = '#e0e0e0';
                    moduleAvgHeader.style.color = '#342b60';
                    moduleAvgHeader.style.border = '1px solid #aaa';
                    moduleAvgHeader.style.fontWeight = 'bold';
                    mloHeaderRow.appendChild(moduleAvgHeader);
                });
                
                thead.appendChild(mloHeaderRow);
                table.appendChild(thead);
                
                // Create table body
                const tbody = document.createElement('tbody');
                
                // Setup score tracking
                const mloTotalScores = {};
                const mloScoreCounts = {};
                
                // Initialize MLO tracking
                moduleOrder.forEach(moduleCode => {
                    if (!moduleGroups[moduleCode]) return;
                    
                    moduleGroups[moduleCode].forEach((_, mloIndex) => {
                        const mloKey = `${moduleCode}-${mloIndex}`;
                        mloTotalScores[mloKey] = 0;
                        mloScoreCounts[mloKey] = 0;
                    });
                });
                
                // Create rows for each PLO
                plos.forEach((plo, ploIndex) => {
                    const row = document.createElement('tr');
                    
                    // Add PLO label cell
                    const ploLabelCell = document.createElement('th');
                    ploLabelCell.textContent = `PLO ${ploIndex + 1}`;
                    ploLabelCell.title = plo.ilosisu;
                    ploLabelCell.style.position = 'sticky';
                    ploLabelCell.style.left = '0';
                    ploLabelCell.style.backgroundColor = '#e0e0e0';
                    ploLabelCell.style.color = '#342b60';
                    ploLabelCell.style.zIndex = '1';
                    ploLabelCell.style.textAlign = 'center';
                    ploLabelCell.style.padding = '6px';
                    ploLabelCell.style.border = '1px solid #aaa';
                    row.appendChild(ploLabelCell);
                    
                    // Track scores for this row
                    let rowTotalScore = 0;
                    let rowScoreCount = 0;
                    
                    // Track module scores
                    const moduleScores = {};
                    moduleOrder.forEach(moduleCode => {
                        moduleScores[moduleCode] = { total: 0, count: 0 };
                    });
                    
                    // Add data cells in the same order as headers
                    moduleOrder.forEach(moduleCode => {
                        if (!moduleGroups[moduleCode]) return;
                        
                        const ploKey = `plo-${ploIndex}`;
                        const moduleResult = alignmentResults[ploKey][moduleCode];
                        
                        // Add cells for individual MLOs in this module
                        moduleGroups[moduleCode].forEach((mlo, mloIndex) => {
                            // Find score for this PLO-MLO pair
                            const justification = moduleResult.justifications.find(j => j.mloIndex === mloIndex) || 
                                { score: 1, justification: 'Minimal alignment detected' };
                            
                            // Track scores
                            rowTotalScore += justification.score;
                            rowScoreCount++;
                            
                            // Update module scores
                            moduleScores[moduleCode].total += justification.score;
                            moduleScores[moduleCode].count++;
                            
                            // Update column totals
                            const mloKey = `${moduleCode}-${mloIndex}`;
                            mloTotalScores[mloKey] += justification.score;
                            mloScoreCounts[mloKey]++;
                            
                            // Create score cell
                            const scoreCell = document.createElement('td');
                            scoreCell.className = `score-${justification.score}`;
                            scoreCell.style.textAlign = 'center';
                            scoreCell.style.padding = '6px';
                            scoreCell.style.fontWeight = 'bold';
                            scoreCell.style.color = '#000000';
                            scoreCell.style.cursor = 'pointer';
                            scoreCell.style.border = '1px solid #ddd';
                            scoreCell.textContent = justification.score;
                            scoreCell.title = justification.justification;
                            
                            // Add click navigation
                            scoreCell.addEventListener('click', function() {
                                const toggleBtn = document.getElementById('toggle-view-btn');
                                if (toggleBtn && toggleBtn.dataset.view === 'mlo') {
                                    toggleBtn.click(); // Switch to PLO view if needed
                                }
                                
                                const targetElement = document.getElementById(`plo-${ploIndex}-${moduleCode}`);
                                if (targetElement) {
                                    targetElement.scrollIntoView({ behavior: 'smooth' });
                                    targetElement.classList.add('highlight-section');
                                    setTimeout(() => targetElement.classList.remove('highlight-section'), 2000);
                                }
                            });
                            
                            row.appendChild(scoreCell);
                        });
                        
                        // Add module average cell
                        if (moduleScores[moduleCode].count > 0) {
                            const moduleAvg = moduleScores[moduleCode].total / moduleScores[moduleCode].count;
                            const roundedModuleAvg = Math.round(moduleAvg);
                            const exactModuleAvg = moduleAvg.toFixed(2);
                            
                            const avgCell = document.createElement('td');
                            avgCell.className = `score-${roundedModuleAvg}`;
                            avgCell.style.fontWeight = 'bold';
                            avgCell.style.backgroundColor = '#e0e0e0';
                            avgCell.style.border = '1px solid #aaa';
                            avgCell.style.textAlign = 'center';
                            avgCell.style.color = '#000000';
                            avgCell.textContent = exactModuleAvg;
                            avgCell.title = `Average score for PLO ${ploIndex + 1} across ${moduleNames[moduleCode]}`;
                            
                            row.appendChild(avgCell);
                        } else {
                            const emptyCell = document.createElement('td');
                            emptyCell.textContent = '-';
                            emptyCell.style.backgroundColor = '#e0e0e0';
                            emptyCell.style.border = '1px solid #aaa';
                            emptyCell.style.textAlign = 'center';
                            
                            row.appendChild(emptyCell);
                        }
                    });
                    
                    // Add overall average for this row
                    const rowAvg = rowScoreCount > 0 ? rowTotalScore / rowScoreCount : 0;
                    const roundedRowAvg = Math.round(rowAvg);
                    const exactRowAvg = rowAvg.toFixed(2);
                    
                    const overallAvgCell = document.createElement('td');
                    overallAvgCell.className = `score-${roundedRowAvg}`;
                    overallAvgCell.style.fontWeight = 'bold';
                    overallAvgCell.style.textAlign = 'center';
                    overallAvgCell.style.color = '#000000';
                    overallAvgCell.style.border = '1px solid #aaa';
                    overallAvgCell.textContent = exactRowAvg;
                    overallAvgCell.title = `Overall average for PLO ${ploIndex + 1}`;
                    
                    row.appendChild(overallAvgCell);
                    tbody.appendChild(row);
                });
                
                // Add average row at the bottom
                const avgRow = document.createElement('tr');
                
                // Add label for average row
                const avgLabel = document.createElement('th');
                avgLabel.textContent = 'Avg';
                avgLabel.style.backgroundColor = '#e4067e';
                avgLabel.style.color = 'white';
                avgLabel.style.textAlign = 'center';
                avgLabel.style.fontWeight = 'bold';
                avgLabel.style.border = '1px solid #aaa';
                avgLabel.style.position = 'sticky';
                avgLabel.style.left = '0';
                avgRow.appendChild(avgLabel);
                
                // Add column averages in the same order
                moduleOrder.forEach(moduleCode => {
                    if (!moduleGroups[moduleCode]) return;
                    
                    // Add individual MLO column averages
                    moduleGroups[moduleCode].forEach((mlo, mloIndex) => {
                        const mloKey = `${moduleCode}-${mloIndex}`;
                        const colAvg = mloScoreCounts[mloKey] > 0 
                            ? mloTotalScores[mloKey] / mloScoreCounts[mloKey] 
                            : 0;
                        const roundedColAvg = Math.round(colAvg);
                        const exactColAvg = colAvg.toFixed(2);
                        
                        const colAvgCell = document.createElement('td');
                        colAvgCell.className = `score-${roundedColAvg}`;
                        colAvgCell.style.fontWeight = 'bold';
                        colAvgCell.style.textAlign = 'center';
                        colAvgCell.style.color = '#000000';
                        colAvgCell.style.border = '1px solid #aaa';
                        colAvgCell.textContent = exactColAvg;
                        colAvgCell.title = `Average score for ${moduleCode.toUpperCase()} ${mloIndex + 1}`;
                        
                        avgRow.appendChild(colAvgCell);
                    });
                    
                    // Add module average cell
                    let moduleTotalScore = 0;
                    let moduleScoreCount = 0;
                    
                    moduleGroups[moduleCode].forEach((_, mloIndex) => {
                        const mloKey = `${moduleCode}-${mloIndex}`;
                        if (mloScoreCounts[mloKey] > 0) {
                            moduleTotalScore += mloTotalScores[mloKey];
                            moduleScoreCount += mloScoreCounts[mloKey];
                        }
                    });
                    
                    const moduleAvg = moduleScoreCount > 0 ? moduleTotalScore / moduleScoreCount : 0;
                    const roundedModuleAvg = Math.round(moduleAvg);
                    const exactModuleAvg = moduleAvg.toFixed(2);
                    
                    const moduleAvgCell = document.createElement('td');
                    moduleAvgCell.className = `score-${roundedModuleAvg}`;
                    moduleAvgCell.style.fontWeight = 'bold';
                    moduleAvgCell.style.backgroundColor = '#aaaaaa';
                    moduleAvgCell.style.color = '#000000';
                    moduleAvgCell.style.textAlign = 'center';
                    moduleAvgCell.style.border = '1px solid #aaa';
                    moduleAvgCell.textContent = exactModuleAvg;
                    moduleAvgCell.title = `Average for all ${moduleNames[moduleCode]}`;
                    
                    avgRow.appendChild(moduleAvgCell);
                });
                
                // Calculate overall average
                let overallTotal = 0;
                let overallCount = 0;
                
                Object.keys(mloTotalScores).forEach(key => {
                    overallTotal += mloTotalScores[key];
                    overallCount += mloScoreCounts[key];
                });
                
                const overallAvg = overallCount > 0 ? overallTotal / overallCount : 0;
                
                // Add overall average cell
                const overallAvgCell = document.createElement('td');
                overallAvgCell.style.backgroundColor = '#342b60';
                overallAvgCell.style.color = 'white';
                overallAvgCell.style.fontWeight = 'bold';
                overallAvgCell.style.textAlign = 'center';
                overallAvgCell.style.border = '1px solid #aaa';
                overallAvgCell.textContent = overallAvg.toFixed(2);
                overallAvgCell.title = 'Overall average alignment score';
                
                avgRow.appendChild(overallAvgCell);
                tbody.appendChild(avgRow);
                
                table.appendChild(tbody);
                scrollWrapper.appendChild(table);
                matrixContainer.appendChild(scrollWrapper);
                
                // Add button to download matrix as Excel
                const exportButton = document.querySelector('#export-excel-btn');
                if (exportButton) {
                    exportButton.addEventListener('click', function() {
                        exportMatrixToExcel(table, moduleOrder, moduleNames, moduleGroups, plos);
                    });
                }
            }
            
            // Function to export matrix to Excel
            function exportMatrixToExcel(table, moduleOrder, moduleNames, moduleGroups, plos) {
                // Create a workbook with a worksheet
                let csv = '';
                
                // Add header row with module names
                csv += 'PLO / MLO,';
                
                // Add MLO headers
                moduleOrder.forEach(moduleCode => {
                    if (!moduleGroups[moduleCode]) return;
                    
                    // Add each MLO column header
                    moduleGroups[moduleCode].forEach((_, mloIndex) => {
                        csv += `${moduleCode.toUpperCase()} ${mloIndex + 1},`;
                    });
                    
                    // Add module average column
                    csv += `${moduleCode.toUpperCase()} Avg,`;
                });
                
                // Add overall average column
                csv += 'Overall Avg\n';
                
                // Add data rows for each PLO
                plos.forEach((plo, ploIndex) => {
                    csv += `PLO ${ploIndex + 1},`;
                    
                    // Get all cell values from the table
                    const rows = table.querySelectorAll('tbody tr');
                    const dataRow = rows[ploIndex];
                    const cells = dataRow.querySelectorAll('td');
                    
                    cells.forEach(cell => {
                        csv += `${cell.textContent},`;
                    });
                    
                    csv += '\n';
                });
                
                // Add average row
                csv += 'Avg,';
                
                const lastRow = table.querySelector('tbody tr:last-child');
                const avgCells = lastRow.querySelectorAll('td');
                avgCells.forEach(cell => {
                    csv += `${cell.textContent},`;
                });
                
                // Generate download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'PLO_MLO_Matrix.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            // Function to show all MLOs in a module
            function showModuleMLOs(moduleCode, moduleMLOs) {
                // Remove any existing popups
                const existingPopup = document.getElementById('module-mlos-popup');
                if (existingPopup) {
                    existingPopup.remove();
                }
                
                // Create popup container
                const popup = document.createElement('div');
                popup.id = 'module-mlos-popup';
                popup.style.position = 'fixed';
                popup.style.top = '50%';
                popup.style.left = '50%';
                popup.style.transform = 'translate(-50%, -50%)';
                popup.style.backgroundColor = 'white';
                popup.style.padding = '20px';
                popup.style.borderRadius = '8px';
                popup.style.boxShadow = '0 0 20px rgba(0,0,0,0.3)';
                popup.style.zIndex = '1000';
                popup.style.width = '80vw';
                popup.style.maxHeight = '80vh';
                popup.style.overflow = 'auto';
                
                // Create close button
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '<i class="fas fa-times"></i>';
                closeBtn.style.position = 'absolute';
                closeBtn.style.top = '10px';
                closeBtn.style.right = '10px';
                closeBtn.style.background = 'none';
                closeBtn.style.border = 'none';
                closeBtn.style.fontSize = '1.2rem';
                closeBtn.style.cursor = 'pointer';
                closeBtn.addEventListener('click', () => popup.remove());
                
                popup.appendChild(closeBtn);
                
                // Get module name
                const moduleNames = {
                    'ylmlo': 'General Studies Module - Foundational Competences',
                    'p1mlo': 'Core Studies Module - P1 Methods, Markets and Economy',
                    'p2mlo': 'Core Studies Module - P2 Core Business Competences',
                    'e1mlo': 'Special Studies Module - E1 Entrepreneurship and Marketing',
                    'e2mlo': 'Special Studies Module - E2 Finance and Accounting',
                    'gdmlo': 'Graduation Thesis Module'
                };
                
                // Create title
                const title = document.createElement('h3');
                title.textContent = `${moduleNames[moduleCode] || moduleCode.toUpperCase()}`;
                title.style.marginBottom = '15px';
                popup.appendChild(title);
                
                // Create list of MLOs
                const mloList = document.createElement('div');
                
                // Add each MLO
                moduleMLOs.forEach((mlo, index) => {
                    const mloItem = document.createElement('div');
                    mloItem.className = 'outcome-item';
                    mloItem.style.margin = '10px 0';
                    
                    mloItem.innerHTML = `
                        <h4>${moduleCode.toUpperCase()} ${index + 1}</h4>
                        <p>${mlo.ilosisu}</p>
                    `;
                    
                    mloList.appendChild(mloItem);
                });
                
                popup.appendChild(mloList);
                
                // Add overlay
                const overlay = document.createElement('div');
                overlay.style.position = 'fixed';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                overlay.style.zIndex = '999';
                overlay.addEventListener('click', () => {
                    overlay.remove();
                    popup.remove();
                });
                
                // Add to DOM
                document.body.appendChild(overlay);
                document.body.appendChild(popup);
            }
            
            // Function to show detailed scores for a specific PLO-Module pair

            function showDetailedScores(ploIndex, moduleCode, moduleResult, moduleMLOs) {
                // Remove any existing popups
                const existingPopup = document.getElementById('detailed-scores-popup');
                if (existingPopup) {
                    existingPopup.remove();
                }
                
                // Create popup container
                const popup = document.createElement('div');
                popup.id = 'detailed-scores-popup';
                popup.style.position = 'fixed';
                popup.style.top = '50%';
                popup.style.left = '50%';
                popup.style.transform = 'translate(-50%, -50%)';
                popup.style.backgroundColor = 'white';
                popup.style.padding = '20px';
                popup.style.borderRadius = '8px';
                popup.style.boxShadow = '0 0 20px rgba(0,0,0,0.3)';
                popup.style.zIndex = '1000';
                popup.style.maxWidth = '80vw';
                popup.style.maxHeight = '80vh';
                popup.style.overflow = 'auto';
                
                // Create close button
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '<i class="fas fa-times"></i>';
                closeBtn.style.position = 'absolute';
                closeBtn.style.top = '10px';
                closeBtn.style.right = '10px';
                closeBtn.style.background = 'none';
                closeBtn.style.border = 'none';
                closeBtn.style.fontSize = '1.2rem';
                closeBtn.style.cursor = 'pointer';
                closeBtn.addEventListener('click', () => popup.remove());
                
                popup.appendChild(closeBtn);
                
                // Create title
                const title = document.createElement('h3');
                title.textContent = `Detailed Alignment Scores: PLO ${ploIndex + 1} × ${moduleCode.toUpperCase()}`;
                title.style.marginBottom = '15px';
                popup.appendChild(title);
                
                // Create table for detailed scores
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.tableLayout = 'auto';  // Auto layout for better content distribution
                table.style.borderCollapse = 'collapse';
                
                // Add header row
                const headerRow = document.createElement('tr');
                
                const headers = ['MLO', 'Score', 'Justification'];
                headers.forEach((headerText, idx) => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    th.style.padding = '10px';
                    th.style.textAlign = idx === 1 ? 'center' : 'left';
                    th.style.borderBottom = '2px solid #342b60';
                    
                    // Set appropriate width for each column
                    if (idx === 0) {
                        th.style.width = '25%';
                        th.style.minWidth = '200px';
                    } else if (idx === 1) {
                        th.style.width = '10%';
                        th.style.minWidth = '80px';
                    } else {
                        th.style.width = '65%';
                    }
                    
                    headerRow.appendChild(th);
                });
                
                table.appendChild(headerRow);
                
                // Add rows for each MLO
                moduleResult.justifications.forEach((justification, index) => {
                    if (index >= moduleMLOs.length) return;
                    
                    const mlo = moduleMLOs[index];
                    const row = document.createElement('tr');
                    
                    // MLO cell
                    const mloCell = document.createElement('td');
                    mloCell.innerHTML = `<strong>${moduleCode.toUpperCase()} ${justification.mloIndex + 1}:</strong> ${mlo.ilosisu.substring(0, 100)}${mlo.ilosisu.length > 100 ? '...' : ''}`;
                    mloCell.style.padding = '10px';
                    mloCell.style.width = '30%';
                    mloCell.style.borderBottom = '1px solid #ddd';
                    row.appendChild(mloCell);
                    
                    // Score cell
                    const scoreCell = document.createElement('td');
                    scoreCell.textContent = `${justification.score}/5`;
                    scoreCell.className = `score-${justification.score}`;
                    scoreCell.style.padding = '10px';
                    scoreCell.style.color = '#000000'; // Black text color for better contrast
                    scoreCell.style.fontWeight = 'bold';
                    scoreCell.style.width = '10%';
                    scoreCell.style.textAlign = 'center';
                    scoreCell.style.borderBottom = '1px solid #ddd';
                    row.appendChild(scoreCell);
                    
                    // Justification cell
                    const justificationCell = document.createElement('td');
                    justificationCell.textContent = justification.justification;
                    justificationCell.style.padding = '10px';
                    justificationCell.style.width = '60%';
                    justificationCell.style.borderBottom = '1px solid #ddd';
                    row.appendChild(justificationCell);
                    
                    table.appendChild(row);
                });
                
                popup.appendChild(table);
                
                // Add overlay
                const overlay = document.createElement('div');
                overlay.style.position = 'fixed';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                overlay.style.zIndex = '999';
                overlay.addEventListener('click', () => {
                    overlay.remove();
                    popup.remove();
                });
                
                // Add to DOM
                document.body.appendChild(overlay);
                document.body.appendChild(popup);
            }
            
            // Function to display detailed analysis
            function displayDetailedAnalysis(plos, moduleGroups, alignmentResults) {
                console.log("Displaying detailed analysis");
                const detailedContainer = document.getElementById('detailed-container');
                
                if (!detailedContainer) {
                    console.error("Detailed container element not found");
                    return;
                }
                
                // Clear existing content
                detailedContainer.innerHTML = '';
                
                // Create single toggle button for switching between views
                const toggleContainer = document.createElement('div');
                toggleContainer.className = 'view-toggle-container';
                toggleContainer.style.textAlign = 'center';
                toggleContainer.style.marginBottom = '20px';
                
                const toggleButton = document.createElement('button');
                toggleButton.id = 'toggle-view-btn';
                toggleButton.className = 'toggle-btn';
                toggleButton.innerHTML = '<i class="fas fa-exchange-alt"></i> Switch to MLO View';
                toggleButton.dataset.view = 'plo'; // Track current view
                
                toggleContainer.appendChild(toggleButton);
                detailedContainer.appendChild(toggleContainer);
                
                // Create view containers
                const ploViewContainer = document.createElement('div');
                ploViewContainer.id = 'plo-view-container';
                ploViewContainer.style.display = 'block';
                
                const mloViewContainer = document.createElement('div');
                mloViewContainer.id = 'mlo-view-container';
                mloViewContainer.style.display = 'none';
                
                detailedContainer.appendChild(ploViewContainer);
                detailedContainer.appendChild(mloViewContainer);
                
                // Add event listener for toggle button
                toggleButton.addEventListener('click', function() {
                    if (this.dataset.view === 'plo') {
                        // Switch to MLO view
                        ploViewContainer.style.display = 'none';
                        mloViewContainer.style.display = 'block';
                        this.innerHTML = '<i class="fas fa-exchange-alt"></i> Switch to PLO View';
                        this.dataset.view = 'mlo';
                    } else {
                        // Switch to PLO view
                        ploViewContainer.style.display = 'block';
                        mloViewContainer.style.display = 'none';
                        this.innerHTML = '<i class="fas fa-exchange-alt"></i> Switch to MLO View';
                        this.dataset.view = 'plo';
                    }
                });
                
                // Create a main container with max-width constraint for PLO view
                const ploMainContainer = document.createElement('div');
                ploMainContainer.style.maxWidth = '1200px';
                ploMainContainer.style.margin = '0 auto';
                
                // Define module order and names for display
                const moduleOrder = ['ylmlo', 'p1mlo', 'p2mlo', 'e1mlo', 'e2mlo', 'gdmlo'];
                const moduleNames = {
                    'ylmlo': 'General Studies Module - Foundational Competences',
                    'p1mlo': 'Core Studies Module - P1 Methods, Markets and Economy',
                    'p2mlo': 'Core Studies Module - P2 Core Business Competences',
                    'e1mlo': 'Special Studies Module - E1 Entrepreneurship and Marketing',
                    'e2mlo': 'Special Studies Module - E2 Finance and Accounting',
                    'gdmlo': 'Graduation Thesis Module'
                };
                
                // 1. Generate PLO view (original view)
                plos.forEach((plo, ploIndex) => {
                    const ploKey = `plo-${ploIndex}`;
                    
                    // Create PLO section
                    const ploSection = document.createElement('div');
                    ploSection.className = 'plo-section';
                    ploSection.id = `plo-${ploIndex}`;
                    ploSection.innerHTML = `
                        <h3>PLO ${ploIndex + 1}</h3>
                        <div class="outcome-item">
                            <p>${plo.ilosisu}</p>
                        </div>
                    `;
                    
                    // Add module sections for this PLO
                    moduleOrder.forEach(moduleCode => {
                        if (!moduleGroups[moduleCode] || !alignmentResults[ploKey][moduleCode]) return;
                        
                        const moduleResult = alignmentResults[ploKey][moduleCode];
                        const moduleMLOs = moduleGroups[moduleCode];
                        
                        // Create module section
                        const moduleSection = document.createElement('div');
                        moduleSection.className = 'alignment-item';
                        moduleSection.id = `plo-${ploIndex}-${moduleCode}`;
                        
                        // Calculate accurate average to two decimal points for display
                        const accurateAvg = moduleResult.individualScores.length > 0 
                            ? (moduleResult.individualScores.reduce((acc, val) => acc + val, 0) / moduleResult.individualScores.length).toFixed(2)
                            : "0.00";
                        
                        // Create module header with the module name
                        const moduleHeader = document.createElement('div');
                        moduleHeader.className = 'alignment-header';
                        
                        // Create the module name header
                        const titleRow = document.createElement('div');
                        titleRow.className = 'alignment-title-row';
                        titleRow.innerHTML = `<div class="alignment-title">${moduleNames[moduleCode] || moduleCode.toUpperCase()}</div>`;
                        
                        // Create score row
                        const scoreRow = document.createElement('div');
                        scoreRow.className = 'alignment-score-row';
                        scoreRow.innerHTML = `<div class="alignment-score score-${moduleResult.score}">Score: ${accurateAvg}/5</div>`;
                        
                        // Add to module header
                        moduleHeader.appendChild(titleRow);
                        moduleHeader.appendChild(scoreRow);
                        moduleSection.appendChild(moduleHeader);
                        
                        // Add module details with simpler structure (no table)
                        const moduleDetails = document.createElement('div');
                        moduleDetails.className = 'alignment-details';
                        
                        // Add each MLO alignment as individual sections
                        moduleResult.justifications.forEach((justification, idx) => {
                            if (idx >= moduleMLOs.length) return;
                            
                            const mlo = moduleMLOs[idx];
                            
                            // Create alignment detail container
                            const alignmentDetail = document.createElement('div');
                            alignmentDetail.className = 'alignment-detail-item';
                            alignmentDetail.style.marginBottom = '20px';
                            alignmentDetail.style.borderBottom = '1px solid #eee';
                            alignmentDetail.style.paddingBottom = '15px';
                            
                            // Create MLO section
                            const mloSection = document.createElement('div');
                            mloSection.className = 'alignment-mlo';
                            mloSection.style.marginBottom = '10px';
                            mloSection.innerHTML = `
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                    <strong style="font-size:1.1em;">${moduleCode.toUpperCase()} ${justification.mloIndex + 1}</strong>
                                    <span class="score-badge score-${justification.score}" style="padding:3px 10px; border-radius:12px; font-weight:bold;">Score: ${justification.score}/5</span>
                                </div>
                                <p style="margin:5px 0;">${mlo.ilosisu}</p>
                            `;
                            
                            // Create justification section
                            const justificationSection = document.createElement('div');
                            justificationSection.className = 'alignment-reason';
                            justificationSection.style.backgroundColor = '#f9f9f9';
                            justificationSection.style.padding = '10px';
                            justificationSection.style.borderRadius = '5px';
                            justificationSection.style.marginBottom = '10px';
                            justificationSection.innerHTML = `
                                <strong>Justification:</strong>
                                <p>${justification.justification}</p>
                            `;
                            
                            alignmentDetail.appendChild(mloSection);
                            alignmentDetail.appendChild(justificationSection);
                            
                            // If score is low, add improvement suggestion
                            if (justification.score < 3) {
                                const suggestion = generateImprovementSuggestion(plo.ilosisu, mlo.ilosisu);
                                const suggestionSection = document.createElement('div');
                                suggestionSection.className = 'alignment-suggestion';
                                suggestionSection.innerHTML = `
                                    <strong><i class="fas fa-lightbulb"></i> Improvement Suggestion:</strong>
                                    <p>${suggestion}</p>
                                `;
                                alignmentDetail.appendChild(suggestionSection);
                            }
                            
                            moduleDetails.appendChild(alignmentDetail);
                        });
                        
                        moduleSection.appendChild(moduleDetails);
                        ploSection.appendChild(moduleSection);
                    });
                    
                    ploMainContainer.appendChild(ploSection);
                });
                
                // 2. Generate MLO view (new alternate view)
                const mloMainContainer = document.createElement('div');
                mloMainContainer.style.maxWidth = '1200px';
                mloMainContainer.style.margin = '0 auto';
                
                // Create sections for each module category
                moduleOrder.forEach(moduleCode => {
                    if (!moduleGroups[moduleCode]) return;
                    
                    const moduleMLOs = moduleGroups[moduleCode];
                    
                    // Create a module section
                    const moduleSection = document.createElement('div');
                    moduleSection.className = 'module-section-view';
                    moduleSection.style.marginBottom = '40px';
                    
                    // Add module header
                    const moduleHeader = document.createElement('h3');
                    moduleHeader.className = 'module-header';
                    moduleHeader.style.backgroundColor = '#342b60';
                    moduleHeader.style.color = 'white';
                    moduleHeader.style.padding = '10px 15px';
                    moduleHeader.style.marginBottom = '15px';
                    moduleHeader.style.borderRadius = '5px';
                    moduleHeader.innerHTML = moduleNames[moduleCode] || moduleCode.toUpperCase();
                    moduleSection.appendChild(moduleHeader);
                    
                    // For each MLO in this module
                    moduleMLOs.forEach((mlo, mloIndex) => {
                        const mloDiv = document.createElement('div');
                        mloDiv.className = 'mlo-item';
                        mloDiv.style.marginBottom = '30px';
                        mloDiv.style.border = '1px solid #ddd';
                        mloDiv.style.borderRadius = '8px';
                        mloDiv.style.overflow = 'hidden';
                        
                        // MLO header
                        const mloHeader = document.createElement('div');
                        mloHeader.className = 'mlo-header';
                        mloHeader.style.backgroundColor = '#342b60';
                        mloHeader.style.color = 'white';
                        mloHeader.style.padding = '10px 15px';
                        mloHeader.innerHTML = `
                            <h4 style="margin:0;">${moduleCode.toUpperCase()} ${mloIndex + 1}</h4>
                            <div style="font-size: 0.9em; margin-top: 4px; opacity: 0.9;">Module Learning Outcome</div>
                        `;
                        
                        // MLO content
                        const mloContent = document.createElement('div');
                        mloContent.className = 'mlo-content';
                        mloContent.style.padding = '15px';
                        mloContent.innerHTML = `<p>${mlo.ilosisu}</p>`;
                        
                        // Add alignment details with PLOs
                        const alignmentsDiv = document.createElement('div');
                        alignmentsDiv.className = 'plo-alignments';
                        alignmentsDiv.style.padding = '0 15px 15px';
                        
                        // Add title for alignments
                        const alignmentsTitle = document.createElement('h5');
                        alignmentsTitle.textContent = 'Alignment with Programme Learning Outcomes';
                        alignmentsTitle.style.backgroundColor = '#f5f5f5';
                        alignmentsTitle.style.padding = '8px 12px';
                        alignmentsTitle.style.borderRadius = '4px';
                        alignmentsTitle.style.marginBottom = '10px';
                        alignmentsTitle.style.color = '#342b60';
                        alignmentsTitle.style.fontWeight = 'bold';
                        alignmentsDiv.appendChild(alignmentsTitle);
                        
                        // Calculate average alignment score for this MLO across all PLOs
                        let totalScore = 0;
                        let scoreCount = 0;
                        
                        // Add each PLO alignment
                        plos.forEach((plo, ploIndex) => {
                            const ploKey = `plo-${ploIndex}`;
                            
                            if (!alignmentResults[ploKey][moduleCode]) return;
                            
                            const justification = alignmentResults[ploKey][moduleCode].justifications.find(j => j.mloIndex === mloIndex);
                            
                            if (!justification) return;
                            
                            // Add to score calculation
                            totalScore += justification.score;
                            scoreCount++;
                            
                            // Create alignment item
                            const alignmentDiv = document.createElement('div');
                            alignmentDiv.className = 'plo-alignment-item';
                            alignmentDiv.style.marginBottom = '15px';
                            alignmentDiv.style.paddingBottom = '15px';
                            alignmentDiv.style.borderBottom = '1px solid #eee';
                            
                            // PLO header with score
                            alignmentDiv.innerHTML = `
                                <table class="detail-table" style="width:100%; border-collapse:collapse; margin-bottom:10px;">
                                    <thead>
                                        <tr>
                                            <th style="padding:8px; text-align:left; border-bottom:2px solid #342b60; width:70%;">PLO ${ploIndex + 1}</th>
                                            <th style="padding:8px; text-align:center; border-bottom:2px solid #342b60; width:30%;">
                                                <span class="score-badge score-${justification.score}" 
                                                    style="padding:3px 8px; border-radius:12px; font-weight:bold;">
                                                    Score: ${justification.score}/5
                                                </span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="2" style="padding:8px; border-bottom:1px solid #eee; font-style:italic;">${plo.ilosisu}</td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" style="padding:8px; background-color:#f9f9f9;">
                                                <strong>Justification:</strong>
                                                <p>${justification.justification}</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                            
                            // Add improvement suggestion for low scores
                            if (justification.score < 3) {
                                const suggestion = generateImprovementSuggestion(plo.ilosisu, mlo.ilosisu);
                                const suggestionDiv = document.createElement('div');
                                suggestionDiv.className = 'alignment-suggestion';
                                suggestionDiv.style.marginTop = '10px';
                                suggestionDiv.innerHTML = `
                                    <strong><i class="fas fa-lightbulb"></i> Improvement Suggestion:</strong>
                                    <p>${suggestion}</p>
                                `;
                                alignmentDiv.appendChild(suggestionDiv);
                            }
                            
                            alignmentsDiv.appendChild(alignmentDiv);
                        });
                        
                        // Add average score display
                        if (scoreCount > 0) {
                            const avgScore = (totalScore / scoreCount).toFixed(2);
                            const roundedAvg = Math.round(avgScore);
                            
                            const avgDiv = document.createElement('div');
                            avgDiv.className = `average-score score-${roundedAvg}`;
                            avgDiv.style.textAlign = 'center';
                            avgDiv.style.padding = '10px';
                            avgDiv.style.marginTop = '15px';
                            avgDiv.style.fontWeight = 'bold';
                            avgDiv.innerHTML = `Average Alignment Score: ${avgScore}/5`;
                            
                            alignmentsDiv.appendChild(avgDiv);
                        }
                        
                        // Assemble MLO item
                        mloDiv.appendChild(mloHeader);
                        mloDiv.appendChild(mloContent);
                        mloDiv.appendChild(alignmentsDiv);
                        moduleSection.appendChild(mloDiv);
                    });
                    
                    mloMainContainer.appendChild(moduleSection);
                });
                
                // Function to calculate alignment score between PLO and MLO text
                function calculateAlignmentScore(ploText, mloText) {
                    // Extract keywords from both texts
                    const ploKeywords = extractKeywords(ploText);
                    const mloKeywords = extractKeywords(mloText);
                    
                    // Calculate overlap between keywords
                    const overlap = calculateOverlap(ploKeywords, mloKeywords);
                    
                    // Calculate semantic similarity
                    const semanticSimilarity = calculateSemanticSimilarity(ploText, mloText);
                    
                    // Combined score (weighted average of overlap and semantic similarity)
                    const combinedScore = Math.round((0.6 * overlap + 0.4 * semanticSimilarity) * 5) / 1;
                    
                    // Ensure score is between 1 and 5
                    return Math.max(1, Math.min(5, combinedScore));
                }
                
                // Helper function to extract keywords from text
                function extractKeywords(text) {
                    // Convert to lowercase
                    const lowercaseText = text.toLowerCase();
                    
                    // Define business-related keywords and categories
                    const businessKeywords = {
                        strategic: ["strategic", "strategy", "vision", "mission", "goal", "objective", "plan", "roadmap"],
                        management: ["management", "leadership", "administration", "governance", "supervision", "coordination"],
                        analysis: ["analysis", "evaluate", "assess", "examine", "investigate", "research", "study", "analyze"],
                        finance: ["finance", "financial", "accounting", "budget", "cost", "revenue", "profit", "expense", "investment"],
                        marketing: ["marketing", "market", "customer", "consumer", "brand", "product", "service", "promotion", "advertising"],
                        sustainability: ["sustainability", "sustainable", "environmental", "social", "ethical", "responsible", "green", "eco-friendly"],
                        innovation: ["innovation", "innovative", "creative", "creation", "develop", "development", "design", "redesign"],
                        communication: ["communication", "communicate", "express", "articulate", "present", "presentation", "report"],
                        problemSolving: ["problem", "challenge", "solution", "resolve", "solve", "addressing", "mitigate", "alleviate"],
                        teamwork: ["team", "group", "collaboration", "collaborative", "cooperation", "coordinate", "assemble", "lead"]
                    };
                    
                    // Check for presence of keywords in each category
                    const keywordPresence = {};
                    Object.keys(businessKeywords).forEach(category => {
                        keywordPresence[category] = businessKeywords[category].some(keyword => 
                            lowercaseText.includes(keyword) || 
                            lowercaseText.includes(keyword + "s") || // Simple plurals
                            lowercaseText.includes(keyword + "es") ||
                            lowercaseText.includes(keyword + "ing") || // Simple verb forms
                            lowercaseText.includes(keyword + "ed")
                        );
                    });
                    
                    return keywordPresence;
                }
                
                // Helper function to calculate overlap between two keyword sets
                function calculateOverlap(keywords1, keywords2) {
                    let overlapCount = 0;
                    const totalCategories = Object.keys(keywords1).length;
                    
                    Object.keys(keywords1).forEach(category => {
                        if (keywords1[category] && keywords2[category]) {
                            overlapCount++;
                        }
                    });
                    
                    return overlapCount / totalCategories;
                }
                
                // Helper function to calculate semantic similarity
                function calculateSemanticSimilarity(text1, text2) {
                    // This is a simplified approach - in a real application, you might use 
                    // more sophisticated NLP techniques or external APIs
                    
                    // Convert texts to lowercase and split into words
                    const words1 = text1.toLowerCase().split(/\W+/).filter(word => word.length > 3);
                    const words2 = text2.toLowerCase().split(/\W+/).filter(word => word.length > 3);
                    
                    // Count shared words
                    const sharedWords = words1.filter(word => words2.includes(word));
                    
                    // Calculate similarity as ratio of shared words to average word count
                    const avgWordCount = (words1.length + words2.length) / 2;
                    return avgWordCount > 0 ? (sharedWords.length / avgWordCount) : 0;
                }
                
                // Function to generate alignment reason
                function generateAlignmentReason(ploText, mloText, score) {
                    // Extract key elements
                    const ploKeywords = extractKeywords(ploText);
                    const mloKeywords = extractKeywords(mloText);
                    
                    // Find overlapping and non-overlapping categories
                    const overlappingCategories = [];
                    const missingCategories = [];
                    
                    Object.keys(ploKeywords).forEach(category => {
                        if (ploKeywords[category] && mloKeywords[category]) {
                            overlappingCategories.push(category);
                        } else if (ploKeywords[category] && !mloKeywords[category]) {
                            missingCategories.push(category);
                        }
                    });
                    
                    // Generate reason based on score
                    let reason = "";
                    
                    if (score >= 5) {
                        reason = `Excellent alignment. Both the PLO and MLO strongly emphasize ${formatList(overlappingCategories)}.`;
                    } else if (score >= 4) {
                        reason = `Strong alignment. Both outcomes focus on ${formatList(overlappingCategories)}.`;
                    } else if (score >= 3) {
                        reason = `Moderate alignment. Both share emphasis on ${formatList(overlappingCategories)}.`;
                        if (missingCategories.length > 0) {
                            reason += ` However, the PLO also covers ${formatList(missingCategories)} which is not directly addressed in the MLO.`;
                        }
                    } else if (score >= 2) {
                        reason = `Limited alignment. There is some overlap in ${formatList(overlappingCategories)}, but significant differences exist.`;
                        if (missingCategories.length > 0) {
                            reason += ` The PLO's focus on ${formatList(missingCategories)} is not reflected in the MLO.`;
                        }
                    } else {
                        reason = `Minimal alignment. The focus areas of the PLO and MLO are substantially different.`;
                    }
                    
                    return reason;
                }
                
                // Helper function to format a list of categories nicely
                function formatList(categories) {
                    if (categories.length === 0) return "none";
                    if (categories.length === 1) return categories[0];
                    if (categories.length === 2) return `${categories[0]} and ${categories[1]}`;
                    
                    const lastCategory = categories[categories.length - 1];
                    return `${categories.slice(0, -1).join(", ")}, and ${lastCategory}`;
                }
                
                // Add the containers to their respective view containers
                ploViewContainer.appendChild(ploMainContainer);
                mloViewContainer.appendChild(mloMainContainer);
            }
            
            // Function to calculate alignment score between PLO and MLO text
            function calculateAlignmentScore(ploText, mloText) {
                // Extract keywords from both texts
                const ploKeywords = extractKeywords(ploText);
                const mloKeywords = extractKeywords(mloText);
                
                // Extract verbs from both texts
                const ploVerbs = extractVerbs(ploText);
                const mloVerbs = extractVerbs(mloText);
                
                // Calculate keyword match score
                let keywordScore = 0;
                ploKeywords.forEach(keyword => {
                    if (mloText.toLowerCase().includes(keyword)) {
                        keywordScore += 0.5;
                    }
                    
                    // Check for partial matches
                    const partialMatches = mloKeywords.filter(mk => 
                        mk.includes(keyword) || keyword.includes(mk));
                    if (partialMatches.length > 0) {
                        keywordScore += 0.2;
                    }
                });
                
                // Calculate verb alignment score
                const verbScore = calculateVerbScore(ploVerbs, mloVerbs);
                
                // Calculate semantic similarity
                const semanticScore = calculateSemanticScore(ploText, mloText);
                
                // Calculate final score
                let score = 1; // Base score
                score += Math.min(keywordScore, 2); // Max 2 points from keywords
                score += Math.min(verbScore, 1); // Max 1 point from verbs
                score += Math.min(semanticScore, 1); // Max 1 point from semantic similarity
                
                return Math.min(Math.round(score), 5); // Cap at 5
            }
            
            // Function to extract keywords from text
            function extractKeywords(text) {
                const commonWords = ['the', 'and', 'is', 'in', 'to', 'of', 'a', 'for', 'with', 'on', 'at'];
                
                return text.toLowerCase()
                    .replace(/[.,;:'"!?()]/g, '')
                    .split(' ')
                    .filter(word => word.length > 3 && !commonWords.includes(word))
                    .slice(0, 5); // Take up to 5 keywords
            }
            
            // Function to extract action verbs from text
            function extractVerbs(text) {
                const commonVerbs = [
                    'analyze', 'apply', 'assess', 'create', 'define', 'demonstrate', 'design', 
                    'develop', 'evaluate', 'explain', 'identify', 'implement', 'interpret', 
                    'plan', 'solve', 'understand', 'use', 'synthesize', 'formulate', 'construct'
                ];
                
                const textLower = text.toLowerCase();
                const foundVerbs = commonVerbs.filter(verb => textLower.includes(verb));
                
                return foundVerbs.length > 0 ? foundVerbs : ['demonstrate', 'analyze', 'develop'];
            }
            
            // Function to calculate verb alignment score
            function calculateVerbScore(ploVerbs, mloVerbs) {
                // Bloom's taxonomy levels
                const bloomLevels = {
                    'remember': 1, 'recognize': 1, 'recall': 1, 'identify': 1, 'define': 1, 'list': 1,
                    'understand': 2, 'explain': 2, 'interpret': 2, 'classify': 2, 'summarize': 2,
                    'apply': 3, 'implement': 3, 'use': 3, 'execute': 3, 'demonstrate': 3,
                    'analyze': 4, 'differentiate': 4, 'compare': 4, 'examine': 4, 'categorize': 4,
                    'evaluate': 5, 'assess': 5, 'judge': 5, 'critique': 5, 'justify': 5,
                    'create': 6, 'design': 6, 'develop': 6, 'formulate': 6, 'synthesize': 6
                };
                
                // Get highest levels
                let ploHighest = 0;
                let mloHighest = 0;
                
                ploVerbs.forEach(verb => {
                    const level = bloomLevels[verb] || 0;
                    ploHighest = Math.max(ploHighest, level);
                });
                
                mloVerbs.forEach(verb => {
                    const level = bloomLevels[verb] || 0;
                    mloHighest = Math.max(mloHighest, level);
                });
                
                // Score based on level alignment
                if (ploHighest === mloHighest && ploHighest > 0) {
                    return 1.0; // Exact match
                } else if (Math.abs(ploHighest - mloHighest) <= 1 && ploHighest > 0 && mloHighest > 0) {
                    return 0.8; // Close match
                } else if (ploVerbs.filter(v => mloVerbs.includes(v)).length > 0) {
                    return 0.6; // Some common verbs
                } else if (ploHighest > 0 && mloHighest > 0) {
                    return 0.3; // Both have verbs but no alignment
                }
                
                return 0;
            }
            
            // Function to calculate semantic similarity score
            function calculateSemanticScore(ploText, mloText) {
                const commonPhrases = [
                    'knowledge', 'skills', 'analyze', 'evaluate', 'create', 
                    'problem', 'solution', 'research', 'communicate', 'demonstrate',
                    'professional', 'ethical', 'team', 'individual', 'practice'
                ];
                
                let commonCount = 0;
                commonPhrases.forEach(phrase => {
                    if (ploText.toLowerCase().includes(phrase) && mloText.toLowerCase().includes(phrase)) {
                        commonCount++;
                    }
                });
                
                const lengthRatio = Math.min(ploText.length, mloText.length) / Math.max(ploText.length, mloText.length);
                
                return (commonCount / 10) * 0.7 + lengthRatio * 0.3;
            }
            
            // Function to generate alignment reason
            function generateAlignmentReason(ploText, mloText, score) {
                // Extract key elements
                const ploKeywords = extractKeywords(ploText);
                const mloKeywords = extractKeywords(mloText);
                
                // Find overlapping and non-overlapping categories
                const overlappingCategories = [];
                const missingCategories = [];
                
                Object.keys(ploKeywords).forEach(category => {
                    if (ploKeywords[category] && mloKeywords[category]) {
                        overlappingCategories.push(category);
                    } else if (ploKeywords[category] && !mloKeywords[category]) {
                        missingCategories.push(category);
                    }
                });
                
                // Generate reason based on score
                let reason = "";
                
                if (score >= 5) {
                    reason = `Excellent alignment. Both the PLO and MLO strongly emphasize ${formatList(overlappingCategories)}.`;
                } else if (score >= 4) {
                    reason = `Strong alignment. Both outcomes focus on ${formatList(overlappingCategories)}.`;
                } else if (score >= 3) {
                    reason = `Moderate alignment. Both share emphasis on ${formatList(overlappingCategories)}.`;
                    if (missingCategories.length > 0) {
                        reason += ` However, the PLO also covers ${formatList(missingCategories)} which is not directly addressed in the MLO.`;
                    }
                } else if (score >= 2) {
                    reason = `Limited alignment. There is some overlap in ${formatList(overlappingCategories)}, but significant differences exist.`;
                    if (missingCategories.length > 0) {
                        reason += ` The PLO's focus on ${formatList(missingCategories)} is not reflected in the MLO.`;
                    }
                } else {
                    reason = `Minimal alignment. The focus areas of the PLO and MLO are substantially different.`;
                }
                
                return reason;
            }
            
            // Helper function to format a list of categories nicely
            function formatList(categories) {
                if (categories.length === 0) return "none";
                if (categories.length === 1) return categories[0];
                if (categories.length === 2) return `${categories[0]} and ${categories[1]}`;
                
                const lastCategory = categories[categories.length - 1];
                return `${categories.slice(0, -1).join(", ")}, and ${lastCategory}`;
            }
            
            // Add the containers to their respective view containers
            ploViewContainer.appendChild(ploMainContainer);
            mloViewContainer.appendChild(mloMainContainer);
        });
    </script>
</body>
</html>