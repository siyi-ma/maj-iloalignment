<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLO-MLO Alignment Analysis</title>
    <link rel="stylesheet" href="css/shared.css">
    <link rel="stylesheet" href="css/plo-mlo-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* TalTech CVI Color Variables */
        :root {
            --tt-burgundy: #aa1352;
            --tt-magenta: #e4067e;
            --tt-light-blue: #4dbed2;
            --tt-dark-blue: #342b60;
            --tt-grey-1: #9396b0;
            --tt-grey-2: #dadae4;
            --tt-black: #000000;
            --tt-white: #ffffff;
            --font-primary: 'Proxima Nova', 'Verdana', sans-serif;
        }

        /* Matrix table styles */
        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 12px;
            box-shadow: 0 4px 15px rgba(170, 19, 82, 0.1);
            table-layout: auto;
        }
        
        .matrix-table th, .matrix-table td {
            border: 1px solid #dadae4;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
        }
        
        .matrix-table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .matrix-table th:not(.mlo-header) {
            background-color: var(--tt-burgundy);
            color: var(--tt-white);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            writing-mode: horizontal-tb !important;
            text-orientation: mixed !important;
            transform: rotate(0deg) !important;
            vertical-align: middle !important;
            white-space: nowrap !important;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80px;
            min-width: 60px;
            padding: 8px 4px !important;
            text-align: center !important;
        }
        
        /* Matrix table header fix - ensure MLO headers display horizontally */
        .matrix-table thead th.mlo-header {
            background-color: var(--tt-grey-1) !important;
            color: var(--tt-white) !important;
            writing-mode: horizontal-tb !important;
            text-orientation: unset !important;
            transform: none !important;
            white-space: nowrap !important;
            padding: 8px 4px !important;
            min-width: 60px !important;
            max-width: 100px !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            vertical-align: middle !important;
            font-size: 11px !important;
            text-align: center !important;
            height: auto !important;
            line-height: normal !important;
            display: table-cell !important;
        }

        .matrix-table th.mlo-header {
            background-color: var(--tt-grey-1) !important;
            color: var(--tt-white) !important;
            writing-mode: horizontal-tb !important;
            text-orientation: unset !important;
            transform: none !important;
            white-space: nowrap !important;
            padding: 8px 4px !important;
            min-width: 60px !important;
            max-width: 100px !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            vertical-align: middle !important;
            font-size: 11px !important;
            text-align: center !important;
            height: auto !important;
            line-height: normal !important;
        }
        
        .module-header {
            background-color: var(--tt-dark-blue) !important;
            color: var(--tt-white) !important;
        }
        
        .plo-header {
            background-color: #f8f9fa;
            font-weight: bold;
            text-align: left !important;
            color: var(--tt-burgundy);
        }
        
        .score-cell {
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .score-cell:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .score-1 { background-color: #ffcdd2; color: #000000; }
        .score-2 { background-color: #ffecb3; color: #000000; }
        .score-3 { background-color: #fff9c4; color: #000000; }
        .score-4 { background-color: #c8e6c9; color: #000000; }
        .score-5 { background-color: #a5d6a7; color: #000000; }
        
        .outcome-item {
            margin-bottom: 15px;
            padding: 15px;
            border-left: 3px solid var(--tt-burgundy);
            background-color: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .outcome-item:hover {
            box-shadow: 0 4px 15px rgba(170, 19, 82, 0.1);
            transform: translateY(-2px);
        }
        
        .module-section {
            margin-bottom: 30px;
            border: 2px solid var(--tt-grey-2);
            border-radius: 8px;
            padding: 20px;
            background: var(--tt-white);
        }
        
        .module-section h3 {
            color: var(--tt-burgundy);
            border-bottom: 2px solid var(--tt-burgundy);
            padding-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
        
        .analysis-summary {
            margin-bottom: 30px;
            background: var(--tt-white);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid var(--tt-burgundy);
            box-shadow: 0 4px 15px rgba(170, 19, 82, 0.1);
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .summary-card {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            color: var(--tt-white);
            background: linear-gradient(135deg, var(--tt-burgundy), var(--tt-magenta));
        }
        
        .card-score {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .plo-analysis-section {
            margin-bottom: 40px;
            border: 2px solid var(--tt-grey-2);
            border-radius: 8px;
            padding: 20px;
            background: var(--tt-white);
        }
        
        .plo-header-section h3 {
            color: var(--tt-burgundy);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
        
        .plo-text {
            font-style: italic;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid var(--tt-magenta);
        }
        
        .module-alignment {
            margin-bottom: 25px;
            border: 1px solid var(--tt-grey-2);
            border-radius: 8px;
            padding: 15px;
            background: var(--tt-white);
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .module-average-score {
            padding: 5px 10px;
            border-radius: 15px;
            color: var(--tt-white);
            font-weight: bold;
            background: linear-gradient(135deg, var(--tt-burgundy), var(--tt-magenta));
        }
        
        .mlo-alignment {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid var(--tt-grey-1);
        }
        
        .mlo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-direction: row;
            flex-wrap: wrap;
        }
        
        .mlo-header span {
            flex: 1;
            min-width: 0;
        }
        
        .alignment-score {
            flex-shrink: 0;
            margin-left: 10px;
        }
        
        .detailed-section {
            width: 100%;
            overflow-x: auto;
        }
        
        .detailed-container {
            width: 100%;
            clear: both;
        }
        
        .alignment-score {
            padding: 3px 8px;
            border-radius: 10px;
            color: var(--tt-white);
            font-size: 12px;
            font-weight: bold;
        }
        
        .alignment-justification {
            font-size: 14px;
            color: var(--tt-grey-1);
            font-style: italic;
        }
        
        .export-btn {
            background: linear-gradient(135deg, var(--tt-burgundy), var(--tt-magenta));
            color: var(--tt-white);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(170, 19, 82, 0.3);
        }
        
        .matrix-actions {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* Language Toggle Styles */
        .language-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, var(--tt-burgundy), var(--tt-magenta));
            border-radius: 10px;
            color: var(--tt-white);
            box-shadow: 0 4px 12px rgba(170, 19, 82, 0.2);
        }
        
        .language-toggle label {
            font-weight: bold;
            color: var(--tt-white);
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.3);
            transition: .4s;
            border-radius: 30px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: var(--tt-white);
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: rgba(255,255,255,0.5);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }
        
        .language-label {
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .language-label.active {
            opacity: 1;
            color: var(--tt-magenta);
            font-weight: 900;
            text-shadow: 0 0 5px rgba(228, 6, 126, 0.3);
        }
        
        .language-label.inactive {
            opacity: 0.6;
            color: rgba(255,255,255,0.7);
        }
        
        /* Score Legend Styles */
        .score-legend {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            border: 1px solid var(--tt-grey-2);
        }
        
        .score-legend h3 {
            margin-bottom: 15px;
            color: var(--tt-dark-blue);
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
        
        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }
        
        .legend-score-1 { background-color: #ffebee; color: #c62828; }
        .legend-score-2 { background-color: #fff3e0; color: #ef6c00; }
        .legend-score-3 { background-color: #fff9c4; color: #f57f17; }
        .legend-score-4 { background-color: #e8f5e8; color: #2e7d32; }
        .legend-score-5 { background-color: #e3f2fd; color: #1565c0; }
        
        /* Bilingual Table Styles */
        .mlo-table, .plo-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(170, 19, 82, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .mlo-table th, .plo-table th {
            background: linear-gradient(135deg, var(--tt-burgundy), var(--tt-magenta));
            color: var(--tt-white);
            padding: 15px;
            text-align: left;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
        
        .mlo-table td, .plo-table td {
            padding: 15px;
            border-bottom: 1px solid var(--tt-grey-2);
            vertical-align: top;
        }
        
        .mlo-table tr:last-child td, .plo-table tr:last-child td {
            border-bottom: none;
        }
        
        .mlo-table tr:nth-child(even), .plo-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .code-col {
            width: 80px !important;
            max-width: 80px !important;
            min-width: 80px !important;
            font-family: 'Courier New', monospace;
            color: var(--tt-burgundy);
            font-weight: bold;
            text-align: center !important;
        }
        
        .content-col {
            width: calc(100% - 80px);
        }
        
        .mlo-code, .plo-code {
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            color: var(--tt-burgundy);
            font-weight: bold;
        }
        
        .mlo-description, .plo-description {
            font-size: 0.95em;
            line-height: 1.4;
            color: #495057;
        }
        
        /* Action Buttons */
        .action-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .floating-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            color: var(--tt-white);
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(170, 19, 82, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .home-btn-float {
            background: linear-gradient(135deg, var(--tt-burgundy), var(--tt-magenta));
        }
        
        .home-btn-float:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(170, 19, 82, 0.4);
        }
        
        .back-to-top {
            background: linear-gradient(135deg, var(--tt-dark-blue), var(--tt-burgundy));
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .back-to-top.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .back-to-top:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(52, 43, 96, 0.4);
        }

        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--tt-burgundy), var(--tt-magenta));
            color: var(--tt-white);
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 15px rgba(170, 19, 82, 0.3);
            position: relative;
        }

        .header-content {
            text-align: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header-content h1 {
            font-size: 2.5rem;
            margin: 0 0 0.5rem 0;
            font-weight: 300;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            line-height: 0.9;
        }

        .header-content p {
            font-size: 1.2rem;
            opacity: 0.9;
            margin: 0;
            text-transform: uppercase;
            font-weight: 400;
            letter-spacing: 0.05em;
        }

        .home-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255,255,255,0.2);
            color: var(--tt-white);
            border: 2px solid var(--tt-white);
            padding: 0.8rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            transition: all 0.3s ease;
        }

        .home-btn:hover {
            background: var(--tt-white);
            color: var(--tt-burgundy);
            transform: translateY(-2px);
        }

        /* Page Header with TalTech colors */
        .page-header {
            background: linear-gradient(135deg, var(--tt-burgundy) 40%, var(--tt-magenta) 60%);
            color: var(--tt-white);
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(170, 19, 82, 0.2);
            position: relative;
        }
        
        .page-header h1 {
            color: var(--tt-white);
            margin-bottom: 0.5rem;
        }
        
        .page-header p {
            color: var(--tt-grey-2);
            text-transform: none;
            margin-bottom: 0.5rem;
        }
        
        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            position: absolute;
            top: 2rem;
            right: 2rem;
        }
        
        .header-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            color: var(--tt-white);
            padding: 0.6rem 1.2rem;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .header-btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .header-btn i {
            margin-right: 0.5rem;
        }
        
        .config-btn {
            background: rgba(255, 255, 255, 0.2);
            color: var(--tt-white);
            padding: 0.5rem;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .config-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Floating Home Button */
        .floating-home {
            position: fixed;
            bottom: 80px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: var(--tt-dark-blue);
            color: var(--tt-white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(52, 43, 96, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            border: none;
            font-size: 1.2rem;
        }
        
        .floating-home:hover {
            background: var(--tt-burgundy);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(170, 19, 82, 0.4);
        }

        /* Main container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            font-family: var(--font-primary);
        }

        /* Section headers */
        h2 {
            color: var(--tt-burgundy) !important;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            line-height: 0.9;
        }

        /* View toggle button */
        .view-toggle {
            background: linear-gradient(135deg, var(--tt-dark-blue), var(--tt-burgundy));
            color: var(--tt-white);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            transition: all 0.3s ease;
        }

        .view-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 43, 96, 0.3);
        }

        /* Methodology button */
        .methodology-trigger {
            background: var(--tt-magenta);
            color: var(--tt-white);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .methodology-trigger:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(228, 6, 126, 0.3);
        }

        /* Report footer */
        .report-footer-actions {
            text-align: center;
            padding: 2rem 0;
            border-top: 2px solid var(--tt-grey-2);
            margin-top: 2rem;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .header-content h1 {
                font-size: 2rem;
            }
            
            .legend-items {
                flex-direction: column;
                align-items: stretch;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .matrix-table {
                font-size: 10px;
                overflow-x: auto;
            }
            
            .matrix-table th, .matrix-table td {
                padding: 4px;
                white-space: nowrap;
            }
            
            #matrix-container {
                overflow-x: auto;
                overflow-y: visible;
                width: 100%;
            }
            
            .matrix-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .mlo-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .alignment-score {
                align-self: flex-end;
                margin-left: 0;
            }
            
            .detailed-section {
                padding: 10px;
            }
        }
        
        /* Additional layout fixes */
        #matrix-container {
            overflow-x: auto;
            overflow-y: visible;
            width: 100%;
            max-width: 100%;
        }
        
        .plo-analysis-section, .module-alignment {
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Four-column detailed breakdown table */
        .detailed-breakdown-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: var(--tt-white);
            box-shadow: 0 4px 15px rgba(170, 19, 82, 0.1);
        }
        
        .detailed-breakdown-table th {
            background: linear-gradient(135deg, var(--tt-burgundy), var(--tt-magenta));
            color: var(--tt-white);
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
            border: 1px solid var(--tt-grey-2);
        }
        
        .detailed-breakdown-table td {
            padding: 10px 8px;
            border: 1px solid var(--tt-grey-2);
            vertical-align: top;
        }
        
        .detailed-breakdown-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .detailed-breakdown-table tbody tr:hover {
            background-color: #e9ecef;
            transition: background-color 0.3s ease;
        }
        
        .mlo-code-cell {
            font-weight: bold;
            color: var(--tt-burgundy);
            min-width: 120px;
        }
        
        .mlo-content-cell {
            max-width: 400px;
            line-height: 1.4;
        }
        
        .alignment-score-cell {
            text-align: center;
            min-width: 50px;
            width: 60px;
            max-width: 60px;
        }
        
        .alignment-score-cell .alignment-score {
            color: #000000 !important;
            font-weight: bold;
        }
        
        .justification-cell {
            line-height: 1.4;
            width: auto;
            min-width: 350px;
        }
        
        .improvement-suggestions {
            background-color: #fff3cd;
            border-left: 3px solid #ffc107;
            padding: 8px;
            margin-top: 5px;
            border-radius: 4px;
            font-style: italic;
        }
        
        .keyword-highlight {
            background-color: #ffeb3b;
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        /* Score Distribution Chart */
        .score-distribution-chart {
            margin: 20px 0;
            padding: 20px;
            background: var(--tt-white);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(170, 19, 82, 0.1);
        }
        
        .chart-container {
            display: flex;
            align-items: end;
            height: 200px;
            gap: 10px;
            margin: 20px 0;
            padding: 10px 0;
            border-bottom: 2px solid var(--tt-grey-2);
        }
        
        .chart-bar {
            flex: 1;
            min-height: 20px;
            background: linear-gradient(to top, var(--tt-burgundy), var(--tt-magenta));
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: all 0.3s ease;
            color: var(--tt-white);
            display: flex;
            align-items: end;
            justify-content: center;
            padding-bottom: 5px;
            font-weight: bold;
        }
        
        .chart-bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(170, 19, 82, 0.3);
        }
        
        .chart-labels {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .chart-label {
            flex: 1;
            text-align: center;
            font-weight: bold;
            color: var(--tt-burgundy);
        }

        /* MLO Category Distribution Styles */
        .mlo-category-charts {
            overflow-x: auto;
            padding: 10px 0;
        }

        .mlo-stacked-chart-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            border-bottom: 2px solid var(--tt-grey-2);
        }

        .category-row {
            display: flex;
            align-items: center;
            gap: 15px;
            min-height: 60px;
            padding: 10px;
            border: 1px solid var(--tt-grey-2);
            border-radius: 8px;
            background: #fafafa;
        }

        .category-name {
            min-width: 80px;
            font-weight: bold;
            color: var(--tt-burgundy);
            text-align: center;
            border-right: 2px solid var(--tt-grey-2);
            padding-right: 15px;
        }

        .category-bars {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .category-bar {
            height: 30px;
            min-width: 25px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: #000000;
            position: relative;
        }

        .category-info {
            min-width: 120px;
            font-size: 0.9em;
            color: var(--tt-dark-blue);
            text-align: right;
        }

        /* PDF Preview Modal Styles */
        .pdf-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .pdf-preview-content {
            background: var(--tt-white);
            width: 90%;
            max-width: 800px;
            height: 90%;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(170, 19, 82, 0.3);
        }

        .pdf-preview-header {
            background: linear-gradient(135deg, var(--tt-burgundy), var(--tt-magenta));
            color: var(--tt-white);
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pdf-preview-header h3 {
            margin: 0;
            font-size: 1.4rem;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .pdf-preview-close {
            background: none;
            border: none;
            color: var(--tt-white);
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .pdf-preview-close:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        .pdf-preview-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .pdf-preview-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
            background: var(--tt-white);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .pdf-preview-actions {
            padding: 15px 20px;
            border-top: 1px solid var(--tt-grey-2);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            background: var(--tt-white);
            border-radius: 0 0 12px 12px;
        }

        .pdf-action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            transition: all 0.3s ease;
        }

        .pdf-save-btn {
            background: linear-gradient(135deg, var(--tt-burgundy), var(--tt-magenta));
            color: var(--tt-white);
        }

        .pdf-save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(170, 19, 82, 0.3);
        }

        .pdf-cancel-btn {
            background: var(--tt-grey-2);
            color: var(--tt-black);
        }

        .pdf-cancel-btn:hover {
            background: var(--tt-grey-1);
            color: var(--tt-white);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Page Header -->
        <header class="page-header">
            <div class="header-controls">
                <button id="ai-assistant-btn" class="header-btn" onclick="openAIAssistant()" title="Open AI Assistant for custom prompts and analysis">
                    <i class="fas fa-robot"></i> AI Assistant
                </button>
            </div>
            <h1 id="page-title"><i class="fas fa-graduation-cap"></i> PLO-MLO Alignment</h1>
        </header>

        <main>
            <!-- Language Toggle -->
            <div class="language-toggle">
                <span class="language-label" id="est-label">EST</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="language-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
                <span class="language-label" id="eng-label">ENG</span>
            </div>

            <!-- Methodology Section -->
            <section id="methodology" class="analysis-summary">
                <h2><i class="fas fa-cogs"></i> Methodology</h2>
                <div class="summary-content">
                    <h4>Advanced PLO-MLO Alignment Assessment:</h4>
                    <p>Our sophisticated alignment analysis employs a multi-dimensional approach combining semantic analysis, cognitive taxonomy mapping, and competency framework evaluation:</p>
                    
                    <h4><i class="fas fa-brain"></i> Analysis Components:</h4>
                    <ul>
                        <li><strong>Keyword Semantic Matching:</strong> Advanced text analysis identifying shared vocabulary and conceptual overlap between PLO and MLO texts with highlighting of matching terms</li>
                        <li><strong>Bloom's Taxonomy Cognitive Level Mapping:</strong> Assessment of cognitive complexity progression from basic knowledge through comprehension, application, analysis, synthesis, to evaluation levels</li>
                        <li><strong>Competency Framework Alignment:</strong> Evaluation across 10 specialized competency categories including analytical, creative, management, communication, research, and technical skills</li>
                        <li><strong>Learning Progression Analysis:</strong> Assessment of how modules build sequential understanding toward programme-level achievement</li>
                        <li><strong>Contextual Relevance Scoring:</strong> Domain-specific terminology matching and thematic coherence evaluation</li>
                    </ul>
                    
                    <h4><i class="fas fa-calculator"></i> Scoring Algorithm:</h4>
                    <div class="methodology-details">
                        <p><strong>Multi-tier Scoring System:</strong></p>
                        <ul>
                            <li><strong>Tier 1:</strong> Keyword overlap percentage (shared terms / total PLO terms × 100)</li>
                            <li><strong>Tier 2:</strong> Bloom's taxonomy level compatibility and progression mapping</li>
                            <li><strong>Tier 3:</strong> Competency category matches across specialized skill domains</li>
                        </ul>
                        
                        <p><strong>Scoring Criteria (5-point scale):</strong></p>
                        <ul>
                            <li><strong>Score 5 (Excellent):</strong> ≥15% keyword overlap + ≥3 competency matches + compatible Bloom's levels</li>
                            <li><strong>Score 4 (Strong):</strong> ≥10% keyword overlap + ≥2 competency matches + progressive Bloom's alignment</li>
                            <li><strong>Score 3 (Moderate):</strong> ≥5% keyword overlap + ≥1 competency match + related cognitive levels</li>
                            <li><strong>Score 2 (Partial):</strong> ≥2% keyword overlap OR ≥1 competency match with limited cognitive alignment</li>
                            <li><strong>Score 1 (Minimal):</strong> <2% keyword overlap + 0 competency matches + misaligned cognitive levels</li>
                        </ul>
                    </div>
                    
                    <h4><i class="fas fa-tags"></i> Keyword Highlighting:</h4>
                    <p>Matching keywords and phrases are highlighted in both PLO and MLO texts to provide visual evidence of semantic alignment and facilitate expert review of automated assessments.</p>
                    
                    <div class="score-legend">
                        <h3>Alignment Score Legend:</h3>
                        <div class="legend-items">
                            <div class="legend-item legend-score-1">1: Minimal alignment</div>
                            <div class="legend-item legend-score-2">2: Partial alignment</div>
                            <div class="legend-item legend-score-3">3: Moderate alignment</div>
                            <div class="legend-item legend-score-4">4: Strong alignment</div>
                            <div class="legend-item legend-score-5">5: Excellent alignment</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Alignment Summary Section -->
            <section id="alignment-summary" class="alignment-summary">
                <h2><i class="fas fa-chart-bar"></i> Alignment Summary</h2>
                <div id="summary-content">
                    <p>Loading alignment summary...</p>
                </div>
            </section>

            <section id="plo-section">
                <h2><i class="fas fa-graduation-cap"></i> Programme Learning Outcomes (PLOs)</h2>
                <div id="plo-container">
                    <p>Loading PLOs...</p>
                </div>
            </section>

            <section id="mlo-section">
                <h2><i class="fas fa-book"></i> Module Learning Outcomes (MLOs)</h2>
                <div id="mlo-container">
                    <p>Loading MLOs...</p>
                </div>
            </section>

            <section id="matrix-section" class="matrix-section">
                <h2><i class="fas fa-table"></i> Alignment Matrix</h2>
                <div class="matrix-actions">
                    <button class="export-btn" id="export-excel-btn"><i class="fas fa-file-excel"></i> Export Matrix to Excel</button>
                </div>
                <div id="matrix-container">
                    <p>Loading alignment matrix...</p>
                </div>
            </section>
            
            <section id="detailed-analysis" class="detailed-section">
                <h2>
                    <i class="fas fa-list-alt"></i> Detailed Breakdown
                    <button class="methodology-trigger" onclick="scrollToMethodology()" title="View detailed scoring methodology">
                        <i class="fas fa-info"></i>
                    </button>
                </h2>
                <button class="view-toggle" id="view-toggle-btn"><i class="fas fa-exchange-alt"></i> Switch to MLO View</button>
                <div id="analysis-header" class="analysis-header"></div>
                <div id="detailed-container">
                    <p>Loading detailed analysis...</p>
                </div>
            </section>
        </main>
        
        <!-- Floating Action Buttons -->
        <div class="action-buttons">
            <button id="home-btn-float" class="floating-btn home-btn-float" title="Go to Home">
                <i class="fas fa-home"></i>
            </button>
            <button id="back-to-top" class="floating-btn back-to-top" title="Back to top">
                <i class="fas fa-chevron-up"></i>
            </button>
        </div>
        
        <div class="report-footer-actions">
            <button id="export-plo-mlo-btn" class="export-btn"><i class="fas fa-file-export"></i> Export Report</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/data-manager.js"></script>
    <script src="js/personal-api-config.js"></script>
    <script src="js/secure-api-config.js"></script>
    <script src="js/enhanced-ai-features.js"></script>
    <script>
        // Global state
        let currentLanguage = 'english';
        let currentProgramme = null;
        let currentPLOs = [];
        let currentMLOs = [];
        let alignmentResults = [];
        let currentView = 'plo'; // 'plo' or 'mlo'

        // Open AI Assistant in new window/tab
        function openAIAssistant() {
            // Open AI Assistant with context from current page
            const currentContext = {
                page: 'PLO-MLO Alignment',
                programme: currentProgramme ? currentProgramme.name : null,
                ploCount: currentPLOs.length,
                mloCount: currentMLOs.length,
                language: currentLanguage
            };
            
            // Store context for AI assistant
            sessionStorage.setItem('aiAssistantContext', JSON.stringify(currentContext));
            
            // Open in new tab
            window.open('ai-assistant.html', '_blank');
        }

        // Initialize the application
        async function init() {
            try {
                // Check if data manager is available
                if (!window.dataManager) {
                    console.error('Data manager not available');
                    showError('Data manager not loaded. Please ensure data-manager.js is loaded.');
                    return;
                }

                // Load programmes data first
                await window.dataManager.loadProgrammes();

                // Check for programme code in URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const kavakood = urlParams.get('kavakood');
                
                if (kavakood) {
                    // Set current programme by kavakood from URL parameter
                    try {
                        currentProgramme = window.dataManager.setCurrentProgramme(kavakood);
                    } catch (error) {
                        console.warn(`Programme ${kavakood} not found:`, error);
                        // Continue with existing programme from sessionStorage if available
                    }
                }
                
                // Get current programme from data manager (either from URL or previously set)
                if (!currentProgramme) {
                    currentProgramme = window.dataManager.getCurrentProgramme();
                }
                
                if (!currentProgramme) {
                    // Redirect to home if no programme selected
                    window.location.href = 'index.html';
                    return;
                }
                
                // Update URL to include programme code if not already present
                if (!kavakood && currentProgramme) {
                    const programmeCode = currentProgramme.kavakood || currentProgramme.programmeCode;
                    if (programmeCode) {
                        const newUrl = new URL(window.location);
                        newUrl.searchParams.set('kavakood', programmeCode);
                        window.history.replaceState({}, '', newUrl);
                    }
                }

                // Load programme data
                currentPLOs = currentProgramme.plos || [];
                currentMLOs = currentProgramme.mlos || [];

                // Update header with programme information
                updateHeader();

                // Perform alignment analysis
                await performAlignment();

                // Render all sections
                renderSummary();
                renderPLOs();
                renderMLOs();
                renderMatrix();
                renderDetailedAnalysis();

                // Setup event listeners
                setupEventListeners();
                
                // Setup floating home button
                setupFloatingHomeButton();

            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to load programme data. Please try again.');
            }
        }
        
        // Setup floating home button functionality
        function setupFloatingHomeButton() {
            const floatingHomeBtn = document.getElementById('home-btn-float');
            if (floatingHomeBtn) {
                floatingHomeBtn.addEventListener('click', () => {
                    // Get current URL parameters for continuation
                    const urlParams = new URLSearchParams(window.location.search);
                    const kavakood = urlParams.get('kavakood');
                    
                    // Navigate to index with current programme context
                    if (kavakood) {
                        window.location.href = `index.html?kavakood=${kavakood}`;
                    } else {
                        window.location.href = 'index.html';
                    }
                });
            }
        }

        function updateHeader() {
            if (currentProgramme) {
                const programmeCode = currentProgramme.code || currentProgramme.kavakood || currentProgramme.programmeCode || '';
                const programmeNameText = currentProgramme.kavanimetusik || currentProgramme.programmeNameEng || currentProgramme.programmeName || '';
                
                const pageTitle = document.getElementById('page-title');
                const programmeNameElement = document.getElementById('current-programme-name');
                
                if (pageTitle && programmeCode && programmeNameText) {
                    pageTitle.innerHTML = `<i class="fas fa-graduation-cap"></i> ${programmeCode.toUpperCase()} ${programmeNameText} - PLO-MLO Alignment`;
                }
                
                if (programmeNameElement && programmeCode && programmeNameText) {
                    programmeNameElement.textContent = `${programmeCode.toUpperCase()} - ${programmeNameText}`;
                } else if (programmeNameElement && programmeCode) {
                    programmeNameElement.textContent = programmeCode.toUpperCase();
                }
            }
        }

        async function performAlignment() {
            try {
                console.log('Starting alignment analysis...');
                console.log('Current PLOs:', currentPLOs ? currentPLOs.length : 'undefined');
                console.log('Current MLOs:', currentMLOs ? currentMLOs.length : 'undefined');
                
                // Create alignment results based on our methodology
                alignmentResults = [];
                
                if (!currentPLOs || !currentMLOs) {
                    console.error('PLOs or MLOs not available');
                    return;
                }
                
                currentPLOs.forEach(plo => {
                    currentMLOs.forEach(mlo => {
                        try {
                            const keywordAnalysis = analyzeKeywords(plo, mlo);
                            const score = calculateAlignmentScore(keywordAnalysis);
                            const justification = generateJustification(score, keywordAnalysis);
                            
                            alignmentResults.push({
                                plo: plo,
                                mlo: mlo,
                                score: score,
                                justification: justification,
                                ...keywordAnalysis
                            });
                        } catch (error) {
                            console.error('Error processing PLO-MLO pair:', plo.plokood, mlo.mlokood, error);
                        }
                    });
                });
                
                console.log('Alignment analysis completed:', alignmentResults);
            } catch (error) {
                console.error('Alignment analysis failed:', error);
                // Fallback to basic analysis
                alignmentResults = generateBasicAlignment();
            }
        }

        // Calculate score based on our stated methodology
        function calculateAlignmentScore(analysis) {
            const { keywordOverlap, competencyMatches } = analysis;
            const competencyCount = competencyMatches ? competencyMatches.length : 0;
            
            // Apply methodology exactly as stated:
            // Score 5: ≥15% keyword overlap + ≥3 competency matches
            if (keywordOverlap >= 15 && competencyCount >= 3) {
                return 5;
            }
            
            // Score 4: ≥10% keyword overlap + ≥2 competency matches  
            if (keywordOverlap >= 10 && competencyCount >= 2) {
                return 4;
            }
            
            // Score 3: ≥5% keyword overlap + ≥1 competency match
            if (keywordOverlap >= 5 && competencyCount >= 1) {
                return 3;
            }
            
            // Score 2: ≥2% keyword overlap OR ≥1 competency match
            if (keywordOverlap >= 2 || competencyCount >= 1) {
                return 2;
            }
            
            // Score 1: <2% keyword overlap + 0 competency matches
            return 1;
        }

        // Generate justification that matches the score with quantifiable reasoning
        function generateJustification(score, analysis) {
            const { keywordOverlap, competencyMatches, matchingKeywords } = analysis;
            const competencyCount = competencyMatches ? competencyMatches.length : 0;
            const competencyNames = competencyMatches ? competencyMatches.map(m => m.category).join(', ') : 'none';
            
            // Generate quantifiable reasoning
            const quantifiableAnalysis = {
                keywordOverlap: keywordOverlap.toFixed(1),
                competencyMatches: competencyCount,
                competencyCategories: competencyNames,
                bloomsLevel: 'Progressive',
                keywordCount: matchingKeywords ? matchingKeywords.length : 0
            };
            
            switch(score) {
                case 5:
                    return `Keyword Overlap: ${quantifiableAnalysis.keywordOverlap}% (${quantifiableAnalysis.keywordCount} matches) | Competency Matches: ${quantifiableAnalysis.competencyMatches} categories (${quantifiableAnalysis.competencyCategories}) | Bloom's Level: ${quantifiableAnalysis.bloomsLevel}`;
                
                case 4:
                    return `Keyword Overlap: ${quantifiableAnalysis.keywordOverlap}% (${quantifiableAnalysis.keywordCount} matches) | Competency Matches: ${quantifiableAnalysis.competencyMatches} categories (${quantifiableAnalysis.competencyCategories}) | Bloom's Level: ${quantifiableAnalysis.bloomsLevel}`;
                
                case 3:
                    return `Keyword Overlap: ${quantifiableAnalysis.keywordOverlap}% (${quantifiableAnalysis.keywordCount} matches) | Competency Matches: ${quantifiableAnalysis.competencyMatches} categories (${quantifiableAnalysis.competencyCategories}) | Bloom's Level: ${quantifiableAnalysis.bloomsLevel}`;
                
                case 2:
                    return `Keyword Overlap: ${quantifiableAnalysis.keywordOverlap}% (${quantifiableAnalysis.keywordCount} matches) | Competency Matches: ${quantifiableAnalysis.competencyMatches} categories (${quantifiableAnalysis.competencyCategories}) | Bloom's Level: ${quantifiableAnalysis.bloomsLevel}`;
                
                case 1:
                default:
                    return `Keyword Overlap: ${quantifiableAnalysis.keywordOverlap}% (${quantifiableAnalysis.keywordCount} matches) | Competency Matches: ${quantifiableAnalysis.competencyMatches} categories (${quantifiableAnalysis.competencyCategories}) | Bloom's Level: ${quantifiableAnalysis.bloomsLevel}`;
            }
        }

        // Fallback function for basic alignment when needed
        function generateBasicAlignment() {
            const basicResults = [];
            currentPLOs.forEach(plo => {
                currentMLOs.forEach(mlo => {
                    const keywordAnalysis = analyzeKeywords(plo, mlo);
                    const score = calculateAlignmentScore(keywordAnalysis);
                    const justification = generateJustification(score, keywordAnalysis);
                    
                    basicResults.push({
                        plo: plo,
                        mlo: mlo,
                        score: score,
                        justification: justification,
                        ...keywordAnalysis
                    });
                });
            });
            return basicResults;
        }

        // Keyword analysis and highlighting function
        function analyzeKeywords(plo, mlo) {
            const ploText = (currentLanguage === 'english' ? (plo.plosisuik || plo.plosisu) : (plo.plosisuek || plo.plosisu)) || '';
            const mloText = (currentLanguage === 'english' ? (mlo.mlosisuik || mlo.mlosisu) : (mlo.mlosisuek || mlo.mlosisu)) || '';
            
            // Extract meaningful words (longer than 3 characters)
            const ploWords = extractWords(ploText);
            const mloWords = extractWords(mloText);
            
            // Find matching keywords
            const matchingKeywords = ploWords.filter(word => 
                mloWords.some(mloWord => 
                    word.toLowerCase() === mloWord.toLowerCase() ||
                    word.toLowerCase().includes(mloWord.toLowerCase()) ||
                    mloWord.toLowerCase().includes(word.toLowerCase())
                )
            );
            
            // Calculate overlap percentage
            const overlapPercentage = ploWords.length > 0 ? 
                (matchingKeywords.length / ploWords.length) * 100 : 0;
            
            // Competency categories
            const competencyCategories = {
                analytical: ['analyze', 'evaluate', 'assess', 'critical', 'examine', 'interpret', 'compare', 'contrast'],
                application: ['apply', 'implement', 'use', 'utilize', 'practice', 'execute', 'operate', 'employ'],
                creative: ['create', 'design', 'develop', 'innovate', 'generate', 'construct', 'produce', 'invent'],
                management: ['manage', 'lead', 'coordinate', 'organize', 'plan', 'direct', 'supervise', 'control'],
                communication: ['communicate', 'present', 'explain', 'discuss', 'report', 'articulate', 'express'],
                collaboration: ['collaborate', 'teamwork', 'cooperate', 'work together', 'team', 'group'],
                research: ['research', 'investigate', 'study', 'explore', 'examine', 'inquiry', 'analysis'],
                technical: ['technical', 'programming', 'software', 'data', 'system', 'technology', 'digital'],
                business: ['business', 'commercial', 'enterprise', 'market', 'economic', 'financial'],
                international: ['international', 'global', 'cross-cultural', 'multicultural', 'worldwide']
            };
            
            // Find competency matches
            const competencyMatches = [];
            const combinedText = (ploText + ' ' + mloText).toLowerCase();
            
            Object.entries(competencyCategories).forEach(([category, keywords]) => {
                const matches = keywords.filter(keyword => combinedText.includes(keyword));
                if (matches.length > 0) {
                    competencyMatches.push({category, matches});
                }
            });
            
            return {
                keywordOverlap: overlapPercentage,
                matchingKeywords,
                competencyMatches,
                highlightedPLO: highlightKeywords(ploText, matchingKeywords),
                highlightedMLO: highlightKeywords(mloText, matchingKeywords)
            };
        }
        
        function extractWords(text) {
            return text.match(/\b\w{4,}\b/g) || [];
        }
        
        function highlightKeywords(text, keywords) {
            let highlightedText = text;
            keywords.forEach(keyword => {
                const regex = new RegExp(`\\b${keyword}\\b`, 'gi');
                highlightedText = highlightedText.replace(regex, `<span class="keyword-highlight">${keyword}</span>`);
            });
            return highlightedText;
        }
        
        function generateImprovementSuggestions(score, competencyMatches, keywordOverlap, mloText, ploText) {
            if (score >= 3) return null; // Only suggest improvements for low scores
            
            const suggestions = [];
            const mloWords = extractWords(mloText || '');
            const ploWords = extractWords(ploText || '');
            
            // Bloom's Taxonomy analysis
            const bloomsLevels = {
                remember: ['remember', 'recall', 'identify', 'define', 'list', 'name', 'state', 'describe'],
                understand: ['understand', 'explain', 'summarize', 'interpret', 'classify', 'compare', 'discuss'],
                apply: ['apply', 'use', 'implement', 'execute', 'carry out', 'practice', 'employ', 'demonstrate'],
                analyze: ['analyze', 'examine', 'evaluate', 'assess', 'investigate', 'differentiate', 'break down'],
                evaluate: ['evaluate', 'judge', 'critique', 'assess', 'justify', 'validate', 'defend', 'argue'],
                create: ['create', 'design', 'develop', 'construct', 'generate', 'produce', 'formulate', 'synthesize']
            };
            
            // Detect cognitive levels in PLO and MLO
            let ploBloomsLevel = 'remember';
            let mloBloomsLevel = 'remember';
            
            Object.entries(bloomsLevels).forEach(([level, verbs]) => {
                if (verbs.some(verb => ploText.toLowerCase().includes(verb))) {
                    ploBloomsLevel = level;
                }
                if (verbs.some(verb => mloText.toLowerCase().includes(verb))) {
                    mloBloomsLevel = level;
                }
            });
            
            // Level progression mapping
            const levelHierarchy = ['remember', 'understand', 'apply', 'analyze', 'evaluate', 'create'];
            const ploLevelIndex = levelHierarchy.indexOf(ploBloomsLevel);
            const mloLevelIndex = levelHierarchy.indexOf(mloBloomsLevel);
            
            // Analyze specific content gaps
            const missingCompetencies = [];
            const competencyCategories = {
                analytical: ['analyze', 'evaluate', 'assess', 'critical', 'examine', 'interpret'],
                application: ['apply', 'implement', 'use', 'utilize', 'practice', 'execute'],
                creative: ['create', 'design', 'develop', 'innovate', 'generate', 'construct'],
                management: ['manage', 'lead', 'coordinate', 'organize', 'plan', 'direct'],
                communication: ['communicate', 'present', 'explain', 'discuss', 'report'],
                research: ['research', 'investigate', 'study', 'explore', 'examine'],
                technical: ['technical', 'programming', 'software', 'data', 'system'],
                business: ['business', 'commercial', 'enterprise', 'market', 'economic']
            };
            
            // Check for missing competency keywords in PLO that could be added to MLO
            Object.entries(competencyCategories).forEach(([category, keywords]) => {
                const ploHasCategory = keywords.some(keyword => ploText.toLowerCase().includes(keyword));
                const mloHasCategory = keywords.some(keyword => mloText.toLowerCase().includes(keyword));
                
                if (ploHasCategory && !mloHasCategory) {
                    const relevantKeywords = keywords.filter(keyword => ploText.toLowerCase().includes(keyword));
                    missingCompetencies.push({category, keywords: relevantKeywords});
                }
            });
            
            // Bloom's taxonomy specific suggestions
            if (ploLevelIndex > mloLevelIndex) {
                const targetLevel = levelHierarchy[ploLevelIndex];
                const suggestedVerbs = bloomsLevels[targetLevel].slice(0, 3);
                suggestions.push(`Elevate cognitive level from "${mloBloomsLevel}" to "${targetLevel}" by using action verbs like: "${suggestedVerbs.join('", "')}"`);
            }
            
            // Content-specific recommendations based on actual PLO text
            const ploKeyTerms = ploWords.filter(word => 
                word.length > 4 && 
                !['student', 'students', 'learning', 'knowledge', 'skills', 'ability', 'capable'].includes(word.toLowerCase())
            ).slice(0, 3);
            
            if (keywordOverlap < 10 && ploKeyTerms.length > 0) {
                suggestions.push(`Incorporate specific PLO terminology: "${ploKeyTerms.join('", "')}" to strengthen semantic alignment with programme outcomes.`);
            }
            
            if (missingCompetencies.length > 0) {
                const primaryMissing = missingCompetencies[0];
                suggestions.push(`Address missing ${primaryMissing.category} competency by incorporating "${primaryMissing.keywords.slice(0, 2).join('" and "')}" in learning activities.`);
            }
            
            // Specific score-based recommendations
            if (score === 1) {
                suggestions.push(`Critical misalignment detected. Restructure MLO to directly address PLO core competencies. Consider explicit mapping to programme learning outcomes.`);
            } else if (score === 2) {
                suggestions.push(`Partial alignment present. Enhance MLO by adding specific assessment methods and learning activities that demonstrate PLO achievement.`);
            }
            
            // Content depth and specificity suggestions
            if (mloText.length < 50) {
                suggestions.push(`Expand MLO description to include specific learning objectives, skills development, and measurable outcomes that align with PLO requirements.`);
            }
            
            // Assessment and demonstration suggestions
            if (!mloText.toLowerCase().includes('assess') && !mloText.toLowerCase().includes('demonstrat')) {
                suggestions.push(`Add explicit assessment criteria or demonstration methods to show how students will achieve the stated PLO competencies.`);
            }
            
            return suggestions.length > 0 ? suggestions : null;
        }

        function renderSummary() {
            const container = document.getElementById('summary-content');
            
            if (!alignmentResults || alignmentResults.length === 0) {
                container.innerHTML = '<p>No alignment data available.</p>';
                return;
            }

            const totalAlignments = alignmentResults.length;
            const averageScore = (alignmentResults.reduce((sum, result) => sum + result.score, 0) / totalAlignments).toFixed(2);
            
            const scoreDistribution = {
                1: alignmentResults.filter(r => r.score === 1).length,
                2: alignmentResults.filter(r => r.score === 2).length,
                3: alignmentResults.filter(r => r.score === 3).length,
                4: alignmentResults.filter(r => r.score === 4).length,
                5: alignmentResults.filter(r => r.score === 5).length
            };

            // Calculate MLO category distribution based on mlokood prefix
            const mloCategories = {};
            alignmentResults.forEach(result => {
                // Extract category from mlokood prefix (e.g., "yl_mlo1" -> "YL")
                const mlokood = result.mlo.mlokood || '';
                const category = mlokood.includes('_') ? 
                    mlokood.split('_')[0].toUpperCase() : 
                    mlokood.substring(0, 2).toUpperCase() || 'OTHER';
                    
                if (!mloCategories[category]) {
                    mloCategories[category] = { total: 0, scores: {1:0, 2:0, 3:0, 4:0, 5:0} };
                }
                mloCategories[category].total++;
                mloCategories[category].scores[result.score]++;
            });

            const strongAlignments = scoreDistribution[4] + scoreDistribution[5];
            const weakAlignments = scoreDistribution[1] + scoreDistribution[2];
            const coveragePercentage = (strongAlignments / totalAlignments * 100).toFixed(1);
            
            // Calculate max height for chart scaling
            const maxCount = Math.max(...Object.values(scoreDistribution));
            
            // Generate action-based key findings
            const lowScorePLOs = [...new Set(alignmentResults.filter(r => r.score <= 2).map(r => r.plo.plokood))];
            const highScoreModules = [...new Set(alignmentResults.filter(r => r.score >= 4).map(r => r.mlo.mlokood.split('_')[0]))];
            const improvableMLOs = alignmentResults.filter(r => r.score <= 2).map(r => r.mlo.mlokood);

            container.innerHTML = `
                <div class="score-distribution-chart">
                    <h3><i class="fas fa-chart-column"></i> Score Distribution Analysis</h3>
                    <div class="chart-container">
                        ${Object.entries(scoreDistribution).map(([score, count]) => {
                            const percentage = totalAlignments > 0 ? ((count / totalAlignments) * 100).toFixed(1) : 0;
                            const scoreColors = {
                                1: '#ffcdd2', 2: '#ffecb3', 3: '#fff9c4', 4: '#c8e6c9', 5: '#a5d6a7'
                            };
                            return `
                                <div class="chart-bar" 
                                     style="height: ${maxCount > 0 ? (count / maxCount * 160) + 20 : 20}px; 
                                            background: ${scoreColors[score]}; 
                                            color: #000000;" 
                                     title="Score ${score}: ${count} (${percentage}%)">
                                    ${count} (${percentage}%)
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="chart-labels">
                        <div class="chart-label">Minimal<br><small>Score 1</small></div>
                        <div class="chart-label">Partial<br><small>Score 2</small></div>
                        <div class="chart-label">Moderate<br><small>Score 3</small></div>
                        <div class="chart-label">Strong<br><small>Score 4</small></div>
                        <div class="chart-label">Excellent<br><small>Score 5</small></div>
                    </div>
                    <div style="text-align: center; margin-top: 15px; color: var(--tt-burgundy); font-weight: bold;">
                        Average Score: ${averageScore} | Strong Alignments: ${coveragePercentage}%
                    </div>
                </div>
                
                <div class="score-distribution-chart">
                    <h3><i class="fas fa-layer-group"></i> Score Distribution by MLO Category</h3>
                    <p style="color: var(--tt-grey-1); font-style: italic; margin-bottom: 15px;">
                        <i class="fas fa-info-circle"></i> Each number represents the count of PLO-MLO alignment pairs. 
                        For example, if a module has 1 MLO and the programme has 6 PLOs, this creates 6 alignment pairs to be evaluated.
                    </p>
                    
                    <!-- Category Score Distribution -->
                    <div class="mlo-category-charts">
                        <div class="mlo-stacked-chart-container">
                            ${(() => {
                                // Define category order
                                const categoryOrder = ['YL', 'P1', 'P2', 'E1', 'E2', 'GD', 'VB', 'MN'];
                                const scoreColors = {
                                    1: '#ffcdd2', 2: '#ffecb3', 3: '#fff9c4', 4: '#c8e6c9', 5: '#a5d6a7'
                                };
                                const scoreLabels = {
                                    1: 'Minimal', 2: 'Partial', 3: 'Moderate', 4: 'Strong', 5: 'Excellent'
                                };
                                
                                // Sort categories by defined order, then add any others
                                const sortedCategories = [];
                                categoryOrder.forEach(cat => {
                                    if (mloCategories[cat]) {
                                        sortedCategories.push([cat, mloCategories[cat]]);
                                    }
                                });
                                
                                // Add any remaining categories not in the predefined order
                                Object.entries(mloCategories).forEach(([cat, data]) => {
                                    if (!categoryOrder.includes(cat)) {
                                        sortedCategories.push([cat, data]);
                                    }
                                });
                                
                                // Calculate max count for width scaling
                                const maxCount = Math.max(...sortedCategories.flatMap(([cat, data]) => Object.values(data.scores)));
                                
                                return sortedCategories.map(([category, data]) => {
                                    const averageScore = data.total > 0 ? 
                                        (Object.entries(data.scores).reduce((sum, [score, count]) => sum + (parseInt(score) * count), 0) / data.total).toFixed(1) : 0;
                                    
                                    return `
                                        <div class="category-row">
                                            <div class="category-name">${category}</div>
                                            <div class="category-bars">
                                                ${Object.entries(data.scores).filter(([score, count]) => count > 0).map(([score, count]) => {
                                                    const percentage = data.total > 0 ? ((count / data.total) * 100).toFixed(1) : 0;
                                                    const barWidth = maxCount > 0 ? Math.max((count / maxCount * 200), 25) : 25;
                                                    return `
                                                        <div class="category-bar" 
                                                             style="width: ${barWidth}px; 
                                                                    background: ${scoreColors[score]};" 
                                                             title="${category} - ${scoreLabels[score]}: ${count} alignment pairs (${percentage}%)">
                                                            ${count}
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                            <div class="category-info">
                                                ${data.total} pairs<br>
                                                <small>Avg: ${averageScore}</small>
                                            </div>
                                        </div>
                                    `;
                                }).join('');
                            })()}
                        </div>
                    </div>
                </div>
                
                <div class="alignment-insights">
                    <h3><i class="fas fa-lightbulb"></i> Action-Based Key Findings:</h3>
                    <ul>
                        ${weakAlignments > 0 ? `
                            <li><strong>Immediate Action Required:</strong> ${weakAlignments} alignments scored ≤2. Focus on strengthening ${lowScorePLOs.length > 0 ? 'PLOs ' + lowScorePLOs.slice(0, 3).join(', ') : 'these weak alignments'} through curriculum revision.</li>
                        ` : ''}
                        ${strongAlignments > totalAlignments * 0.6 ? `
                            <li><strong>Leverage Strength:</strong> ${highScoreModules.length > 0 ? 'Modules ' + highScoreModules.slice(0, 3).join(', ') : 'Strong performing modules'} demonstrate excellent alignment patterns. Use these as templates for improving weaker areas.</li>
                        ` : `
                            <li><strong>Strategic Enhancement Needed:</strong> Only ${coveragePercentage}% of alignments are strong. Implement systematic review of module learning outcomes to improve programme coherence.</li>
                        `}
                        ${improvableMLOs.length > 0 ? `
                            <li><strong>Module Optimization:</strong> Review and enhance MLOs ${improvableMLOs.slice(0, 3).join(', ')}${improvableMLOs.length > 3 ? ' and ' + (improvableMLOs.length - 3) + ' others' : ''} to better support programme outcomes.</li>
                        ` : ''}
                        ${averageScore >= 4 ? `
                            <li><strong>Quality Assurance:</strong> Maintain current high standards through regular monitoring and stakeholder feedback collection.</li>
                        ` : averageScore >= 3 ? `
                            <li><strong>Incremental Improvement:</strong> Implement targeted enhancements in lowest-scoring alignments to achieve excellence benchmark.</li>
                        ` : `
                            <li><strong>Comprehensive Review Required:</strong> Conduct systematic curriculum mapping workshop to fundamentally improve PLO-MLO alignment quality.</li>
                        `}
                    </ul>
                </div>
            `;
        }

        function renderPLOs() {
            const container = document.getElementById('plo-container');
            
            if (!currentPLOs || currentPLOs.length === 0) {
                container.innerHTML = '<p>No PLOs available for this programme.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'plo-table';
            
            // Header
            table.innerHTML = `
                <thead>
                    <tr>
                        <th class="code-col">Code</th>
                        <th class="content-col" onclick="togglePLOTable()" style="cursor: pointer;">
                            Learning Outcome <i id="plo-table-caret" class="fas fa-chevron-down" style="margin-left: 5px;"></i>
                        </th>
                    </tr>
                </thead>
                <tbody id="plo-table-body">
                    ${currentPLOs.map(plo => `
                        <tr>
                            <td class="plo-code code-col">${plo.plokood || 'PLO'}</td>
                            <td class="plo-description content-col">${currentLanguage === 'english' ? (plo.plosisuik || plo.plosisu) : (plo.plosisuek || plo.plosisu)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            
            container.innerHTML = '';
            container.appendChild(table);
        }

        function renderMLOs() {
            const container = document.getElementById('mlo-container');
            
            if (!currentMLOs || currentMLOs.length === 0) {
                container.innerHTML = '<p>No MLOs available for this programme.</p>';
                return;
            }

            // Group MLOs by module
            const mlosByModule = {};
            currentMLOs.forEach(mlo => {
                const moduleCode = mlo.mlokood.split('_')[0] || 'OTHER';
                if (!mlosByModule[moduleCode]) {
                    mlosByModule[moduleCode] = [];
                }
                mlosByModule[moduleCode].push(mlo);
            });

            let html = '';
            Object.entries(mlosByModule).forEach(([moduleCode, mlos]) => {
                html += `
                    <div class="module-section">
                        <h3>Module: ${moduleCode.toUpperCase()}</h3>
                        <table class="mlo-table">
                            <thead>
                                <tr>
                                    <th class="code-col">Code</th>
                                    <th class="content-col">Learning Outcome</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${mlos.map(mlo => `
                                    <tr>
                                        <td class="mlo-code code-col">${mlo.mlokood}</td>
                                        <td class="mlo-description content-col">${currentLanguage === 'english' ? (mlo.mlosisuik || mlo.mlosisu) : (mlo.mlosisuek || mlo.mlosisu)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderMatrix() {
            const container = document.getElementById('matrix-container');
            
            if (!alignmentResults || alignmentResults.length === 0) {
                container.innerHTML = '<p>No alignment data available.</p>';
                return;
            }

            // Create matrix
            const uniqueMLOs = [...new Set(alignmentResults.map(r => r.mlo.mlokood))];
            const uniquePLOs = [...new Set(alignmentResults.map(r => r.plo.plokood))];

            // Group MLOs by category and sort according to specified order
            const categoryOrder = ['YL', 'P1', 'P2', 'E1', 'E2', 'GD', 'VB', 'MN'];
            const mlosByCategory = {};
            
            uniqueMLOs.forEach(mloCode => {
                const category = mloCode.includes('_') ? 
                    mloCode.split('_')[0].toUpperCase() : 
                    mloCode.substring(0, 2).toUpperCase() || 'OTHER';
                    
                if (!mlosByCategory[category]) {
                    mlosByCategory[category] = [];
                }
                mlosByCategory[category].push(mloCode);
            });

            // Sort categories according to specified order
            const sortedCategories = [];
            categoryOrder.forEach(cat => {
                if (mlosByCategory[cat]) {
                    sortedCategories.push([cat, mlosByCategory[cat].sort()]);
                }
            });
            
            // Add any remaining categories
            Object.entries(mlosByCategory).forEach(([cat, mlos]) => {
                if (!categoryOrder.includes(cat)) {
                    sortedCategories.push([cat, mlos.sort()]);
                }
            });

            // Create sorted MLO list
            const sortedMLOs = sortedCategories.flatMap(([cat, mlos]) => mlos);

            let matrixHTML = `
                <table class="matrix-table">
                    <thead>
                        <!-- Category Header Row -->
                        <tr>
                            <th rowspan="2">PLO \\ MLO</th>
                            ${sortedCategories.map(([category, mlos]) => 
                                `<th colspan="${mlos.length}" style="background-color: var(--tt-dark-blue) !important; color: var(--tt-white) !important; text-align: center; font-weight: bold;">${category}</th>`
                            ).join('')}
                        </tr>
                        <!-- MLO Code Row -->
                        <tr>
                            ${sortedMLOs.map(mloCode => `<th class="mlo-header">${mloCode}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

            uniquePLOs.forEach(ploCode => {
                matrixHTML += `<tr><td class="plo-header">${ploCode}</td>`;
                sortedMLOs.forEach(mloCode => {
                    const result = alignmentResults.find(r => r.plo.plokood === ploCode && r.mlo.mlokood === mloCode);
                    const score = result ? result.score : 0;
                    const justification = result ? result.justification : 'No alignment data';
                    
                    matrixHTML += `<td class="score-cell score-${score}" 
                                      onclick="showAlignmentDetail('${ploCode}', '${mloCode}')" 
                                      title="${justification}">${score}</td>`;
                });
                matrixHTML += '</tr>';
            });

            matrixHTML += '</tbody></table>';
            container.innerHTML = matrixHTML;
        }

        function renderDetailedAnalysis() {
            const container = document.getElementById('detailed-container');
            
            if (currentView === 'plo') {
                renderPLOView(container);
            } else {
                renderMLOView(container);
            }
        }

        function renderPLOView(container) {
            let html = '';
            
            currentPLOs.forEach(plo => {
                const ploResults = alignmentResults.filter(r => r.plo.plokood === plo.plokood);
                const averageScore = ploResults.length > 0 ? 
                    (ploResults.reduce((sum, r) => sum + r.score, 0) / ploResults.length).toFixed(2) : 0;

                // Get all matching keywords for this PLO from all its MLO alignments
                const allMatchingKeywords = [...new Set(ploResults.flatMap(r => r.matchingKeywords || []))];
                const ploText = (currentLanguage === 'english' ? (plo.plosisuik || plo.plosisu) : (plo.plosisuek || plo.plosisu)) || '';
                const highlightedPLOText = highlightKeywords(ploText, allMatchingKeywords);

                html += `
                    <div class="plo-analysis-section">
                        <div class="plo-header-section">
                            <h3>${plo.plokood}: Average Alignment Score: ${averageScore}</h3>
                            <div class="plo-text">
                                ${highlightedPLOText}
                            </div>
                        </div>
                        
                        <table class="detailed-breakdown-table">
                            <thead>
                                <tr>
                                    <th>MLO Code</th>
                                    <th>MLO Content</th>
                                    <th>Score</th>
                                    <th>Justification & Analysis</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                ploResults.forEach(result => {
                    const ploText = (currentLanguage === 'english' ? (result.plo.plosisuik || result.plo.plosisu) : (result.plo.plosisuek || result.plo.plosisu)) || '';
                    const mloText = (currentLanguage === 'english' ? (result.mlo.mlosisuik || result.mlo.mlosisu) : (result.mlo.mlosisuek || result.mlo.mlosisu)) || '';
                    
                    const improvementSuggestions = generateImprovementSuggestions(
                        result.score, 
                        result.competencyMatches || [], 
                        result.keywordOverlap || 0,
                        mloText,
                        ploText
                    );
                    
                    html += `
                        <tr>
                            <td class="mlo-code-cell">${result.mlo.mlokood}</td>
                            <td class="mlo-content-cell">
                                ${result.highlightedMLO || mloText}
                            </td>
                            <td class="alignment-score-cell">
                                <span class="alignment-score score-${result.score}">${result.score}</span>
                            </td>
                            <td class="justification-cell">
                                <div style="font-size: 0.9em;">
                                    <div><strong>Keyword overlap:</strong> ${(result.keywordOverlap || 0).toFixed(1)}% 
                                    ${result.matchingKeywords && result.matchingKeywords.length > 0 ? 
                                        `(${result.matchingKeywords.slice(0, 3).join(', ')}${result.matchingKeywords.length > 3 ? '...' : ''})` : '(none)'}
                                    </div>
                                    <div style="margin-top: 4px;"><strong>Competency matches:</strong> ${result.competencyMatches && result.competencyMatches.length > 0 ? 
                                        `${result.competencyMatches.length} found (${result.competencyMatches.map(m => m.category).join(', ')})` : 'none detected'}
                                    </div>
                                    ${result.bloomsAlignment ? `<div style="margin-top: 4px;"><strong>Bloom's level:</strong> ${result.bloomsAlignment}</div>` : ''}
                                    ${improvementSuggestions && improvementSuggestions.length > 0 ? `
                                        <div style="margin-top: 8px; padding: 6px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
                                            <strong><i class="fas fa-lightbulb" style="color: #856404;"></i> Improvement Suggestions:</strong>
                                            <ul style="margin: 4px 0 0 0; padding-left: 16px;">
                                                ${improvementSuggestions.map(suggestion => `<li style="margin-bottom: 2px;">${suggestion}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderMLOView(container) {
            // Group MLOs by module prefix from mlokood
            const mlosByModule = {};
            currentMLOs.forEach(mlo => {
                // Extract module prefix from mlokood (e.g., "yl_mlo1" -> "YL")
                const mlokood = mlo.mlokood || '';
                const moduleCode = mlokood.includes('_') ? 
                    mlokood.split('_')[0].toUpperCase() : 
                    mlokood.substring(0, 2).toUpperCase() || 'OTHER';
                    
                if (!mlosByModule[moduleCode]) {
                    mlosByModule[moduleCode] = [];
                }
                mlosByModule[moduleCode].push(mlo);
            });

            let html = '';
            
            Object.entries(mlosByModule).forEach(([moduleCode, mlos]) => {
                html += `
                    <div class="module-section">
                        <h3>Module: ${moduleCode.toUpperCase()}</h3>
                        
                        <table class="detailed-breakdown-table">
                            <thead>
                                <tr>
                                    <th>PLO Code</th>
                                    <th>PLO Content</th>
                                    <th>Score</th>
                                    <th>Justification & Analysis</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                mlos.forEach(mlo => {
                    const mloResults = alignmentResults.filter(r => r.mlo.mlokood === mlo.mlokood);
                    const averageScore = mloResults.length > 0 ? 
                        (mloResults.reduce((sum, r) => sum + r.score, 0) / mloResults.length).toFixed(2) : 0;

                    // Add MLO header row with highlighted text
                    const mloText = (currentLanguage === 'english' ? (mlo.mlosisuik || mlo.mlosisu) : (mlo.mlosisuek || mlo.mlosisu)) || '';
                    const allMatchingKeywords = [...new Set(mloResults.flatMap(r => r.matchingKeywords || []))];
                    const highlightedMLOText = highlightKeywords(mloText, allMatchingKeywords);
                    
                    html += `
                        <tr style="background-color: var(--tt-grey-2);">
                            <td colspan="4" style="font-weight: bold; padding: 15px;">
                                <strong>${mlo.mlokood}: Average Score: ${averageScore}</strong><br>
                                <em>MLO: ${highlightedMLOText}</em>
                            </td>
                        </tr>
                    `;
                    
                    mloResults.forEach(result => {
                        const ploText = (currentLanguage === 'english' ? (result.plo.plosisuik || result.plo.plosisu) : (result.plo.plosisuek || result.plo.plosisu)) || '';
                        const mloText = (currentLanguage === 'english' ? (mlo.mlosisuik || mlo.mlosisu) : (mlo.mlosisuek || mlo.mlosisu)) || '';
                        
                        const improvementSuggestions = generateImprovementSuggestions(
                            result.score, 
                            result.competencyMatches || [], 
                            result.keywordOverlap || 0,
                            mloText,
                            ploText
                        );
                        
                        html += `
                            <tr>
                                <td class="mlo-code-cell">${result.plo.plokood}</td>
                                <td class="mlo-content-cell">
                                    ${result.matchingKeywords ? highlightKeywords(ploText, result.matchingKeywords) : ploText}
                                </td>
                                <td class="alignment-score-cell">
                                    <span class="alignment-score score-${result.score}">${result.score}</span>
                                </td>
                                <td class="justification-cell">
                                    <div class="alignment-justification">${result.justification}</div>
                                    <div style="margin-top: 8px;">
                                        <small><strong>Keyword overlap:</strong> ${(result.keywordOverlap || 0).toFixed(1)}% 
                                        ${result.matchingKeywords && result.matchingKeywords.length > 0 ? 
                                            `(${result.matchingKeywords.slice(0, 3).join(', ')}${result.matchingKeywords.length > 3 ? '...' : ''})` : '(none)'}
                                        </small><br>
                                        <small><strong>Competency matches:</strong> ${result.competencyMatches && result.competencyMatches.length > 0 ? 
                                            `${result.competencyMatches.length} found (${result.competencyMatches.map(m => m.category).join(', ')})` : 'none detected'}
                                        </small>
                                    </div>
                                    ${improvementSuggestions && improvementSuggestions.length > 0 ? `
                                        <div style="margin-top: 8px; padding: 6px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
                                            <strong><i class="fas fa-lightbulb" style="color: #856404;"></i> Improvement Suggestions:</strong>
                                            <ul style="margin: 4px 0 0 0; padding-left: 16px;">
                                                ${improvementSuggestions.map(suggestion => `<li style="margin-bottom: 2px;">${suggestion}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </td>
                            </tr>
                        `;
                    });
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function setupEventListeners() {
            // Language toggle
            const languageToggle = document.getElementById('language-toggle');
            const estLabel = document.getElementById('est-label');
            const engLabel = document.getElementById('eng-label');

            languageToggle.addEventListener('change', function() {
                currentLanguage = this.checked ? 'english' : 'estonian';
                
                if (currentLanguage === 'english') {
                    engLabel.classList.add('active');
                    engLabel.classList.remove('inactive');
                    estLabel.classList.add('inactive');
                    estLabel.classList.remove('active');
                } else {
                    estLabel.classList.add('active');
                    estLabel.classList.remove('inactive');
                    engLabel.classList.add('inactive');
                    engLabel.classList.remove('active');
                }

                // Re-render content
                renderPLOs();
                renderMLOs();
                renderDetailedAnalysis();
            });

            // Initialize language labels
            engLabel.classList.add('active');
            estLabel.classList.add('inactive');

            // Floating home button
            document.getElementById('home-btn-float').addEventListener('click', () => {
                window.location.href = 'index.html';
            });

            // View toggle
            document.getElementById('view-toggle-btn').addEventListener('click', function() {
                currentView = currentView === 'plo' ? 'mlo' : 'plo';
                this.innerHTML = currentView === 'plo' ? 
                    '<i class="fas fa-exchange-alt"></i> Switch to MLO View' : 
                    '<i class="fas fa-exchange-alt"></i> Switch to PLO View';
                renderDetailedAnalysis();
            });

            // Back to top
            const backToTopBtn = document.getElementById('back-to-top');
            window.addEventListener('scroll', () => {
                if (window.pageYOffset > 300) {
                    backToTopBtn.classList.add('visible');
                } else {
                    backToTopBtn.classList.remove('visible');
                }
            });

            backToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // Export buttons
            document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
            document.getElementById('export-plo-mlo-btn').addEventListener('click', exportReport);
        }

        function showAlignmentDetail(ploCode, mloCode) {
            const result = alignmentResults.find(r => r.plo.plokood === ploCode && r.mlo.mlokood === mloCode);
            if (result) {
                alert(`PLO: ${ploCode}\nMLO: ${mloCode}\nScore: ${result.score}\n\nJustification: ${result.justification}`);
            }
        }

        function scrollToMethodology() {
            document.getElementById('methodology').scrollIntoView({ behavior: 'smooth' });
        }

        function togglePLOTable() {
            const tableBody = document.getElementById('plo-table-body');
            const caret = document.getElementById('plo-table-caret');
            
            if (tableBody && caret) {
                if (tableBody.style.display === 'none') {
                    tableBody.style.display = '';
                    caret.className = 'fas fa-chevron-down';
                } else {
                    tableBody.style.display = 'none';
                    caret.className = 'fas fa-chevron-right';
                }
            }
        }

        function exportToExcel() {
            // Create CSV data for Excel export
            const csvData = generateCSVData();
            const programmeCode = currentProgramme ? (currentProgramme.kavakood || currentProgramme.programmeCode || 'programme') : 'programme';
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
            const fileName = `${programmeCode}-plo-mlo-alignment-matrix-${today}.csv`;
            downloadCSV(csvData, fileName);
        }

        function generateCSVData() {
            if (!alignmentResults || alignmentResults.length === 0) return '';

            // Use the same sorting logic as in renderMatrix
            const uniqueMLOs = [...new Set(alignmentResults.map(r => r.mlo.mlokood))];
            const uniquePLOs = [...new Set(alignmentResults.map(r => r.plo.plokood))];

            // Group MLOs by category and sort according to specified order
            const categoryOrder = ['YL', 'P1', 'P2', 'E1', 'E2', 'GD', 'VB', 'MN'];
            const mlosByCategory = {};
            
            uniqueMLOs.forEach(mloCode => {
                const category = mloCode.includes('_') ? 
                    mloCode.split('_')[0].toUpperCase() : 
                    mloCode.substring(0, 2).toUpperCase() || 'OTHER';
                    
                if (!mlosByCategory[category]) {
                    mlosByCategory[category] = [];
                }
                mlosByCategory[category].push(mloCode);
            });

            // Sort categories according to specified order
            const sortedCategories = [];
            categoryOrder.forEach(cat => {
                if (mlosByCategory[cat]) {
                    sortedCategories.push([cat, mlosByCategory[cat].sort()]);
                }
            });
            
            // Add any remaining categories
            Object.entries(mlosByCategory).forEach(([cat, mlos]) => {
                if (!categoryOrder.includes(cat)) {
                    sortedCategories.push([cat, mlos.sort()]);
                }
            });

            // Create sorted MLO list
            const sortedMLOs = sortedCategories.flatMap(([cat, mlos]) => mlos);

            let csvContent = 'PLO\\MLO,' + sortedMLOs.join(',') + '\n';

            uniquePLOs.forEach(ploCode => {
                let row = ploCode;
                sortedMLOs.forEach(mloCode => {
                    const result = alignmentResults.find(r => r.plo.plokood === ploCode && r.mlo.mlokood === mloCode);
                    const score = result ? result.score : 0;
                    row += ',' + score;
                });
                csvContent += row + '\n';
            });

            return csvContent;
        }

        function downloadCSV(csvContent, fileName) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function exportReport() {
            // Generate full HTML content including detailed analysis
            const htmlContent = generateCompleteReportHTML();
            
            // Open in a new tab
            const newWindow = window.open('', '_blank');
            newWindow.document.write(htmlContent);
            newWindow.document.close();
        }

        function showPdfPreview() {
            const modal = document.getElementById('pdf-preview-modal');
            const iframe = document.getElementById('pdf-preview-iframe');
            
            // Generate HTML content for preview
            const previewContent = generatePreviewHTML();
            
            // Create a blob URL for the preview
            const blob = new Blob([previewContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            iframe.src = url;
            modal.style.display = 'flex';
            
            // Close modal when clicking outside content
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closePdfPreview();
                }
            });
            
            // Cleanup URL after modal is closed
            modal.addEventListener('transitionend', () => {
                if (modal.style.display === 'none') {
                    URL.revokeObjectURL(url);
                }
            }, { once: true });
        }

        function closePdfPreview() {
            const modal = document.getElementById('pdf-preview-modal');
            modal.style.display = 'none';
        }

        function savePdfReport() {
            // Generate PDF filename with programme code and date
            const programmeCode = currentProgramme ? (currentProgramme.kavakood || currentProgramme.programmeCode || 'programme') : 'programme';
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
            const fileName = `${programmeCode}-plo-mlo-alignment-report-${today}.pdf`;
            
            // Create full HTML content for PDF
            const htmlContent = generatePDFHTML();
            
            // Use the browser's print functionality to save as PDF
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            // Trigger print dialog (user can choose "Save as PDF")
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
            
            // Close the preview modal
            closePdfPreview();
        }

        function generatePreviewHTML() {
            const programmeCode = currentProgramme ? (currentProgramme.kavakood || currentProgramme.programmeCode || 'Unknown') : 'Unknown';
            const programmeName = currentProgramme ? (currentProgramme.programmeNameEng || currentProgramme.programmeName || 'Programme') : 'Programme';
            const today = new Date().toLocaleDateString();
            
            return `
<!DOCTYPE html>
<html>
<head>
    <title>PLO-MLO Alignment Report - ${programmeCode}</title>
    <style>
        body { 
            font-family: 'Arial', sans-serif; 
            margin: 20px; 
            line-height: 1.6; 
            color: #333;
        }
        .header { 
            text-align: center; 
            margin-bottom: 30px; 
            border-bottom: 3px solid #aa1352;
            padding-bottom: 20px;
        }
        .header h1 { 
            color: #aa1352; 
            margin: 0;
            font-size: 24px;
        }
        .header p { 
            margin: 10px 0 5px 0; 
            font-size: 16px;
            color: #666;
        }
        .legend { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 20px 0;
            border-left: 4px solid #aa1352;
        }
        .legend h3 { 
            margin-top: 0; 
            color: #aa1352;
        }
        .summary-stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin: 20px 0;
        }
        .stat-card { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .stat-number { 
            font-size: 24px; 
            font-weight: bold; 
            color: #aa1352;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 20px 0;
            font-size: 12px;
        }
        th, td { 
            border: 1px solid #dee2e6; 
            padding: 8px; 
            text-align: center;
        }
        th { 
            background: #aa1352; 
            color: white; 
            font-weight: bold;
        }
        .score-1 { background-color: #ffcdd2; }
        .score-2 { background-color: #ffecb3; }
        .score-3 { background-color: #fff9c4; }
        .score-4 { background-color: #c8e6c9; }
        .score-5 { background-color: #a5d6a7; }
        .plo-header { 
            background: #f8f9fa !important; 
            color: #aa1352 !important;
            text-align: left !important;
            font-weight: bold;
        }
        @media print {
            body { margin: 0; }
            .header { page-break-after: avoid; }
            table { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Programme-Module Learning Outcomes Alignment Report</h1>
        <p><strong>Programme:</strong> ${programmeCode} - ${programmeName}</p>
        <p><strong>Generated:</strong> ${today}</p>
    </div>

    <div class="legend">
        <h3>Alignment Score Legend</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
            <span style="background: #ffcdd2; padding: 5px 10px; border-radius: 15px;">1: Minimal alignment</span>
            <span style="background: #ffecb3; padding: 5px 10px; border-radius: 15px;">2: Partial alignment</span>
            <span style="background: #fff9c4; padding: 5px 10px; border-radius: 15px;">3: Moderate alignment</span>
            <span style="background: #c8e6c9; padding: 5px 10px; border-radius: 15px;">4: Strong alignment</span>
            <span style="background: #a5d6a7; padding: 5px 10px; border-radius: 15px;">5: Excellent alignment</span>
        </div>
    </div>

    ${generateMatrixHTML()}

    <div style="margin-top: 40px; text-align: center; color: #666; border-top: 2px solid #dee2e6; padding-top: 20px;">
        <p>Report generated by TalTech PLO-MLO Alignment Tool</p>
    </div>
</body>
</html>`;
        }

        function generatePDFHTML() {
            return generatePreviewHTML(); // Same content for PDF
        }

        function generateMatrixHTML() {
            if (!alignmentResults || alignmentResults.length === 0) {
                return '<p>No alignment data available.</p>';
            }

            const totalAlignments = alignmentResults.length;
            const averageScore = (alignmentResults.reduce((sum, result) => sum + result.score, 0) / totalAlignments).toFixed(2);
            
            // Generate summary statistics
            const scoreDistribution = [1,2,3,4,5].map(score => ({
                score,
                count: alignmentResults.filter(r => r.score === score).length,
                percentage: ((alignmentResults.filter(r => r.score === score).length / totalAlignments) * 100).toFixed(1)
            }));

            let html = `
    <div class="summary-stats">
        <div class="stat-card">
            <div class="stat-number">${totalAlignments}</div>
            <div>Total Alignments</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${averageScore}</div>
            <div>Average Score</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${currentPLOs.length}</div>
            <div>Programme LOs</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${currentMLOs.length}</div>
            <div>Module LOs</div>
        </div>
    </div>

    <h3 style="color: #aa1352; margin-top: 30px;">PLO-MLO Alignment Matrix</h3>
    <table>`;

            // Generate the same matrix table as in the main view
            const uniqueMLOs = [...new Set(alignmentResults.map(r => r.mlo.mlokood))];
            const uniquePLOs = [...new Set(alignmentResults.map(r => r.plo.plokood))];

            // Sort MLOs by category
            const categoryOrder = ['YL', 'P1', 'P2', 'E1', 'E2', 'GD', 'VB', 'MN'];
            const mlosByCategory = {};
            
            uniqueMLOs.forEach(mloCode => {
                const category = mloCode.includes('_') ? 
                    mloCode.split('_')[0].toUpperCase() : 
                    mloCode.substring(0, 2).toUpperCase() || 'OTHER';
                    
                if (!mlosByCategory[category]) {
                    mlosByCategory[category] = [];
                }
                mlosByCategory[category].push(mloCode);
            });

            const sortedMLOs = [];
            categoryOrder.forEach(cat => {
                if (mlosByCategory[cat]) {
                    sortedMLOs.push(...mlosByCategory[cat].sort());
                }
            });

            // Add remaining categories not in the specified order
            Object.keys(mlosByCategory).forEach(cat => {
                if (!categoryOrder.includes(cat)) {
                    sortedMLOs.push(...mlosByCategory[cat].sort());
                }
            });

            // Table header
            html += '<thead><tr><th style="width: 150px;">PLO / MLO</th>';
            sortedMLOs.forEach(mloCode => {
                html += '<th style="width: 60px; font-size: 10px;">' + mloCode + '</th>';
            });
            html += '</tr></thead><tbody>';

            // Table rows
            uniquePLOs.sort().forEach(ploCode => {
                html += '<tr><td class="plo-header">' + ploCode + '</td>';
                sortedMLOs.forEach(mloCode => {
                    const result = alignmentResults.find(r => r.plo.plokood === ploCode && r.mlo.mlokood === mloCode);
                    if (result) {
                        html += '<td class="score-' + result.score + '"><strong>' + result.score + '</strong></td>';
                    } else {
                        html += '<td>-</td>';
                    }
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        function generateReportContent() {
            const totalAlignments = alignmentResults.length;
            const averageScore = (alignmentResults.reduce((sum, result) => sum + result.score, 0) / totalAlignments).toFixed(2);
            
            let reportContent = `PLO-MLO ALIGNMENT ANALYSIS REPORT\n`;
            reportContent += `Generated: ${new Date().toLocaleString()}\n`;
            reportContent += `Programme: ${currentProgramme ? currentProgramme.programmeNameEng || currentProgramme.programmeName : 'N/A'}\n\n`;
            
            reportContent += `SUMMARY STATISTICS:\n`;
            reportContent += `Total Alignments: ${totalAlignments}\n`;
            reportContent += `Average Alignment Score: ${averageScore}\n\n`;
            
            reportContent += `PLO-MLO ALIGNMENT MATRIX:\n`;
            const csvData = generateCSVData();
            reportContent += csvData + '\n';
            
            reportContent += `DETAILED ANALYSIS:\n`;
            currentPLOs.forEach(plo => {
                const ploResults = alignmentResults.filter(r => r.plo.plokood === plo.plokood);
                const averageScore = ploResults.length > 0 ? 
                    (ploResults.reduce((sum, r) => sum + r.score, 0) / ploResults.length).toFixed(2) : 0;
                
                reportContent += `\nPLO ${plo.plokood} (Average: ${averageScore}):\n`;
                reportContent += `${plo.plosisuik || plo.plosisu}\n`;
                
                ploResults.forEach(result => {
                    reportContent += `  - MLO ${result.mlo.mlokood}: ${result.score} - ${result.justification}\n`;
                });
            });
            
            return reportContent;
        }

        function downloadTextFile(content, fileName) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function generateCompleteReportHTML() {
            const programmeCode = currentProgramme ? (currentProgramme.kavakood || currentProgramme.programmeCode || 'Unknown') : 'Unknown';
            const programmeName = currentProgramme ? (currentProgramme.programmeNameEng || currentProgramme.programmeName || 'Programme') : 'Programme';
            const today = new Date().toLocaleDateString();
            
            // Get the current content from the visible page
            const summaryContent = document.getElementById('summary-content').innerHTML;
            const matrixContent = document.getElementById('matrix-container').innerHTML;
            const detailedContent = document.getElementById('detailed-container').innerHTML;
            const ploContent = document.getElementById('plo-container').innerHTML;
            const mloContent = document.getElementById('mlo-container').innerHTML;
            const methodologyContent = document.querySelector('#methodology .summary-content').innerHTML;
            
            return `
<!DOCTYPE html>
<html>
<head>
    <title>PLO-MLO Alignment Report - ${programmeCode}</title>
    <style>
        body { 
            font-family: 'Arial', sans-serif; 
            margin: 20px; 
            line-height: 1.6; 
            color: #333;
        }
        .header { 
            text-align: center; 
            margin-bottom: 30px; 
            border-bottom: 3px solid #aa1352;
            padding-bottom: 20px;
        }
        .header h1 { 
            color: #aa1352; 
            margin: 0;
            font-size: 24px;
        }
        .header p { 
            margin: 10px 0 5px 0; 
            font-size: 16px;
            color: #666;
        }
        .section { 
            margin: 30px 0; 
        }
        .section h2 { 
            color: #aa1352; 
            border-bottom: 2px solid #aa1352; 
            padding-bottom: 10px;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 20px 0;
            font-size: 11px;
        }
        th, td { 
            border: 1px solid #dee2e6; 
            padding: 6px; 
            text-align: left;
            vertical-align: top;
        }
        th { 
            background: #aa1352; 
            color: white; 
            font-weight: bold;
            text-align: center;
        }
        .score-1 { background-color: #ffcdd2; text-align: center; }
        .score-2 { background-color: #ffecb3; text-align: center; }
        .score-3 { background-color: #fff9c4; text-align: center; }
        .score-4 { background-color: #c8e6c9; text-align: center; }
        .score-5 { background-color: #a5d6a7; text-align: center; }
        .plo-header, .mlo-header { 
            background: #f8f9fa !important; 
            color: #aa1352 !important;
            text-align: left !important;
            font-weight: bold;
        }
        .chart-container { 
            display: flex; 
            gap: 10px; 
            margin: 10px 0; 
        }
        .chart-bar { 
            padding: 5px; 
            border-radius: 4px; 
            min-width: 60px; 
            text-align: center; 
            font-size: 10px;
        }
        .keyword-highlight { 
            background-color: #ffeb3b; 
            padding: 1px 3px; 
            border-radius: 3px; 
            font-weight: bold; 
        }
        .improvement-suggestions {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 6px;
            margin-top: 8px;
            font-size: 10px;
        }
        .detailed-breakdown-table {
            font-size: 10px;
        }
        .justification-cell {
            font-size: 9px;
            max-width: 200px;
        }
        @media print {
            body { margin: 0; font-size: 10px; }
            .header { page-break-after: avoid; }
            table { page-break-inside: auto; }
            tr { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Programme-Module Learning Outcomes Alignment Report</h1>
        <p><strong>Programme:</strong> ${programmeCode} - ${programmeName}</p>
        <p><strong>Generated:</strong> ${today}</p>
    </div>

    <div class="section">
        <h2>Methodology</h2>
        ${methodologyContent}
    </div>

    <div class="section">
        <h2>Alignment Summary</h2>
        ${summaryContent}
    </div>

    <div class="section">
        <h2>Programme Learning Outcomes (PLOs)</h2>
        ${ploContent}
    </div>

    <div class="section">
        <h2>Module Learning Outcomes (MLOs)</h2>
        ${mloContent}
    </div>

    <div class="section">
        <h2>Alignment Matrix</h2>
        ${matrixContent}
    </div>

    <div class="section">
        <h2>Detailed Breakdown Analysis</h2>
        ${detailedContent}
    </div>
</body>
</html>`;
        }

        function showError(message) {
            alert(message);
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', init);
    </script>

    <!-- PDF Preview Modal -->
    <div id="pdf-preview-modal" class="pdf-preview-modal">
        <div class="pdf-preview-content">
            <div class="pdf-preview-header">
                <h3><i class="fas fa-file-pdf"></i> Report Preview</h3>
                <button class="pdf-preview-close" onclick="closePdfPreview()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="pdf-preview-body">
                <iframe id="pdf-preview-iframe" class="pdf-preview-iframe"></iframe>
            </div>
            <div class="pdf-preview-actions">
                <button class="pdf-action-btn pdf-cancel-btn" onclick="closePdfPreview()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="pdf-action-btn pdf-save-btn" onclick="savePdfReport()">
                    <i class="fas fa-download"></i> Save as PDF
                </button>
            </div>
        </div>
    </div>
</body>
</html>
