<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="css/clo-mlo-style.css">
    <link rel="stylesheet" href="css/plo-mlo-style.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLO-MLO Alignment Analysis</title>
    
    <!-- TalTech CVI Typography -->
    <link href="https://fonts.googleapis.com/css2?family=Proxima+Nova:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
</head>
<body>
    <div class="container">
        <!-- Page Header -->
        <header class="page-header">
            <div class="header-links">
                <a href="methodology.html" class="methodology-link-btn" target="_blank">
                    <i class="fas fa-book"></i>
                    View Methodology
                </a>
                <a href="index.html" class="home-link-btn">
                    <i class="fas fa-home"></i>
                    Home
                </a>
            </div>
            <h1 id="page-title"><i class="fas fa-clipboard-list"></i> </h1>
            <p>Course Learning Outcomes to Module Learning Outcomes Analysis</p>
        </header>

        <!-- Advanced Methodology Section -->
        <section id="methodology" class="methodology-section" style="display: none;">
            <div class="methodology-header">
                <i class="fas fa-cogs"></i>
                <h2>CLO-MLO Alignment Assessment
                    <a href="methodology.html" target="_blank" title="View detailed methodology" style="margin-left:10px; vertical-align:middle;">
                        <i class="fas fa-external-link-alt" style="font-size:0.9em;"></i>
                    </a>
                </h2>
            </div>
            <div class="methodology-content">
                <p>This alignment analysis employs a research-based multi-dimensional approach with transparent mathematical scoring:</p>
                
                <h4><i class="fas fa-brain"></i> Analysis Components:</h4>
                <ul>
                    <li><strong>Semantic Analysis (35% weight):</strong> Quantitative text analysis measuring vocabulary overlap and conceptual alignment between CLO and MLO texts with keyword highlighting</li>
                    <li><strong>Competency Framework (25% weight):</strong> Evidence-based evaluation across 10 competency categories derived from EQF Level 6-8 descriptors and Tuning Educational Structures</li>
                    <li><strong>Bloom's Taxonomy Mapping (20% weight):</strong> Systematic cognitive level assessment using Krathwohl's 2002 revision with progression compatibility scoring</li>
                    <li><strong>Contextual Relevance (15% weight):</strong> Domain-specific terminology analysis with weighted business education vocabulary and thematic coherence evaluation</li>
                    <li><strong>Learning Progression (5% weight):</strong> Sequential building pattern assessment analyzing prerequisite relationships and modular learning pathways</li>
                </ul>
                
                <h4><i class="fas fa-calculator"></i> Mathematical Scoring Algorithm:</h4>
                <div class="methodology-details">
                    <p><strong>Composite Score Formula:</strong></p>
                    <div class="formula-display">
                        <code>Score = (Semantic × 0.35) + (Competency × 0.25) + (Cognitive × 0.20) + (Contextual × 0.15) + (Progression × 0.05)</code>
                    </div>
                    
                    <p><strong>Component Normalization:</strong></p>
                    <ul>
                        <li><strong>Semantic:</strong> Keyword overlap % / 4 (20% overlap = 5.0 points)</li>
                        <li><strong>Competency:</strong> Weighted category matches × 1.5 (max 3.33 weight = 5.0 points)</li>
                        <li><strong>Cognitive:</strong> Bloom's progression compatibility (0-1) × 5</li>
                        <li><strong>Contextual:</strong> Domain relevance score (direct 0-5 mapping)</li>
                        <li><strong>Progression:</strong> Building pattern strength (0-1) × 5</li>
                    </ul>
                    
                    <p><strong>Research-Based Thresholds:</strong></p>
                    <ul></ul>
                        <li><strong>4.5-5.0 (Excellent):</strong> Strong alignment across all dimensions with clear progression</li>
                        <li><strong>3.5-4.4 (Good):</strong> Solid alignment with minor gaps in 1-2 dimensions</li>
                        <li><strong>2.5-3.4 (Moderate):</strong> Adequate alignment requiring targeted improvements</li>
                        <li><strong>1.5-2.4 (Weak):</strong> Limited alignment needing significant enhancement</li>
                        <li><strong>1.0-1.4 (Poor):</strong> Minimal alignment requiring fundamental restructuring</li>
                    </ul>
                </div>
                
                <h4><i class="fas fa-tags"></i> Keyword Highlighting & Evidence:</h4>
                <p>Matching keywords and phrases are highlighted in both CLO and MLO texts to provide visual evidence of semantic alignment. All scoring components include quantifiable evidence and mathematical justification.</p>
                
                <h4><i class="fas fa-book-open"></i> Methodology Sources:</h4>
                <ul>
                    <li>Krathwohl, D.R. (2002). A revision of Bloom's taxonomy</li>
                    <li>European Qualifications Framework (EQF) Level 6-8 Descriptors</li>
                    <li>Tuning Educational Structures in Europe</li>
                    <li>Learning Progression Theory (Heritage, 2008)</li>
                </ul>
                
                <div class="score-legend">
                    <h4>Score Range & Quality Thresholds:</h4>
                    <div class="score-item"><span class="score-color score-1"></span> Poor (1.0-1.4)</div>
                    <div class="score-item"><span class="score-color score-2"></span> Weak (1.5-2.4)</div>
                    <div class="score-item"><span class="score-color score-3"></span> Moderate (2.5-3.4)</div>
                    <div class="score-item"><span class="score-color score-4"></span> Good (3.5-4.4)</div>
                    <div class="score-item"><span class="score-color score-5"></span> Excellent (4.5-5.0)</div>
                </div>
            </div>
        </section>

        <main>
            <!-- Course Selection Section -->
            <section id="course-selection-section">
                <h2><i class="fas fa-search"></i> Course Selection</h2>
                <div class="form-group">
                    <label for="course-selector">Select Course</label>
                    <select id="course-selector" class="form-select">
                        <option value="">Choose a course...</option>
                    </select>
                </div>
            </section>
            <!-- New Course Button (hidden by default, shown after selection) -->
            <div id="new-course-btn-container" class="form-actions" style="display:none; justify-content:flex-end;">
                <button id="new-course-btn" class="btn btn-secondary"><i class="fas fa-plus"></i> Start Another Course</button>
            </div>

            <!-- Course Information Section -->
            <section id="course-information-section" class="hidden">
                <h2><i class="fas fa-info-circle"></i> Course Information</h2>
                
                <div class="course-info-grid">
                    <div class="info-card">
                        <h4>Course Details</h4>
                        <div class="info-item">
                            <span class="info-label">Course Code:</span>
                            <span id="info-course-code" class="info-value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Course Name (EN):</span>
                            <span id="info-course-name-en" class="info-value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Course Name (ET):</span>
                            <span id="info-course-name-et" class="info-value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">EAP Credits:</span>
                            <span id="info-course-eap" class="info-value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Module Codes:</span>
                            <span id="info-course-modules" class="info-value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Assessment Form:</span>
                            <span id="info-course-assessment" class="info-value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Course Type:</span>
                            <span id="info-course-type" class="info-value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Course URL:</span>
                            <a id="info-course-url" class="info-link" href="#" target="_blank">View Course</a>
                        </div>
                    </div>

                    <div class="info-card">
                        <h4>Course Aims</h4>
                        <div id="info-course-aims" class="course-aims-content">
                            Select a course to view aims...
                        </div>
                    </div>
                </div>
            </section>

            <!-- CLO Management Section -->
            <!-- Module Content Section (shown before CLOs, with caret toggle) -->
            <section id="module-content-section" class="hidden">
                <div class="section-header" style="display:flex;align-items:center;gap:1rem;cursor:pointer;" onclick="toggleModuleContent()">
                    <h2 style="margin-bottom:0;"><i class="fas fa-cubes"></i> Module Content</h2>
                    <i id="module-caret" class="fas fa-chevron-down"></i>
                </div>
                <div id="module-content-list" style="display:block; margin-top:1rem;"></div>
            </section>

            <!-- Existing Course Learning Outcomes Section -->
            <section id="existing-clos-section" class="hidden">
                <h2><i class="fas fa-list-check"></i> Existing Course Learning Outcomes</h2>
                <div class="info-card full-width">
                    <div id="info-existing-clos" class="existing-clos-content">
                        Select a course to view CLOs...
                    </div>
                </div>
                
                <!-- Main CLO-MLO Analysis Button -->
                <div id="main-analysis-button-container" class="form-actions" style="display:none; justify-content:center; margin-top: 20px;">
                    <button id="main-analysis-btn" class="btn btn-primary btn-large" onclick="performAlignment()" 
                            style="display: none; background: linear-gradient(135deg, #aa1352, #e4067e); border: none; padding: 12px 30px; font-size: 16px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">
                        <i class="fas fa-chart-line"></i> Analyse CLO-MLO Alignment
                    </button>
                </div>
            </section>

            <section id="clo-management-section" class="hidden">
                <h2><i class="fas fa-cogs"></i> CLO Management</h2>
                
                <div class="clo-options">
                    <div class="option-card" id="edit-existing-clos">
                        <div class="option-icon">
                            <i class="fas fa-edit"></i>
                        </div>
                        <div class="option-content">
                            <h3>Edit Existing CLOs</h3>
                            <p>Modify the current CLOs for this course</p>
                        </div>
                        <button class="option-btn">Edit CLOs</button>
                    </div>

                    <div class="option-card" id="manual-entry-clos">
                        <div class="option-icon">
                            <i class="fas fa-keyboard"></i>
                        </div>
                        <div class="option-content">
                            <h3>Manual Entry</h3>
                            <p>Enter new CLOs manually</p>
                        </div>
                        <button class="option-btn">Manual Entry</button>
                    </div>

                </div>
            </section>

            <!-- CLO Editor Section -->
            <section id="clo-editor-section" class="content-section hidden">
                <div class="section-header">
                    <h3 id="clo-editor-title">Edit CLOs</h3>
                    <p class="section-description">Edit or create course learning outcomes below.</p>
                </div>

                <div class="clo-editor">
                    <div id="clo-editor-container" class="clo-editor-container">
                        <!-- CLO fields will be dynamically added here -->
                    </div>
                    
                    <div class="clo-editor-actions">
                        <button id="add-clo-field-btn" class="btn btn-secondary" onclick="addNewCLOField()">
                            <i class="fas fa-plus"></i> Add CLO
                        </button>
                        <div class="button-group">
                            <button id="save-clos-btn" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save CLOs
                            </button>
                            <button id="cancel-edit-btn" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </section>
            <section id="clo-editor-section" class="hidden">
                <h3><i class="fas fa-edit"></i> CLO Editor</h3>
                <div id="clo-editor-content">
                    <!-- CLO editing interface will be dynamically generated -->
                </div>
                <div class="form-actions">
                    <button id="save-clos-btn" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save CLOs
                    </button>
                    <button id="cancel-edit-btn" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </section>

            <!-- Analysis Results Section -->
            <section id="analysis-results-section" class="content-section hidden">
                <div class="section-header">
                    <h3><i class="fas fa-chart-bar"></i> CLO-MLO Alignment Analysis Report</h3>
                    <p class="section-description">Comprehensive analysis showing how well course learning outcomes align with module learning outcomes.</p>
                    
                    <div class="analysis-controls">
                        <div class="control-group">
                            <button id="ai-analysis-btn" class="btn btn-primary" onclick="performAlignment()" style="display: none;">
                                <i class="fas fa-robot"></i> TalTech AI Analysis
                            </button>
                            <button id="download-report-btn" class="btn btn-primary">
                                <i class="fas fa-file-pdf"></i> Download CLO-MLO Report
                            </button>
                            <button id="back-to-clo-management" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to CLO Management
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sticky Navigation -->
                <nav class="analysis-nav" id="analysis-nav">
                    <ul>
                        <li><a href="#methodology-info"><i class="fas fa-cogs"></i> Methodology</a></li>
                        <li><a href="#summary-section"><i class="fas fa-chart-bar"></i> Summary</a></li>
                        <li><a href="#matrix-section"><i class="fas fa-table"></i> Matrix</a></li>
                        <li><a href="#detailed-breakdown-section"><i class="fas fa-list-alt"></i> Detailed Breakdown</a></li>
                    </ul>
                </nav>

                <!-- Methodology Information Section -->
                <div id="methodology-info" class="analysis-section">
                    <h4><i class="fas fa-cogs"></i> CLO-MLO Alignment Methodology</h4>
                    <div class="methodology-content">
                        <p>This alignment analysis employs a research-based multi-dimensional approach with transparent mathematical scoring:</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
                            <div style="background: #f8f9fa; padding: 15px; border-left: 4px solid var(--tt-burgundy); border-radius: 4px;">
                                <h5><i class="fas fa-brain"></i> Semantic Analysis (35%)</h5>
                                <p style="font-size: 0.9em; margin: 0;">Vocabulary overlap and conceptual alignment between CLO and MLO texts</p>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-left: 4px solid var(--tt-magenta); border-radius: 4px;">
                                <h5><i class="fas fa-graduation-cap"></i> Competency Framework (25%)</h5>
                                <p style="font-size: 0.9em; margin: 0;">EQF-based skill mapping and competency analysis</p>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-left: 4px solid var(--tt-light-blue); border-radius: 4px;">
                                <h5><i class="fas fa-layer-group"></i> Cognitive Progression (20%)</h5>
                                <p style="font-size: 0.9em; margin: 0;">Bloom's Taxonomy level assessment and progression logic</p>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-left: 4px solid var(--tt-dark-blue); border-radius: 4px;">
                                <h5><i class="fas fa-tags"></i> Contextual Relevance (15%)</h5>
                                <p style="font-size: 0.9em; margin: 0;">Domain-specific terminology and programme alignment</p>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-left: 4px solid var(--tt-grey-1); border-radius: 4px;">
                                <h5><i class="fas fa-arrow-up"></i> Learning Progression (5%)</h5>
                                <p style="font-size: 0.9em; margin: 0;">Sequential building patterns and prerequisite relationships</p>
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 15px; border-radius: 8px; margin: 20px 0;">
                            <h5><i class="fas fa-calculator"></i> Score Range & Quality Thresholds:</h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                                <span style="padding: 4px 8px; background: #dc3545; color: white; border-radius: 3px; font-size: 0.85em;">Poor (1.0-1.4)</span>
                                <span style="padding: 4px 8px; background: #fd7e14; color: white; border-radius: 3px; font-size: 0.85em;">Weak (1.5-2.4)</span>
                                <span style="padding: 4px 8px; background: #ffc107; color: black; border-radius: 3px; font-size: 0.85em;">Moderate (2.5-3.4)</span>
                                <span style="padding: 4px 8px; background: #20c997; color: white; border-radius: 3px; font-size: 0.85em;">Good (3.5-4.4)</span>
                                <span style="padding: 4px 8px; background: #28a745; color: white; border-radius: 3px; font-size: 0.85em;">Excellent (4.5-5.0)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Section -->
                <div id="summary-section" class="analysis-section">
                    <h4><i class="fas fa-chart-pie"></i> Analysis Summary</h4>
                    <div id="summary-content" class="summary-content">
                        <!-- Summary statistics and charts will be populated here -->
                    </div>
                </div>

                <!-- Alignment Matrix Section -->
                <div id="matrix-section" class="analysis-section">
                    <h4><i class="fas fa-th"></i> Alignment Matrix</h4>
                    <div id="alignment-matrix-container" class="matrix-container">
                        <!-- Alignment matrix will be populated here -->
                    </div>
                </div>

                <!-- Detailed Breakdown Section -->
                <div id="detailed-breakdown-section" class="analysis-section">
                    <h4>
                        <i class="fas fa-list-alt"></i> Detailed Breakdown
                        <button class="methodology-trigger" onclick="scrollToMethodology()" title="View detailed scoring methodology" style="background: var(--tt-magenta); color: var(--tt-white); border: none; border-radius: 50%; width: 30px; height: 30px; margin-left: 10px; cursor: pointer; font-size: 14px; transition: all 0.3s ease;">
                            <i class="fas fa-info"></i>
                        </button>
                    </h4>
                    <button class="view-toggle" id="view-toggle-btn" style="background: linear-gradient(135deg, var(--tt-dark-blue), var(--tt-burgundy)); color: var(--tt-white); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin: 10px 0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.02em; transition: all 0.3s ease;">
                        <i class="fas fa-exchange-alt"></i> Switch to CLO View
                    </button>
                    <div id="breakdown-header" class="analysis-header"></div>
                    <div id="detailed-breakdown-content" class="detailed-content">
                        <!-- Detailed breakdown grouped by MLO/CLO will be populated here -->
                    </div>
                </div>
            </section>

            <!-- Loading Section -->
            <section id="loading-section" class="hidden">
                <div class="loading">
                    <div class="spinner"></div>
                    <h3 id="loading-title">Processing...</h3>
                    <p id="loading-message">Please wait while we process your request.</p>
                </div>
            </section>
        </main>

        <!-- Detail Modal -->
        <div id="detail-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modal-title">Alignment Details</h3>
                    <button class="close-modal modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="alignment-detail">
                        <h4>CLO:</h4>
                        <p id="modal-clo-text"></p>
                        <h4>MLO:</h4>
                        <p id="modal-mlo-text"></p>
                        
                        <div class="scoring-breakdown">
                            <h4>Scoring Breakdown</h4>
                            <div class="score-metrics">
                                <div>Overall: <span id="modal-overall-score"></span></div>
                                <div>Keywords: <span id="modal-keyword-score"></span></div>
                                <div>Semantic: <span id="modal-semantic-score"></span></div>
                                <div>Bloom's: <span id="modal-bloom-score"></span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Report Modal -->
    <div id="preview-report-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-pdf"></i> CLO-MLO Analysis Report Preview</h3>
                <button class="close-modal" id="close-preview-report">&times;</button>
            </div>
            <div class="modal-body">
                <div id="report-preview-content">
                    <!-- Report preview will be dynamically generated here -->
                </div>
                <div class="form-actions" style="margin-top:2rem;">
                    <button id="download-pdf-btn" class="btn btn-primary">
                        <i class="fas fa-file-pdf"></i> Download PDF
                    </button>
                    <button class="btn btn-secondary" id="close-preview-report-bottom">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/data-manager.js"></script>
    <script src="js/enhanced-alignment-engine.js"></script>
    <script src="js/alignment-engine.js"></script>
    <script src="js/shared-utils.js"></script>
    <script src="js/clo-mlo.js"></script>
    
    <script>
// Advanced improvement suggestion logic (ported from PLO-MLO)
function generateImprovementSuggestions(score, competencyMatches, keywordOverlap, cloText, mloText) {
    let suggestions = [];
    if (score < 2.0) {
        suggestions.push("Fundamental restructuring needed. Review CLO and MLO for clarity and direct mapping.");
        suggestions.push("Increase explicit connections between CLO and MLO using shared keywords.");
        suggestions.push("Revisit competency categories and ensure coverage of core skills.");
    } else if (score < 3.5) {
        if (keywordOverlap < 0.2) {
            suggestions.push("Increase keyword overlap by aligning terminology in CLO and MLO.");
        }
        if (!competencyMatches || competencyMatches.length < 3) {
            suggestions.push("Strengthen links to competency framework. Add more relevant categories.");
        }
        suggestions.push("Clarify cognitive level using Bloom's taxonomy verbs in CLO and MLO.");
        suggestions.push("Improve contextual relevance by using domain-specific vocabulary.");
    } else {
        suggestions.push("Minor improvements possible. Review for clarity and progression.");
    }
    if (suggestions.length > 0) {
        return `
            <div class=\"improvement-suggestions\">
                <strong><i class=\"fas fa-lightbulb\"></i> Improvement Suggestions:</strong>
                <ul style=\"margin: 5px 0 0 20px;\">
                    ${suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    return '';
}
        // Global state
        let currentBreakdownView = 'mlo'; // 'mlo' or 'clo'
        let currentAlignmentResults = null;
        let currentCLOs = [];
        let currentMLOs = [];

        // Initialize page and workflow enhancements
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                if (!window.dataManager) window.dataManager = new DataManager();
                // Instantiate CLOMLOController and assign to global variable
                if (!window.controller) window.controller = new CLOMLOController();
                let currentProgramme = window.dataManager.getCurrentProgramme();
                const urlParams = new URLSearchParams(window.location.search);
                const kavakood = urlParams.get('kavakood');
                if (!currentProgramme && kavakood) {
                    await window.dataManager.loadProgrammes();
                    currentProgramme = window.dataManager.setCurrentProgramme(kavakood);
                }
                if (currentProgramme) {
                    updatePageHeader(currentProgramme);
                    // Populate course dropdown when programme is available
                    populateCourseDropdown();
                } else {
                    // Even if no programme selected, try to populate dropdown with helpful message
                    populateCourseDropdown();
                }
                // Floating home button
                const homeBtnFloat = document.getElementById('home-btn-float');
                if (homeBtnFloat) homeBtnFloat.onclick = () => window.location.href = 'index.html';

                // Initialize course workflow
                initializeCourseWorkflow();
                
                // Initialize alignment engine using controller instance
                window.controller.initializeAlignmentEngine();
            } catch (error) {
                console.error('Page initialization error:', error);
            }
        });

        // Function to show the analysis button when user starts working with CLOs
        function showAnalysisButton() {
            // Only show if user is not in editing mode
            const editorSection = document.getElementById('clo-editor-section');
            const isEditing = editorSection && !editorSection.classList.contains('hidden');
            
            if (!isEditing) {
                const analysisBtn = document.getElementById('main-analysis-btn');
                const analysisContainer = document.getElementById('main-analysis-button-container');
                if (analysisBtn && analysisContainer) {
                    analysisContainer.style.display = 'flex';
                    analysisBtn.style.display = 'inline-flex';
                    console.log('Main analysis button shown - user can now analyze CLO-MLO alignment');
                }
            }
        }

        // TalTech Enhanced Analysis Function
        async function performAlignment() {
            // Hide CLO management section when analysis starts
            const cloManagementSection = document.getElementById('clo-management-section');
            if (cloManagementSection) {
                cloManagementSection.classList.add('hidden');
            }
            
            const aiButton = document.getElementById('ai-analysis-btn');
            const breakdownSection = document.getElementById('detailed-breakdown-section');
            const breakdownContent = document.getElementById('detailed-breakdown-content');
            
            // Get current programme and course data
            const currentProgramme = window.dataManager ? window.dataManager.getCurrentProgramme() : null;
            if (!currentProgramme) {
                alert('Please select a programme first.');
                return;
            }

            // Get selected course and MLOs/CLOs
            const selectedCourse = window.dataManager ? window.dataManager.getCurrentCourse() : null;
            if (!selectedCourse) {
                alert('Please select a course first.');
                return;
            }

            // Get CLOs from the form
            const cloInputs = document.querySelectorAll('.clo-textarea');
            if (cloInputs.length === 0) {
                alert('Please add some Course Learning Outcomes (CLOs) first.');
                return;
            }

            const clos = Array.from(cloInputs).map((textarea, index) => ({
                plokood: `CLO${index + 1}`, // Use PLO structure for compatibility
                plosisuik: textarea.value.trim()
            })).filter(clo => clo.plosisuik.length > 0);

            // DEBUG: Log CLO data extraction
            console.log('CLO Inputs found:', cloInputs.length);
            console.log('CLOs after processing:', clos);
            console.log('CLOs count:', clos.length);
            
            if (clos.length > 0) {
                console.log('Sample CLO structure:', clos[0]);
                console.log('CLO fields available:', Object.keys(clos[0]));
            }

            if (clos.length === 0) {
                alert('Please enter some Course Learning Outcomes (CLOs) first.');
                return;
            }

            // Get MLOs for the selected course
            const programmeMlos = currentProgramme.mlos || [];
            
            // DEBUG: Log MLO data extraction
            console.log('=== CLO-MLO ALIGNMENT DEBUG ===');
            console.log('Current Programme:', currentProgramme);
            console.log('Programme MLOs raw:', programmeMlos);
            console.log('MLOs count:', programmeMlos.length);
            
            if (programmeMlos.length > 0) {
                console.log('Sample MLO structure:', programmeMlos[0]);
                console.log('MLO fields available:', Object.keys(programmeMlos[0]));
            }
            
            if (!programmeMlos || programmeMlos.length === 0) {
                alert('No MLOs found for this programme.');
                return;
            }

                // Debug log to check if EnhancedAlignmentEngine exists
                if (typeof EnhancedAlignmentEngine === 'undefined') {
                    console.error('DEBUG: EnhancedAlignmentEngine does NOT exist in window context.');
                    alert('Enhanced alignment engine is not available. Please reload the page.');
                    return;
                } else {
                    console.log('DEBUG: EnhancedAlignmentEngine exists and is ready.');
                }

            // Disable button and show loading
            if (aiButton) {
                aiButton.disabled = true;
                aiButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            }
            
            if (breakdownContent) {
                breakdownContent.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> TalTech methodology analyzing CLO-MLO alignment... This may take a few seconds.</div>';
            }

            try {
                // Initialize enhanced alignment engine
                const alignmentEngine = new EnhancedAlignmentEngine();
                const alignmentResults = [];

                // Analyze each CLO-MLO pair using TalTech methodology
                console.log('Starting CLO-MLO analysis with Enhanced Alignment Engine...');
                
                clos.forEach(clo => {
                    programmeMlos.forEach(mlo => {
                        try {
                            // DEBUG: Log each pair being analyzed
                            console.log('--- Analyzing CLO-MLO Pair ---');
                            console.log('CLO:', {
                                code: clo.plokood,
                                text: clo.plosisuik,
                                fullObject: clo
                            });
                            console.log('MLO:', {
                                code: mlo.mlokood,
                                textIK: mlo.mlosisuik,
                                textEK: mlo.mlosisuek,
                                fullObject: mlo
                            });
                            
                            const analysisResult = alignmentEngine.analyzeAlignment(
                                clo, // CLO treated as PLO for compatibility
                                mlo, 
                                programmeMlos, 
                                { 
                                    programmeType: 'business',
                                    level: 'bachelor'
                                }
                            );
                            
                            // DEBUG: Log analysis result
                            console.log('Analysis Result:', {
                                score: analysisResult.score,
                                hasSemanticAnalysis: !!analysisResult.semanticAnalysis,
                                hasCompetencyAnalysis: !!analysisResult.competencyAnalysis,
                                hasBloomsAnalysis: !!analysisResult.bloomsAnalysis,
                                hasContextualAnalysis: !!analysisResult.contextualAnalysis,
                                hasProgressionAnalysis: !!analysisResult.progressionAnalysis,
                                fullResult: analysisResult
                            });
                            
                            alignmentResults.push(analysisResult);
                        } catch (error) {
                            console.error('Error processing CLO-MLO pair:', clo.plokood, mlo.mlokood, error);
                        }
                    });
                });

                // DEBUG: Final analysis summary
                console.log('=== ANALYSIS COMPLETE ===');
                console.log('Total alignment results:', alignmentResults.length);
                console.log('Score distribution:', alignmentResults.map(r => r.score));
                console.log('Average score:', alignmentResults.length > 0 ? 
                    (alignmentResults.reduce((sum, r) => sum + r.score, 0) / alignmentResults.length).toFixed(2) : 'N/A');
                console.log('Enhanced engine features detected:', {
                    hasSemanticAnalysis: alignmentResults.some(r => r.semanticAnalysis),
                    hasCompetencyAnalysis: alignmentResults.some(r => r.competencyAnalysis), 
                    hasBloomsAnalysis: alignmentResults.some(r => r.bloomsAnalysis),
                    hasContextualAnalysis: alignmentResults.some(r => r.contextualAnalysis),
                    hasProgressionAnalysis: alignmentResults.some(r => r.progressionAnalysis)
                });

                // DEBUG: Check justification structure
                if (alignmentResults.length > 0) {
                    console.log('Sample result structure:', alignmentResults[0]);
                    console.log('Sample justification:', alignmentResults[0].justification);
                    console.log('Justification type:', typeof alignmentResults[0].justification);
                    if (alignmentResults[0].justification && typeof alignmentResults[0].justification === 'object') {
                        console.log('Justification keys:', Object.keys(alignmentResults[0].justification));
                    }
                }

                // Use enhanced local analysis results for report generation
                // The report sections below (summary, matrix, breakdown) now use the advanced justification and scoring from JS

                // Show the main analysis results section
                const analysisResultsSection = document.getElementById('analysis-results-section');
                if (analysisResultsSection) {
                    analysisResultsSection.classList.remove('hidden');
                    console.log('Analysis results section shown');
                    
                    // Setup and show sticky navigation
                    setupStickyNavigation();
                    showAnalysisNavigation();
                }
                
                // Populate analysis sections
                populateAnalysisSummary(clos, programmeMlos, alignmentResults);
                populateAlignmentMatrix(clos, programmeMlos, alignmentResults);
                populateDetailedBreakdown(clos, programmeMlos, alignmentResults);
                
                // Analysis complete - data is now available in breakdown section
                console.log('TalTech Enhanced ILO Alignment Analysis Complete');
                console.log(`CLOs Analyzed: ${clos.length}, MLOs Referenced: ${programmeMlos.length}, Total Alignments: ${alignmentResults.length}`);

            } catch (error) {
                console.error('TalTech Enhanced Analysis error:', error);
                if (breakdownContent) {
                    breakdownContent.innerHTML = `
                        <div style="color: #dc3545; padding: 20px; border: 1px solid #dc3545; border-radius: 8px; background: #f8d7da;">
                            <h4><i class="fas fa-exclamation-triangle"></i> Analysis Error</h4>
                            <p><strong>Error:</strong> ${error.message}</p>
                            <p>Please check the enhanced alignment engine configuration and try again.</p>
                        </div>
                    `;
                }
            } finally {
                // Re-enable button
                if (aiButton) {
                    aiButton.disabled = false;
                    aiButton.innerHTML = '<i class="fas fa-robot"></i> TalTech Enhanced Analysis';
                }
            }
        }

        // Populate analysis summary section
        function populateAnalysisSummary(clos, mlos, alignmentResults) {
            const summaryContainer = document.getElementById('summary-content');
            if (!summaryContainer) return;

            const totalAlignments = alignmentResults.length;
            const averageScore = totalAlignments > 0 ? 
                (alignmentResults.reduce((sum, result) => sum + result.score, 0) / totalAlignments).toFixed(2) : '0.00';

            // Score distribution
            const scoreDistribution = {
                'Excellent (4.5-5.0)': alignmentResults.filter(r => r.score >= 4.5).length,
                'Good (3.5-4.4)': alignmentResults.filter(r => r.score >= 3.5 && r.score < 4.5).length,
                'Moderate (2.5-3.4)': alignmentResults.filter(r => r.score >= 2.5 && r.score < 3.5).length,
                'Weak (1.5-2.4)': alignmentResults.filter(r => r.score >= 1.5 && r.score < 2.5).length,
                'Poor (1.0-1.4)': alignmentResults.filter(r => r.score < 1.5).length
            };

            let summaryHTML = `
                <div class="summary-stats" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: #aa1352; margin: 0 0 15px 0;"><i class="fas fa-chart-line"></i> Analysis Summary</h4>
                    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="stat-item" style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                            <div style="font-size: 24px; font-weight: bold; color: #aa1352;">${clos.length}</div>
                            <div style="font-size: 14px; color: #666;">CLOs Analyzed</div>
                        </div>
                        <div class="stat-item" style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                            <div style="font-size: 24px; font-weight: bold; color: #aa1352;">${mlos.length}</div>
                            <div style="font-size: 14px; color: #666;">MLOs Referenced</div>
                        </div>
                        <div class="stat-item" style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                            <div style="font-size: 24px; font-weight: bold; color: #aa1352;">${totalAlignments}</div>
                            <div style="font-size: 14px; color: #666;">Total Alignments</div>
                        </div>
                        <div class="stat-item" style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                            <div style="font-size: 24px; font-weight: bold; color: #aa1352;">${averageScore}</div>
                            <div style="font-size: 14px; color: #666;">Average Score</div>
                        </div>
                    </div>
                    
                    <h5 style="color: #aa1352; margin: 20px 0 10px 0;">Score Distribution:</h5>
                    <div class="score-distribution">
            `;

            Object.entries(scoreDistribution).forEach(([label, count]) => {
                const percentage = totalAlignments > 0 ? ((count / totalAlignments) * 100).toFixed(1) : '0.0';
                summaryHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee;">
                        <span>${label}</span>
                        <span style="font-weight: bold;">${count} (${percentage}%)</span>
                    </div>
                `;
            });

            summaryHTML += `
                    </div>
                </div>
            `;

            summaryContainer.innerHTML = summaryHTML;
        }

        // Populate alignment matrix section
        function populateAlignmentMatrix(clos, mlos, alignmentResults) {
            const matrixContainer = document.getElementById('alignment-matrix-container');
            if (!matrixContainer) return;

            let matrixHTML = `
                <div class="matrix-table" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <thead>
                            <tr style="background: #aa1352; color: white;">
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">CLO</th>
            `;

            // Add MLO headers
            mlos.forEach(mlo => {
                matrixHTML += `<th style="padding: 12px; border: 1px solid #ddd; text-align: center; writing-mode: vertical-rl; text-orientation: mixed;">${mlo.mlokood}</th>`;
            });

            matrixHTML += `
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Add CLO rows with alignment scores and advanced tooltips
            clos.forEach(clo => {
                matrixHTML += `<tr>`;
                matrixHTML += `<td style="padding: 12px; border: 1px solid #ddd; font-weight: bold; background: #f8f9fa;">${clo.id || clo.plokood}</td>`;
                
                mlos.forEach(mlo => {
                    const alignment = alignmentResults.find(result => 
                        (result.clo?.id === clo.id || result.plo?.plokood === clo.plokood) && result.mlo.mlokood === mlo.mlokood
                    );
                    
                    if (alignment) {
                        const score = alignment.score;
                        const color = getScoreColor(score);
                        // Advanced tooltip with all fields
                        const tooltip = `Score: ${score}\nJustification: ${alignment.justification || ''}\nExplanation: ${alignment.explanation || ''}\nImprovements: ${(alignment.improvements || []).join(', ')}\nKeyword Overlap: ${alignment.keywordOverlap || ''}\nCompetency Tags: ${(alignment.competencyTags || []).join(', ')}\nCommon Words: ${(alignment.commonWords || []).join(', ')}\nBloom Levels: ${alignment.bloomLevels ? `CLO(${alignment.bloomLevels.clo}) ↔ MLO(${alignment.bloomLevels.mlo})` : ''}`;
                        matrixHTML += `
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center; background-color: ${color}; color: white; font-weight: bold; cursor: pointer;" 
                                title="${tooltip}">${score}</td>
                        `;
                    } else {
                        matrixHTML += `<td style="padding: 12px; border: 1px solid #ddd; text-align: center; background: #f8f9fa;">-</td>`;
                    }
                });
                
                matrixHTML += `</tr>`;
            });

            matrixHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            matrixContainer.innerHTML = matrixHTML;
        }

        // Populate detailed analysis section
        function populateDetailedAnalysis(clos, mlos, alignmentResults) {
            const detailedContainer = document.getElementById('detailed-analysis-content');
            if (!detailedContainer) return;

            let detailedHTML = '';

            mlos.forEach(mlo => {
                const mloAlignments = alignmentResults.filter(result => result.mlo.mlokood === mlo.mlokood);
                
                if (mloAlignments.length > 0) {
                    const avgScore = (mloAlignments.reduce((sum, alignment) => sum + alignment.score, 0) / mloAlignments.length).toFixed(2);
                    
                    detailedHTML += `
                        <div class="mlo-analysis" style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <h5 style="color: #aa1352; margin: 0 0 10px 0;">
                                <i class="fas fa-cube"></i> ${mlo.mlokood} 
                                <span style="font-size: 14px; color: #666; font-weight: normal;">(Avg: ${avgScore})</span>
                            </h5>
                            <p style="font-size: 14px; color: #666; margin: 0 0 15px 0; font-style: italic;">
                                ${mlo.mlosisuik || mlo.mlosisuek || 'No description available'}
                            </p>
                            
                            <div class="clo-alignments">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="padding: 8px; border: 1px solid #dee2e6; text-align: left;">CLO</th>
                                            <th style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">Score</th>
                                            <th style="padding: 8px; border: 1px solid #dee2e6; text-align: left;">TalTech Analysis Components</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                mloAlignments.forEach(alignment => {
                    const scoreClass = getScoreColor(alignment.score);
                    detailedHTML += `
                        <tr>
                            <td class="clo-code-cell">${alignment.clo?.id || alignment.plo?.plokood}</td>
                            <td class="alignment-score-cell">
                                <span class="alignment-score score-${scoreClass}" style="padding: 4px 8px; border-radius: 12px; font-weight: bold; color: #fff; background: ${getScoreColor(scoreClass)}; min-width: 40px; display: inline-block; text-align: center;">
                                    ${alignment.score}
                                </span>
                            </td>
                            <td class="justification-cell">
                                <div><strong>Justification:</strong> ${alignment.justification || '<em>No justification available</em>'}</div>
                                <div><strong>Explanation:</strong> ${alignment.explanation || '<em>No explanation available</em>'}</div>
                                <div><strong>Improvements:</strong> ${(alignment.improvements || []).length > 0 ? alignment.improvements.join('; ') : 'None'}</div>
                                <div><strong>Keyword Overlap:</strong> ${alignment.keywordOverlap !== undefined ? alignment.keywordOverlap + '%' : 'N/A'}</div>
                                <div><strong>Competency Tags:</strong> ${(alignment.competencyTags || []).length > 0 ? alignment.competencyTags.join(', ') : 'None'}</div>
                                <div><strong>Common Words:</strong> ${(alignment.commonWords || []).length > 0 ? alignment.commonWords.join(', ') : 'None'}</div>
                                <div><strong>Bloom's Levels:</strong> ${alignment.bloomLevels ? `CLO(${alignment.bloomLevels.clo}) ↔ MLO(${alignment.bloomLevels.mlo})` : 'N/A'}</div>
                                <div><strong>Highlighted CLO:</strong> ${alignment.highlightedCLO || alignment.clo?.text || 'N/A'}</div>
                                <div><strong>Highlighted MLO:</strong> ${alignment.highlightedMLO || alignment.mlo?.mlosisuik || alignment.mlo?.mlosisuek || 'N/A'}</div>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
        }

        // Generate enhanced analysis display from result
        function generateEnhancedAnalysisDisplay(result) {
            if (!result.justification || typeof result.justification !== 'object') {
                return 'Enhanced analysis data not available';
            }

            let html = '<div style="font-size: 0.9em;">';
            
            if (result.justification && typeof result.justification === 'object' && result.justification.components && Array.isArray(result.justification.components) && result.justification.components.length > 0) {
                html += '<div style="margin-bottom: 8px;"><strong>Analysis Components:</strong></div>';
                html += '<ul style="margin: 4px 0; padding-left: 16px; font-size: 0.85em;">';
                result.justification.components.forEach(comp => {
                    html += `<li style="margin-bottom: 3px;">${comp}</li>`;
                });
                html += '</ul>';
            }

            if (result.justification && result.justification.calculation) {
                html += `
                    <div style="margin-top: 8px; font-size: 0.8em; color: #555; font-family: monospace; background: #f8f9fa; padding: 6px; border-radius: 4px;">
                        <strong>Calculation:</strong> ${result.justification.calculation}
                    </div>
                `;
            }

            if (result.justification && result.justification.suggestions && Array.isArray(result.justification.suggestions) && result.justification.suggestions.length > 0) {
                html += `
                    <div style="margin-top: 10px; padding: 8px; background-color: #e8f4fd; border-left: 3px solid #007bff; font-size: 0.8em;">
                        <strong style="color: #0056b3;">💡 Improvement Suggestions:</strong>
                        <ul style="margin: 4px 0; padding-left: 16px;">
                            ${result.justification.suggestions.map(sugg => `<li style="margin-bottom: 4px;">${sugg}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        // Helper function to highlight keywords (reuse from PLO-MLO)
        function highlightKeywords(text, keywords) {
            if (!keywords || keywords.length === 0) {
                return text;
            }
            
            const stopWords = new Set([
                'the', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'as', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'can', 'must', 'shall',
                'a', 'an', 'some', 'any', 'many', 'much', 'more', 'most', 'all', 'each', 'every', 'other', 'another', 'such', 'same', 'different'
            ]);
            
            let highlightedText = text;
            const meaningfulKeywords = keywords.filter(keyword => 
                keyword && keyword.length > 2 && !stopWords.has(keyword.toLowerCase())
            );
            
            meaningfulKeywords.forEach(keyword => {
                const regex = new RegExp(`\\b${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
                highlightedText = highlightedText.replace(regex, `<mark class="keyword-highlight" style="background: #ffeb3b; padding: 1px 2px; border-radius: 2px;">$&</mark>`);
            });
            
            return highlightedText;
        }

        // Helper functions for scoring
        function getScoreClass(score) {
            if (score >= 4.5) return 'excellent';
            if (score >= 3.5) return 'good';
            if (score >= 2.5) return 'moderate';
            if (score >= 1.5) return 'weak';
            return 'poor';
        }

        function getScoreColor(scoreClass) {
            const colors = {
                'excellent': '#28a745',
                'good': '#20c997',
                'moderate': '#ffc107',
                'weak': '#fd7e14',
                'poor': '#dc3545'
            };
            return colors[scoreClass] || '#6c757d';
        }

        // Check for existing CLOs and display them with analysis button
        function checkAndDisplayExistingCLOs() {
            const existingCLOsContainer = document.getElementById('info-existing-clos');
            const analysisButtonContainer = document.getElementById('main-analysis-button-container');
            
            if (!existingCLOsContainer || !analysisButtonContainer) {
                console.error('Required elements not found');
                return;
            }

            // Get saved CLOs, always as array
            let savedCLOs = window.controller.getSavedCLOs();
            if (!Array.isArray(savedCLOs)) {
                if (savedCLOs == null) {
                    savedCLOs = [];
                } else if (typeof savedCLOs === 'object') {
                    savedCLOs = Object.values(savedCLOs);
                } else {
                    savedCLOs = [];
                }
            }
            const selectedCourse = window.dataManager ? window.dataManager.getCurrentCourse() : null;
            
            console.log('Checking and displaying existing CLOs for course:', selectedCourse?.ainekood);
            console.log('Found CLOs:', savedCLOs);
            
            if (savedCLOs.length > 0) {
                // Display saved CLOs
                let cloHTML = '<div class="saved-clos-display">';
                
                // Determine CLO source type
                const cloSource = savedCLOs[0].language ? 'course data' : savedCLOs[0].text ? 'saved data' : 'form inputs';
                const sourceIcon = cloSource === 'course data' ? 'fas fa-database' : 'fas fa-check-circle';
                
                cloHTML += `<h4 style="color: #aa1352; margin-bottom: 10px;"><i class="${sourceIcon}"></i> Course Learning Outcomes (from ${cloSource})</h4>`;
                
                savedCLOs.forEach((clo, index) => {
                    const cloText = clo.text || clo.description || clo;
                    const cloCode = clo.code || `CLO${index + 1}`;
                    cloHTML += `
                        <div class="saved-clo-item" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: #aa1352; margin-bottom: 4px;">${cloCode.toUpperCase()}</div>
                            <div style="font-size: 0.95em; line-height: 1.4;">${cloText}</div>
                        </div>
                    `;
                });
                
                cloHTML += '</div>';
                existingCLOsContainer.innerHTML = cloHTML;
                
                // Show analysis button
                analysisButtonContainer.style.display = 'flex';
                
                console.log(`Found ${savedCLOs.length} CLOs from ${cloSource}, analysis button displayed`);
            } else {
                // No CLOs found - provide helpful guidance
                const courseCode = selectedCourse?.ainekood || 'this course';
                existingCLOsContainer.innerHTML = `
                    <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 15px; text-align: center;">
                        <i class="fas fa-info-circle" style="color: #6c757d; font-size: 24px; margin-bottom: 10px;"></i>
                        <p style="margin: 0; color: #666; font-style: italic;">
                            No Course Learning Outcomes (CLOs) found for <strong>${courseCode}</strong>.
                        </p>
                        <p style="margin: 10px 0 0 0; color: #666; font-size: 0.9em;">
                            Use <strong>CLO Management</strong> below to add or edit Course Learning Outcomes.
                        </p>
                    </div>
                `;
                
                // Hide analysis button
                analysisButtonContainer.style.display = 'none';
                console.log('No CLOs found for course:', courseCode);
            }
        }

        // Populate course dropdown with courses from current programme
        function populateCourseDropdown() {
            const courseSelector = document.getElementById('course-selector');
            if (!courseSelector) return;

            const currentProgramme = window.dataManager ? window.dataManager.getCurrentProgramme() : null;
            if (!currentProgramme) {
                courseSelector.innerHTML = '<option value="">Please visit index.html to select a programme first...</option>';
                console.log('No programme selected - user needs to start from index.html');
                return;
            }

            const courses = window.dataManager.getCurrentCourses();
            console.log('Populating course dropdown with', courses.length, 'courses for programme', currentProgramme.code);

            // Clear existing options except the default
            courseSelector.innerHTML = '<option value="">Choose a course...</option>';

            if (courses && courses.length > 0) {
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.ainekood;
                    option.textContent = `${course.ainekood} - ${course.ainenimetusik}`;
                    courseSelector.appendChild(option);
                });
                console.log(`Successfully populated course dropdown with ${courses.length} courses`);
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = `Loading courses for ${currentProgramme.code}...`;
                option.disabled = true;
                courseSelector.appendChild(option);
                
                // Try to reload data if courses are empty
                setTimeout(async () => {
                    try {
                        await window.dataManager.loadProgrammes();
                        const retryProgramme = window.dataManager.setCurrentProgramme(currentProgramme.code);
                        if (retryProgramme) {
                            populateCourseDropdown(); // Retry populating
                        }
                    } catch (error) {
                        console.error('Failed to reload programme data:', error);
                        courseSelector.innerHTML = '<option value="">Error loading courses - please refresh page</option>';
                    }
                }, 1000);
            }
        }

        // Display course information in the course details section
        function displayCourseInformation() {
            const selectedCourse = window.dataManager ? window.dataManager.getCurrentCourse() : null;
            if (!selectedCourse) {
                console.log('No course selected for display');
                return;
            }

            console.log('Displaying course information for:', selectedCourse.ainekood);

            // Populate course details
            document.getElementById('info-course-code').textContent = selectedCourse.ainekood || '-';
            document.getElementById('info-course-name-en').textContent = selectedCourse.ainenimetusik || '-';
            document.getElementById('info-course-name-et').textContent = selectedCourse.ainenimetusek || '-';
            document.getElementById('info-course-eap').textContent = selectedCourse.eap || '-';
            document.getElementById('info-course-modules').textContent = selectedCourse.moodulikood || '-';
            document.getElementById('info-course-assessment').textContent = selectedCourse.kontrollivorm || '-';
            document.getElementById('info-course-type').textContent = selectedCourse.KV || '-';
            
            // Course URL
            const urlLink = document.getElementById('info-course-url');
            if (selectedCourse.aineurl) {
                urlLink.href = selectedCourse.aineurl;
                urlLink.style.display = 'inline';
            } else {
                urlLink.style.display = 'none';
            }

            // Course aims
            const aimsContent = document.getElementById('info-course-aims');
            const aims = selectedCourse.eesmarkik || selectedCourse.eesmarkek || 'No course aims available.';
            aimsContent.innerHTML = aims.replace(/\n/g, '<br>');
        }

        // Display module content (MLOs) for the selected course
        function displayModuleContent() {
            const selectedCourse = window.dataManager ? window.dataManager.getCurrentCourse() : null;
            const currentProgramme = window.dataManager ? window.dataManager.getCurrentProgramme() : null;
            
            if (!selectedCourse || !currentProgramme) {
                console.log('Cannot display module content - missing course or programme');
                return;
            }

            const moduleList = document.getElementById('module-content-list');
            if (!moduleList) return;

            // Find MLOs for this course's module
            const moduleCode = selectedCourse.moodulikood;
            const programmeMlos = currentProgramme.mlos || [];
            const relatedMLOs = programmeMlos.filter(mlo => mlo.mlokood.startsWith(moduleCode));

            console.log(`Found ${relatedMLOs.length} MLOs for module ${moduleCode}`);

            if (relatedMLOs.length > 0) {
                moduleList.innerHTML = relatedMLOs.map(mlo => 
                    `<div class="mlo-item" style="margin-bottom: 10px; padding: 10px; border-left: 3px solid #aa1352; background: #f8f9fa;">
                        <strong style="color: #aa1352;">[${mlo.mlokood}]</strong> 
                        ${mlo.mlosisuik || mlo.mlosisuek || 'No MLO content available'}
                    </div>`
                ).join('');
            } else {
                moduleList.innerHTML = '<em style="color: #666;">No module learning outcomes found for this course.</em>';
            }
        }

        // CLO Editor Functions
        function showCLOEditor(mode) {
            const editorSection = document.getElementById('clo-editor-section');
            const cloManagementSection = document.getElementById('clo-management-section');
            const editorTitle = document.getElementById('clo-editor-title');
            const editorContainer = document.getElementById('clo-editor-container');

            if (!editorSection || !cloManagementSection || !editorTitle || !editorContainer) {
                console.error('Required CLO editor elements not found');
                return;
            }

            // Hide analysis button while editing
            const analysisBtn = document.getElementById('main-analysis-btn');
            const analysisContainer = document.getElementById('main-analysis-button-container');
            if (analysisBtn && analysisContainer) {
                analysisContainer.style.display = 'none';
                analysisBtn.style.display = 'none';
            }

            // Hide management section and show editor
            cloManagementSection.classList.add('hidden');
            editorSection.classList.remove('hidden');

            // Hide existing CLOs display section while editing
            const existingCLOsSection = document.getElementById('existing-clos-section');
            if (existingCLOsSection) existingCLOsSection.classList.add('hidden');

            // Set title based on mode
            if (mode === 'edit') {
                editorTitle.textContent = 'Edit Existing CLOs';
                // Always call populateCLOEditorWithExisting, which calls getSavedCLOs directly
                populateCLOEditorWithExisting();
            } else if (mode === 'manual') {
                editorTitle.textContent = 'Manual CLO Entry';
                populateCLOEditorEmpty();
            }

            console.log('CLO editor shown in mode:', mode);
        }

        function hideCLOEditor() {
            const editorSection = document.getElementById('clo-editor-section');
            const cloManagementSection = document.getElementById('clo-management-section');
            const existingCLOsSection = document.getElementById('existing-clos-section');

            if (editorSection) editorSection.classList.add('hidden');
            if (cloManagementSection) cloManagementSection.classList.remove('hidden');
            // Show existing CLOs display section when editor is hidden
            if (existingCLOsSection) existingCLOsSection.classList.remove('hidden');

            console.log('CLO editor hidden');
        }

        function populateCLOEditorWithExisting() {
            let existingCLOs = window.controller.getSavedCLOs();
            if (!Array.isArray(existingCLOs)) {
                if (existingCLOs == null) {
                    existingCLOs = [];
                } else if (typeof existingCLOs === 'object') {
                    existingCLOs = Object.values(existingCLOs);
                } else {
                    existingCLOs = [];
                }
            }
            const editorContainer = document.getElementById('clo-editor-container');

            if (!editorContainer) return;

            editorContainer.innerHTML = '';

            if (existingCLOs.length > 0) {
                existingCLOs.forEach((clo, index) => {
                    let cloText = '';
                    if (typeof clo === 'string') {
                        cloText = clo;
                    } else if (clo && typeof clo === 'object') {
                        cloText = clo.text || clo.description || clo.plosisuik || clo.plosisu || '';
                    }
                    addCLOFieldToEditor(cloText, index + 1);
                });
            } else {
                // If no existing CLOs, add some empty fields
                for (let i = 1; i <= 4; i++) {
                    addCLOFieldToEditor('', i);
                }
            }

            console.log('CLO editor populated with existing CLOs:', existingCLOs.length);
        }

        function populateCLOEditorEmpty() {
            const editorContainer = document.getElementById('clo-editor-container');

            if (!editorContainer) return;

            editorContainer.innerHTML = '';

            // Add 4 empty CLO fields for manual entry
            for (let i = 1; i <= 4; i++) {
                addCLOFieldToEditor('', i);
            }

            console.log('CLO editor populated with empty fields');
        }

        function addCLOFieldToEditor(text = '', number = null) {
            const editorContainer = document.getElementById('clo-editor-container');
            if (!editorContainer) return;

            const cloNumber = number || editorContainer.children.length + 1;
            
            const cloField = document.createElement('div');
            cloField.className = 'clo-field';
            cloField.style.cssText = 'margin-bottom: 15px; border: 1px solid #dee2e6; border-radius: 6px; padding: 15px; background: #f8f9fa;';

            cloField.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label style="font-weight: 600; color: #aa1352; margin: 0;">CLO${cloNumber}</label>
                    <button type="button" class="remove-clo-btn" onclick="removeCLOField(this)" 
                            style="background: #dc3545; color: white; border: none; border-radius: 3px; padding: 5px 8px; font-size: 12px; cursor: pointer;">
                        <i class="fas fa-times"></i> Remove
                    </button>
                </div>
                <textarea class="clo-textarea" rows="3" placeholder="Enter course learning outcome..." 
                          style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; resize: vertical; font-family: inherit;">${text}</textarea>
            `;

            editorContainer.appendChild(cloField);
        }

        function removeCLOField(button) {
            const cloField = button.closest('.clo-field');
            if (cloField) {
                cloField.remove();
                renumberCLOFields();
            }
        }

        function renumberCLOFields() {
            const cloFields = document.querySelectorAll('.clo-field');
            cloFields.forEach((field, index) => {
                const label = field.querySelector('label');
                if (label) {
                    label.textContent = `CLO${index + 1}`;
                }
            });
        }

        function addNewCLOField() {
            addCLOFieldToEditor();
            console.log('New CLO field added');
        }

        function saveCLOs() {
            const currentProgramme = window.dataManager ? window.dataManager.getCurrentProgramme() : null;
            const selectedCourse = window.dataManager ? window.dataManager.getCurrentCourse() : null;

            if (!currentProgramme || !selectedCourse) {
                alert('Please select a programme and course first.');
                return;
            }

            const cloTextareas = document.querySelectorAll('.clo-textarea');
            const clos = [];

            cloTextareas.forEach((textarea, index) => {
                const text = textarea.value.trim();
                if (text) {
                    clos.push({
                        text: text,
                        code: `CLO${index + 1}`,
                        created: new Date().toISOString()
                    });
                }
            });

            if (clos.length === 0) {
                alert('Please enter at least one Course Learning Outcome.');
                return;
            }

            // Save to localStorage
            const storageKey = `clos_${currentProgramme.code}_${selectedCourse.code}`;
            localStorage.setItem(storageKey, JSON.stringify(clos));

            console.log('CLOs saved:', clos.length);
            
            // Hide editor and refresh existing CLOs display
            hideCLOEditor();
            checkAndDisplayExistingCLOs();
            
            // Show analysis button now that CLOs are saved
            showAnalysisButton();
        }

        // Initialize course workflow functionality
        function initializeCourseWorkflow() {
            try {
                const moduleSection = document.getElementById('module-content-section');
                const existingCLOsSection = document.getElementById('existing-clos-section');
                const cloSection = document.getElementById('clo-management-section');
                const newCourseBtnContainer = document.getElementById('new-course-btn-container');
                const newCourseBtn = document.getElementById('new-course-btn');
                const courseSelector = document.getElementById('course-selector');
                const courseSection = document.getElementById('course-selection-section');
                const infoSection = document.getElementById('course-information-section');
                
                if (courseSelector) {
                    courseSelector.addEventListener('change', function() {
                        if (this.value) {
                            // Set current course in DataManager
                            if (window.dataManager) {
                                window.dataManager.setCurrentCourse(this.value);
                                console.log('Selected course:', this.value);
                            }
                            
                            courseSection.style.display = 'none';
                            infoSection.classList.remove('hidden');
                            moduleSection.classList.remove('hidden');
                            existingCLOsSection.classList.remove('hidden');
                            cloSection.classList.remove('hidden');
                            newCourseBtnContainer.style.display = 'flex';
                            
                            // Display course information
                            displayCourseInformation();
                            
                            // Display module content  
                            displayModuleContent();
                            
                            // Check for existing CLOs and show analysis button if available
                            checkAndDisplayExistingCLOs();
                        } else {
                            // Clear current course in DataManager
                            if (window.dataManager) {
                                window.dataManager.clearCurrentCourse();
                            }
                            
                            courseSection.style.display = '';
                            infoSection.classList.add('hidden');
                            moduleSection.classList.add('hidden');
                            existingCLOsSection.classList.add('hidden');
                            cloSection.classList.add('hidden');
                            newCourseBtnContainer.style.display = 'none';
                            
                            // Hide analysis button
                            const analysisButtonContainer = document.getElementById('main-analysis-button-container');
                            if (analysisButtonContainer) {
                                analysisButtonContainer.style.display = 'none';
                            }
                        }
                    });
                }

                if (newCourseBtn) {
                    newCourseBtn.addEventListener('click', function() {
                        courseSection.style.display = '';
                        infoSection.classList.add('hidden');
                        moduleSection.classList.add('hidden');
                        existingCLOsSection.classList.add('hidden');
                        cloSection.classList.add('hidden');
                        newCourseBtnContainer.style.display = 'none';
                        
                        // Hide analysis button
                        const analysisButtonContainer = document.getElementById('main-analysis-button-container');
                        if (analysisButtonContainer) {
                            analysisButtonContainer.style.display = 'none';
                        }
                    });
                }

                // Add event listeners for CLO management buttons
                const editExistingCLOsBtn = document.getElementById('edit-existing-clos');
                const manualEntryCLOsBtn = document.getElementById('manual-entry-clos');

                if (editExistingCLOsBtn) {
                    editExistingCLOsBtn.addEventListener('click', function() {
                        console.log('Edit existing CLOs clicked');
                        if (window.controller && typeof window.controller.showEditCLOsInline === 'function') {
                            window.controller.showEditCLOsInline();
                        } else {
                            // fallback to old workflow if controller not available
                            checkAndDisplayExistingCLOs();
                            showCLOEditor('edit');
                        }
                    });
                }

                if (manualEntryCLOsBtn) {
                    manualEntryCLOsBtn.addEventListener('click', function() {
                        console.log('Manual entry CLOs clicked');
                        showCLOEditor('manual');
                    });
                }

                // Add event listeners for CLO editor buttons
                const saveCLOsBtn = document.getElementById('save-clos-btn');
                const cancelEditBtn = document.getElementById('cancel-edit-btn');

                if (saveCLOsBtn) {
                    saveCLOsBtn.addEventListener('click', function() {
                        console.log('Save CLOs clicked');
                        saveCLOs();
                    });
                }

                if (cancelEditBtn) {
                    cancelEditBtn.addEventListener('click', function() {
                        console.log('Cancel edit clicked');
                        hideCLOEditor();
                    });
                }

                // Add event listener for back to CLO management button
                const backToCLOManagementBtn = document.getElementById('back-to-clo-management');
                if (backToCLOManagementBtn) {
                    backToCLOManagementBtn.addEventListener('click', function() {
                        console.log('Back to CLO management clicked');
                        // Hide analysis results section
                        const analysisResultsSection = document.getElementById('analysis-results-section');
                        if (analysisResultsSection) {
                            analysisResultsSection.classList.add('hidden');
                        }
                        
                        // Hide analysis navigation
                        const analysisNav = document.getElementById('analysis-nav');
                        if (analysisNav) {
                            analysisNav.style.display = 'none';
                        }
                        
                        // Show CLO management section
                        const cloManagementSection = document.getElementById('clo-management-section');
                        if (cloManagementSection) {
                            cloManagementSection.classList.remove('hidden');
                        }
                    });
                }

                // Add event listener for view toggle button
                const viewToggleBtn = document.getElementById('view-toggle-btn');
                if (viewToggleBtn) {
                    viewToggleBtn.addEventListener('click', function() {
                        // Toggle view
                        currentBreakdownView = currentBreakdownView === 'mlo' ? 'clo' : 'mlo';
                        
                        // Update button text
                        this.innerHTML = currentBreakdownView === 'mlo' ? 
                            '<i class="fas fa-exchange-alt"></i> Switch to CLO View' : 
                            '<i class="fas fa-exchange-alt"></i> Switch to MLO View';
                        
                        // Re-render breakdown
                        renderDetailedBreakdown();
                    });
                }

            } catch (error) {
                console.error('Error initializing CLO-MLO course workflow:', error);
            }
        }

        // Course workflow functionality
        // (Integrated into main DOMContentLoaded listener via initializeCourseWorkflow())

        // Module content caret toggle
        function toggleModuleContent() {
            const caret = document.getElementById('module-caret');
            const list = document.getElementById('module-content-list');
            if (list.style.display === 'none') {
                list.style.display = 'block';
                caret.className = 'fas fa-chevron-down';
            } else {
                list.style.display = 'none';
                caret.className = 'fas fa-chevron-right';
            }
        }

        // Scroll to methodology section
        function scrollToMethodology() {
            const methodologySection = document.getElementById('methodology-info');
            if (methodologySection) {
                methodologySection.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        function updatePageHeader(programme) {
            // Update page title with programme info
            const pageTitle = document.getElementById('page-title');
            const programmeName = document.getElementById('current-programme-name');
            
            if (pageTitle && programme) {
                pageTitle.innerHTML = `<i class="fas fa-clipboard-list"></i> ${programme.code.toUpperCase()} ${programme.kavanimetusik} - CLO-MLO Alignment`;
            }
            
            if (programmeName && programme) {
                programmeName.textContent = `${programme.code.toUpperCase()} - ${programme.kavanimetusik}`;
            }
        }
    </script>